<!doctype html>
<html lang="zh-CN">
<head>

    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    

    <title>Golang|map | weiweng的博客</title>
    <meta property="og:title" content="Golang|map - weiweng的博客">
    <meta property="og:type" content="article">
        
    <meta property="article:published_time" content='2020-03-13T06:38:00&#43;08:00'>
        
        
    <meta property="article:modified_time" content='2020-03-13T06:38:00&#43;08:00'>
        
    <meta name="Keywords" content="golang,go语言,go语言笔记,博客,项目管理,软件架构">
    <meta name="description" content="Golang|map">
        
    <meta name="author" content="weiweng">
    <meta property="og:url" content="https://weiweng.github.io/blog/post/2020-03-13-map/">
    <link rel="shortcut icon" href='/blog/favicon.ico'  type="image/x-icon">

    <link rel="stylesheet" href='/blog/css/normalize.css'>
    <link rel="stylesheet" href='/blog/css/style.css'>
    <script type="text/javascript" src="//cdn.bootcdn.net/ajax/libs/jquery/3.4.1/jquery.min.js"></script>

    
    
    
    
    
    
</head>

<body>
    <header id="header" class="clearfix">
    <div class="container">
        <div class="col-group">
            <div class="site-name ">
                
                    <a id="logo" href="https://weiweng.github.io/blog/">
                        weiweng的博客
                    </a>
                
                <p class="description">记录所学所思所想，专注于Go语言、软件架构</p>
            </div>
            <div>
                <nav id="nav-menu" class="clearfix">
                    <a class="current" href="https://weiweng.github.io/blog/">首页</a>
                    
                    <a  href="https://weiweng.github.io/blog/tools/" title="工具">工具</a>
                    
                    <a  href="https://weiweng.github.io/blog/read/" title="阅读">阅读</a>
                    
                    <a  href="https://weiweng.github.io/blog/about/" title="关于">关于</a>
                    
                    <a  href="https://weiweng.github.io/blog/archives/" title="归档">归档</a>
                    
                </nav>
            </div>
        </div>
    </div>
</header>

    <div id="body">
        <div class="container">
            <div class="col-group">

                <div class="col-8" id="main">
                    
<div class="res-cons">
    
    <article class="post">
        <header>
            <h1 class="post-title">Golang|map</h1>
        </header>
        
  <time datetime="2020-03-12T22:38:00Z" class="post-meta meta-date dt-published">
    2020年3月13日
  </time>


<div class="post-meta meta-category">
  <span>&nbsp;|</span>
  
    <a href='/blog/categories/Golang' target="_blank">Golang</a>
  
</div>


        
        
        <div class="post-content">
            <h3 id="map">map</h3>
<p>由&lt;key,value&gt;对组成的抽象数据结构，并且同一个key只出现一次</p>
<h3 id="实现对比">实现对比</h3>
<p>方法 | hash | 搜索树 -|-|- 复杂度 | O(1) | O(logN) 顺序 | 乱序 | 有序 痛点 | 碰撞问题 | 平衡问题</p>
<h3 id="源码位置">源码位置</h3>
<div class="highlight"><div style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">7
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#998;font-style:italic">//main.go
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"></span><span style="color:#000;font-weight:bold">package</span> main
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">func</span> <span style="color:#900;font-weight:bold">main</span>() {
</span></span><span style="display:flex;"><span>	m <span style="color:#000;font-weight:bold">:=</span> <span style="color:#0086b3">make</span>(<span style="color:#000;font-weight:bold">map</span>[<span style="color:#458;font-weight:bold">int</span>]<span style="color:#458;font-weight:bold">int</span>)
</span></span><span style="display:flex;"><span>	m[<span style="color:#099">2</span>] = <span style="color:#099">2</span>
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></td></tr></table>
</div>
</div><p>上面代码通过以下指令查看汇编语句 <code>go tool compile -S main.go</code></p>
<p>map源码位置 src/runtime/hashmap.go (go1.9.2版本)</p>
<h3 id="源码分析">源码分析</h3>
<h4 id="数据结构">数据结构</h4>
<div class="highlight"><div style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">16
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">17
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">18
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">19
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">20
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">21
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">22
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">23
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">24
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">25
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">26
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">27
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">28
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">29
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">30
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">31
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">32
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">33
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">34
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">35
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">36
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">37
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">38
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">39
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">40
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">41
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">42
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">43
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">44
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">45
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">46
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">47
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">48
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">49
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#000;font-weight:bold">type</span> hmap <span style="color:#000;font-weight:bold">struct</span> {
</span></span><span style="display:flex;"><span>	<span style="color:#998;font-style:italic">//计数,map包含key个数
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"></span>	count <span style="color:#458;font-weight:bold">int</span>
</span></span><span style="display:flex;"><span>	<span style="color:#998;font-style:italic">//标志位,包含是否写、是否遍历，老迭代器还是新迭代器遍历以及是否同大小增长
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"></span>	flags <span style="color:#458;font-weight:bold">uint8</span>
</span></span><span style="display:flex;"><span>	<span style="color:#998;font-style:italic">//map里桶的个数的指数
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"></span>	B <span style="color:#458;font-weight:bold">uint8</span>
</span></span><span style="display:flex;"><span>	<span style="color:#998;font-style:italic">//溢出桶的个数(数值过大是会随机计数大致统计)
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"></span>	noverflow <span style="color:#458;font-weight:bold">uint16</span>
</span></span><span style="display:flex;"><span>	<span style="color:#998;font-style:italic">//key的hash种子
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"></span>	hash0 <span style="color:#458;font-weight:bold">uint32</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#998;font-style:italic">//指向当前桶数组的指针
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"></span>	buckets unsafe.Pointer
</span></span><span style="display:flex;"><span>	<span style="color:#998;font-style:italic">//指向老桶数组的指针
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"></span>	oldbuckets unsafe.Pointer
</span></span><span style="display:flex;"><span>	<span style="color:#998;font-style:italic">//已迁移的地址，改地址以前的桶都已经迁移(扩容相关)
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"></span>	nevacuate <span style="color:#458;font-weight:bold">uintptr</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#998;font-style:italic">//特殊用途
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"></span>	extra <span style="color:#000;font-weight:bold">*</span>mapextra
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic">//当map的键和值都不是指针并且类型为内置类型时，会将桶标记为不包含指针类型，从而减少GC扫描
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic">//但是桶的结构体中包含overflow指针，因此上述map会将桶的overflow指针放在如下结构体中
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"></span><span style="color:#000;font-weight:bold">type</span> mapextra <span style="color:#000;font-weight:bold">struct</span> {
</span></span><span style="display:flex;"><span>	<span style="color:#998;font-style:italic">//大小为2的数组，值为指向数组的指针
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"></span>	<span style="color:#998;font-style:italic">//0号指向当前桶数组的地址
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"></span>	<span style="color:#998;font-style:italic">//1号指向老桶数组的地址
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"></span>	overflow [<span style="color:#099">2</span>]<span style="color:#000;font-weight:bold">*</span>[]<span style="color:#000;font-weight:bold">*</span>bmap
</span></span><span style="display:flex;"><span>	<span style="color:#998;font-style:italic">//指向预分配的桶的地址，具体功用还未理解，带填坑
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"></span>	nextOverflow <span style="color:#000;font-weight:bold">*</span>bmap
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic">//具体桶的结构体
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"></span><span style="color:#000;font-weight:bold">type</span> bmap <span style="color:#000;font-weight:bold">struct</span> {
</span></span><span style="display:flex;"><span>	<span style="color:#998;font-style:italic">//大小为8的数组，作用是快速索引key以及记录迁移状态
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"></span>	topbits [<span style="color:#099">8</span>]<span style="color:#458;font-weight:bold">uint8</span>
</span></span><span style="display:flex;"><span>	<span style="color:#998;font-style:italic">//键值存储位置
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"></span>	keys   [<span style="color:#099">8</span>]keytype
</span></span><span style="display:flex;"><span>	values [<span style="color:#099">8</span>]valuetype
</span></span><span style="display:flex;"><span>	<span style="color:#998;font-style:italic">//对其字节
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"></span>	pad <span style="color:#458;font-weight:bold">uintptr</span>
</span></span><span style="display:flex;"><span>	<span style="color:#998;font-style:italic">//溢出桶指针
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"></span>	overflow <span style="color:#458;font-weight:bold">uintptr</span>
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic">//bmap的key和value都是大小为8的数组，并且先key后value的排列
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic">//目的是减少因为字节对齐产生的pad
</span></span></span></code></pre></td></tr></table>
</div>
</div><p>
        <img class="mx-auto" alt="hmap结构体示例图" src="img_0.png" />   
    </p>
<h4 id="map创建">map创建</h4>
<div class="highlight"><div style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">16
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">17
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">18
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">19
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">20
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">21
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">22
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">23
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">24
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">25
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">26
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">27
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">28
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">29
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">30
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">31
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">32
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">33
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">34
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">35
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#000;font-weight:bold">func</span> <span style="color:#900;font-weight:bold">makemap</span>(t <span style="color:#000;font-weight:bold">*</span>maptype, hint <span style="color:#458;font-weight:bold">int64</span>, h <span style="color:#000;font-weight:bold">*</span>hmap, bucket unsafe.Pointer) <span style="color:#000;font-weight:bold">*</span>hmap {
</span></span><span style="display:flex;"><span>	<span style="color:#998;font-style:italic">//key的合法判断、大小判断、设定的常量判断等操作
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"></span>	<span style="color:#000;font-weight:bold">...</span>
</span></span><span style="display:flex;"><span>	<span style="color:#998;font-style:italic">// B初始值为0 
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"></span>	B <span style="color:#000;font-weight:bold">:=</span> <span style="color:#0086b3">uint8</span>(<span style="color:#099">0</span>)
</span></span><span style="display:flex;"><span>	<span style="color:#998;font-style:italic">//hint大于8并且hint/2^B超过转载因子则增加B
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"></span>	<span style="color:#000;font-weight:bold">for</span> ; <span style="color:#900;font-weight:bold">overLoadFactor</span>(hint, B); B<span style="color:#000;font-weight:bold">++</span> { } <span style="color:#998;font-style:italic">//桶地址赋值，如果B=0，则会在mapassign阶段分配一个桶
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"></span>	buckets <span style="color:#000;font-weight:bold">:=</span> bucket
</span></span><span style="display:flex;"><span>	<span style="color:#000;font-weight:bold">var</span> extra <span style="color:#000;font-weight:bold">*</span>mapextra
</span></span><span style="display:flex;"><span>	<span style="color:#000;font-weight:bold">if</span> B <span style="color:#000;font-weight:bold">!=</span> <span style="color:#099">0</span> {
</span></span><span style="display:flex;"><span>		<span style="color:#000;font-weight:bold">var</span> nextOverflow <span style="color:#000;font-weight:bold">*</span>bmap
</span></span><span style="display:flex;"><span>		<span style="color:#998;font-style:italic">//根据B大小分配桶数组的地址空间，以及预分配一些桶的空间
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"></span>		buckets, nextOverflow = <span style="color:#900;font-weight:bold">makeBucketArray</span>(t, B)
</span></span><span style="display:flex;"><span>		<span style="color:#000;font-weight:bold">if</span> nextOverflow <span style="color:#000;font-weight:bold">!=</span> <span style="color:#000;font-weight:bold">nil</span> {
</span></span><span style="display:flex;"><span>			extra = <span style="color:#0086b3">new</span>(mapextra)
</span></span><span style="display:flex;"><span>			extra.nextOverflow = nextOverflow
</span></span><span style="display:flex;"><span>		}
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#998;font-style:italic">// 初始化hmap的其他数值 
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"></span>	<span style="color:#000;font-weight:bold">if</span> h <span style="color:#000;font-weight:bold">==</span> <span style="color:#000;font-weight:bold">nil</span> {
</span></span><span style="display:flex;"><span>		h = (<span style="color:#000;font-weight:bold">*</span>hmap)(<span style="color:#900;font-weight:bold">newobject</span>(t.hmap))
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>	h.count = <span style="color:#099">0</span>
</span></span><span style="display:flex;"><span>	h.B = B
</span></span><span style="display:flex;"><span>	h.extra = extra
</span></span><span style="display:flex;"><span>	h.flags = <span style="color:#099">0</span>
</span></span><span style="display:flex;"><span>	h.hash0 = <span style="color:#900;font-weight:bold">fastrand</span>()
</span></span><span style="display:flex;"><span>	h.buckets = buckets
</span></span><span style="display:flex;"><span>	h.oldbuckets = <span style="color:#000;font-weight:bold">nil</span>
</span></span><span style="display:flex;"><span>	h.nevacuate = <span style="color:#099">0</span>
</span></span><span style="display:flex;"><span>	h.noverflow = <span style="color:#099">0</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#000;font-weight:bold">return</span> h
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></td></tr></table>
</div>
</div><h4 id="map读取">map读取</h4>
<p>map的读取函数很多但核心都一样，下面重点分析mapaccess2函数</p>
<p>
        <img class="mx-auto" alt="map读取过程示例图" src="img_1.png" />   
    </p>
<div class="highlight"><div style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">16
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">17
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">18
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">19
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">20
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">21
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">22
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">23
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">24
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">25
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">26
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">27
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">28
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">29
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">30
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">31
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">32
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">33
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">34
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">35
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">36
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">37
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">38
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">39
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">40
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">41
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">42
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">43
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">44
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">45
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">46
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">47
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">48
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">49
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">50
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">51
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">52
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">53
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">54
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">55
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">56
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">57
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">58
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">59
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">60
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">61
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">62
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">63
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">64
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">65
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">66
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">67
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">68
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">69
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">70
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">71
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">72
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">73
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">74
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#000;font-weight:bold">func</span> <span style="color:#900;font-weight:bold">mapaccess2</span>(t <span style="color:#000;font-weight:bold">*</span>maptype, h <span style="color:#000;font-weight:bold">*</span>hmap, key unsafe.Pointer) (unsafe.Pointer, <span style="color:#458;font-weight:bold">bool</span>) {
</span></span><span style="display:flex;"><span>	<span style="color:#998;font-style:italic">//不知道干啥的，好像已经不适用了
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"></span>	<span style="color:#000;font-weight:bold">...</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#998;font-style:italic">//map为nil或者大小等于0则返回value类型的0值
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"></span>	<span style="color:#000;font-weight:bold">if</span> h <span style="color:#000;font-weight:bold">==</span> <span style="color:#000;font-weight:bold">nil</span> <span style="color:#000;font-weight:bold">||</span> h.count <span style="color:#000;font-weight:bold">==</span> <span style="color:#099">0</span> {
</span></span><span style="display:flex;"><span>		<span style="color:#000;font-weight:bold">return</span> unsafe.<span style="color:#900;font-weight:bold">Pointer</span>(<span style="color:#000;font-weight:bold">&amp;</span>zeroVal[<span style="color:#099">0</span>]), <span style="color:#000;font-weight:bold">false</span>
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>	<span style="color:#998;font-style:italic">//标志位判断是否有协程在写map，有的话抛错误
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"></span>	<span style="color:#000;font-weight:bold">if</span> h.flags<span style="color:#000;font-weight:bold">&amp;</span>hashWriting <span style="color:#000;font-weight:bold">!=</span> <span style="color:#099">0</span> {
</span></span><span style="display:flex;"><span>		<span style="color:#900;font-weight:bold">throw</span>(<span style="color:#d14">&#34;concurrent map read and map write&#34;</span>)
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>	<span style="color:#998;font-style:italic">//拿到key的hash函数
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"></span>	alg <span style="color:#000;font-weight:bold">:=</span> t.key.alg
</span></span><span style="display:flex;"><span>	<span style="color:#998;font-style:italic">//通过map的hash种子和key的hash函数算出哈希值
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"></span>	hash <span style="color:#000;font-weight:bold">:=</span> alg.<span style="color:#900;font-weight:bold">hash</span>(key, <span style="color:#0086b3">uintptr</span>(h.hash0)) <span style="color:#998;font-style:italic">//获取桶的掩码值,即B=5则m=11111
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"></span>	m <span style="color:#000;font-weight:bold">:=</span> <span style="color:#0086b3">uintptr</span>(<span style="color:#099">1</span>)<span style="color:#000;font-weight:bold">&lt;&lt;</span>h.B <span style="color:#000;font-weight:bold">-</span> <span style="color:#099">1</span>
</span></span><span style="display:flex;"><span>	<span style="color:#998;font-style:italic">//通过掩码m获取hash值最后B位数值，得到key所在的桶数组的下标地址
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"></span>	b <span style="color:#000;font-weight:bold">:=</span> (<span style="color:#000;font-weight:bold">*</span>bmap)(unsafe.<span style="color:#900;font-weight:bold">Pointer</span>(<span style="color:#0086b3">uintptr</span>(h.buckets) <span style="color:#000;font-weight:bold">+</span> (hash<span style="color:#000;font-weight:bold">&amp;</span>m)<span style="color:#000;font-weight:bold">*</span><span style="color:#0086b3">uintptr</span>(t.bucketsize)))
</span></span><span style="display:flex;"><span>	<span style="color:#998;font-style:italic">//查看是否有老桶数组，有的话表示map正在扩容
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"></span>	<span style="color:#000;font-weight:bold">if</span> c <span style="color:#000;font-weight:bold">:=</span> h.oldbuckets; c <span style="color:#000;font-weight:bold">!=</span> <span style="color:#000;font-weight:bold">nil</span> {
</span></span><span style="display:flex;"><span>		<span style="color:#998;font-style:italic">//如果不是等大小扩容，则说明是真正的增加桶个数的扩容
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"></span>		<span style="color:#998;font-style:italic">//通常是翻倍增加，因此m右移一位即，老桶的掩码值
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"></span>		<span style="color:#000;font-weight:bold">if</span> !h.<span style="color:#900;font-weight:bold">sameSizeGrow</span>() {
</span></span><span style="display:flex;"><span>			m <span style="color:#000;font-weight:bold">&gt;&gt;=</span> <span style="color:#099">1</span>
</span></span><span style="display:flex;"><span>		}
</span></span><span style="display:flex;"><span>		<span style="color:#998;font-style:italic">//通过老桶数组的掩码值计算老桶数组中key对应的桶地址
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"></span>		oldb <span style="color:#000;font-weight:bold">:=</span> (<span style="color:#000;font-weight:bold">*</span>bmap)(unsafe.<span style="color:#900;font-weight:bold">Pointer</span>(<span style="color:#0086b3">uintptr</span>(c) <span style="color:#000;font-weight:bold">+</span> (hash<span style="color:#000;font-weight:bold">&amp;</span>m)<span style="color:#000;font-weight:bold">*</span><span style="color:#0086b3">uintptr</span>(t.bucketsize)))
</span></span><span style="display:flex;"><span>		<span style="color:#998;font-style:italic">//判断是否已经搬迁，如果没有搬迁，则用老桶地址来寻找
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"></span>		<span style="color:#998;font-style:italic">//怎么判断是否搬迁？看桶的第一个tophash是否在1-3之间，1-3为桶的特殊标记
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"></span>		<span style="color:#998;font-style:italic">//一次搬迁一个桶及其溢出桶，只有搬迁后才会设置特殊标记
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"></span>		<span style="color:#000;font-weight:bold">if</span> !<span style="color:#900;font-weight:bold">evacuated</span>(oldb) {
</span></span><span style="display:flex;"><span>			b = oldb
</span></span><span style="display:flex;"><span>		}
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>	<span style="color:#998;font-style:italic">//取hash值前8位作为tophash值和桶的tonghash数组对比进行快速定位查找
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"></span>	top <span style="color:#000;font-weight:bold">:=</span> <span style="color:#0086b3">uint8</span>(hash <span style="color:#000;font-weight:bold">&gt;&gt;</span> (sys.PtrSize<span style="color:#000;font-weight:bold">*</span><span style="color:#099">8</span> <span style="color:#000;font-weight:bold">-</span> <span style="color:#099">8</span>))
</span></span><span style="display:flex;"><span>	<span style="color:#998;font-style:italic">//top取值小于4的,需要加4,因为0-3是tophash的特殊标记
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"></span>	<span style="color:#000;font-weight:bold">if</span> top &lt; minTopHash {
</span></span><span style="display:flex;"><span>		top <span style="color:#000;font-weight:bold">+=</span> minTopHash
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>	<span style="color:#000;font-weight:bold">for</span> {
</span></span><span style="display:flex;"><span>		<span style="color:#998;font-style:italic">//遍历桶的8个位置
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"></span>		<span style="color:#000;font-weight:bold">for</span> i <span style="color:#000;font-weight:bold">:=</span> <span style="color:#0086b3">uintptr</span>(<span style="color:#099">0</span>); i &lt; bucketCnt; i<span style="color:#000;font-weight:bold">++</span> {
</span></span><span style="display:flex;"><span>			<span style="color:#998;font-style:italic">//通过tophash快速判断
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"></span>			<span style="color:#000;font-weight:bold">if</span> b.tophash[i] <span style="color:#000;font-weight:bold">!=</span> top {
</span></span><span style="display:flex;"><span>				<span style="color:#000;font-weight:bold">continue</span>
</span></span><span style="display:flex;"><span>			}
</span></span><span style="display:flex;"><span>			<span style="color:#998;font-style:italic">//tophash值相同的，则把key拿出来
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"></span>			k <span style="color:#000;font-weight:bold">:=</span> <span style="color:#900;font-weight:bold">add</span>(unsafe.<span style="color:#900;font-weight:bold">Pointer</span>(b), dataOffset<span style="color:#000;font-weight:bold">+</span>i<span style="color:#000;font-weight:bold">*</span><span style="color:#0086b3">uintptr</span>(t.keysize))
</span></span><span style="display:flex;"><span>			<span style="color:#998;font-style:italic">//如果key存的是指针 
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"></span>			<span style="color:#000;font-weight:bold">if</span> t.indirectkey {
</span></span><span style="display:flex;"><span>				<span style="color:#998;font-style:italic">//取出值来
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"></span>				k = <span style="color:#000;font-weight:bold">*</span>((<span style="color:#000;font-weight:bold">*</span>unsafe.Pointer)(k))
</span></span><span style="display:flex;"><span>			}
</span></span><span style="display:flex;"><span>			<span style="color:#998;font-style:italic">//计算key和k的值是否相等，tophash一样的不一定key一样哈
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"></span>			<span style="color:#000;font-weight:bold">if</span> alg.<span style="color:#900;font-weight:bold">equal</span>(key, k) {
</span></span><span style="display:flex;"><span>				<span style="color:#998;font-style:italic">//一样的话，拿对应的值
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"></span>				v <span style="color:#000;font-weight:bold">:=</span> <span style="color:#900;font-weight:bold">add</span>(unsafe.<span style="color:#900;font-weight:bold">Pointer</span>(b), dataOffset<span style="color:#000;font-weight:bold">+</span>bucketCnt<span style="color:#000;font-weight:bold">*</span><span style="color:#0086b3">uintptr</span>(t.keysize)<span style="color:#000;font-weight:bold">+</span>i<span style="color:#000;font-weight:bold">*</span><span style="color:#0086b3">uintptr</span>(t.valuesize))
</span></span><span style="display:flex;"><span>				<span style="color:#998;font-style:italic">//值存的是指针，则通过指针获取正在的值
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"></span>				<span style="color:#000;font-weight:bold">if</span> t.indirectvalue {
</span></span><span style="display:flex;"><span>					v = <span style="color:#000;font-weight:bold">*</span>((<span style="color:#000;font-weight:bold">*</span>unsafe.Pointer)(v))
</span></span><span style="display:flex;"><span>				}
</span></span><span style="display:flex;"><span>				<span style="color:#000;font-weight:bold">return</span> v, <span style="color:#000;font-weight:bold">true</span>
</span></span><span style="display:flex;"><span>			}
</span></span><span style="display:flex;"><span>		}
</span></span><span style="display:flex;"><span>		<span style="color:#998;font-style:italic">//8个都没有则看是否有溢出桶
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"></span>		b = b.<span style="color:#900;font-weight:bold">overflow</span>(t)
</span></span><span style="display:flex;"><span>		<span style="color:#000;font-weight:bold">if</span> b <span style="color:#000;font-weight:bold">==</span> <span style="color:#000;font-weight:bold">nil</span> {
</span></span><span style="display:flex;"><span>			<span style="color:#998;font-style:italic">//没有溢出桶，返回value类型的0值
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"></span>			<span style="color:#000;font-weight:bold">return</span> unsafe.<span style="color:#900;font-weight:bold">Pointer</span>(<span style="color:#000;font-weight:bold">&amp;</span>zeroVal[<span style="color:#099">0</span>]), <span style="color:#000;font-weight:bold">false</span>
</span></span><span style="display:flex;"><span>		}
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></td></tr></table>
</div>
</div><h4 id="map赋值">map赋值</h4>
<div class="highlight"><div style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">  1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">  2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">  3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">  4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">  5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">  6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">  7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">  8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">  9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 16
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 17
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 18
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 19
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 20
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 21
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 22
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 23
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 24
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 25
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 26
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 27
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 28
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 29
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 30
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 31
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 32
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 33
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 34
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 35
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 36
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 37
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 38
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 39
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 40
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 41
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 42
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 43
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 44
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 45
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 46
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 47
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 48
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 49
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 50
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 51
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 52
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 53
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 54
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 55
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 56
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 57
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 58
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 59
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 60
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 61
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 62
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 63
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 64
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 65
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 66
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 67
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 68
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 69
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 70
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 71
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 72
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 73
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 74
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 75
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 76
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 77
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 78
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 79
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 80
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 81
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 82
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 83
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 84
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 85
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 86
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 87
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 88
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 89
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 90
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 91
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 92
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 93
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 94
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 95
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 96
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 97
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 98
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 99
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">100
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">101
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">102
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">103
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">104
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">105
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">106
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">107
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">108
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">109
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">110
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">111
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">112
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">113
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">114
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">115
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">116
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">117
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">118
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">119
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">120
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">121
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">122
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">123
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">124
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">125
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">126
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">127
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">128
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">129
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">130
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">131
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">132
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">133
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">134
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">135
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">136
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#000;font-weight:bold">func</span> <span style="color:#900;font-weight:bold">mapassign</span>(t <span style="color:#000;font-weight:bold">*</span>maptype, h <span style="color:#000;font-weight:bold">*</span>hmap, key unsafe.Pointer) unsafe.Pointer {
</span></span><span style="display:flex;"><span>	<span style="color:#998;font-style:italic">//map为nil 抛panic
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"></span>	<span style="color:#000;font-weight:bold">if</span> h <span style="color:#000;font-weight:bold">==</span> <span style="color:#000;font-weight:bold">nil</span> {
</span></span><span style="display:flex;"><span>		<span style="color:#0086b3">panic</span>(<span style="color:#900;font-weight:bold">plainError</span>(<span style="color:#d14">&#34;assignment to entry in nil map&#34;</span>))
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>	<span style="color:#998;font-style:italic">//好像是废弃的代码
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"></span>	<span style="color:#000;font-weight:bold">...</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#998;font-style:italic">//判断是否有写的协程在操作
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"></span>	<span style="color:#000;font-weight:bold">if</span> h.flags<span style="color:#000;font-weight:bold">&amp;</span>hashWriting <span style="color:#000;font-weight:bold">!=</span> <span style="color:#099">0</span> {
</span></span><span style="display:flex;"><span>		<span style="color:#900;font-weight:bold">throw</span>(<span style="color:#d14">&#34;concurrent map writes&#34;</span>)
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>	alg <span style="color:#000;font-weight:bold">:=</span> t.key.alg
</span></span><span style="display:flex;"><span>	hash <span style="color:#000;font-weight:bold">:=</span> alg.<span style="color:#900;font-weight:bold">hash</span>(key, <span style="color:#0086b3">uintptr</span>(h.hash0))
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#998;font-style:italic">//map的标志位设置写状态
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"></span>	h.flags <span style="color:#000;font-weight:bold">|=</span> hashWriting
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#998;font-style:italic">//如果桶数组为nil则分配1个
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"></span>	<span style="color:#000;font-weight:bold">if</span> h.buckets <span style="color:#000;font-weight:bold">==</span> <span style="color:#000;font-weight:bold">nil</span> {
</span></span><span style="display:flex;"><span>		h.buckets = <span style="color:#900;font-weight:bold">newarray</span>(t.bucket, <span style="color:#099">1</span>)
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>again:
</span></span><span style="display:flex;"><span>	<span style="color:#998;font-style:italic">//拿到key对应的桶数组地址
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"></span>	bucket <span style="color:#000;font-weight:bold">:=</span> hash <span style="color:#000;font-weight:bold">&amp;</span> (<span style="color:#0086b3">uintptr</span>(<span style="color:#099">1</span>)<span style="color:#000;font-weight:bold">&lt;&lt;</span>h.B <span style="color:#000;font-weight:bold">-</span> <span style="color:#099">1</span>)
</span></span><span style="display:flex;"><span>	<span style="color:#998;font-style:italic">//如果map处于扩容状态则尝试搬迁当前桶
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"></span>	<span style="color:#000;font-weight:bold">if</span> h.<span style="color:#900;font-weight:bold">growing</span>() {
</span></span><span style="display:flex;"><span>		<span style="color:#998;font-style:italic">//桶的搬迁工作，一次尝试搬迁两个桶，具体后续分析
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"></span>		<span style="color:#900;font-weight:bold">growWork</span>(t, h, bucket)
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>	<span style="color:#998;font-style:italic">//以下部分和map的查找逻辑一样
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"></span>	b <span style="color:#000;font-weight:bold">:=</span> (<span style="color:#000;font-weight:bold">*</span>bmap)(unsafe.<span style="color:#900;font-weight:bold">Pointer</span>(<span style="color:#0086b3">uintptr</span>(h.buckets) <span style="color:#000;font-weight:bold">+</span> bucket<span style="color:#000;font-weight:bold">*</span><span style="color:#0086b3">uintptr</span>(t.bucketsize)))
</span></span><span style="display:flex;"><span>	top <span style="color:#000;font-weight:bold">:=</span> <span style="color:#0086b3">uint8</span>(hash <span style="color:#000;font-weight:bold">&gt;&gt;</span> (sys.PtrSize<span style="color:#000;font-weight:bold">*</span><span style="color:#099">8</span> <span style="color:#000;font-weight:bold">-</span> <span style="color:#099">8</span>))
</span></span><span style="display:flex;"><span>	<span style="color:#000;font-weight:bold">if</span> top &lt; minTopHash {
</span></span><span style="display:flex;"><span>		top <span style="color:#000;font-weight:bold">+=</span> minTopHash
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#000;font-weight:bold">var</span> inserti <span style="color:#000;font-weight:bold">*</span><span style="color:#458;font-weight:bold">uint8</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000;font-weight:bold">var</span> insertk unsafe.Pointer
</span></span><span style="display:flex;"><span>	<span style="color:#000;font-weight:bold">var</span> val unsafe.Pointer
</span></span><span style="display:flex;"><span>	<span style="color:#000;font-weight:bold">for</span> {
</span></span><span style="display:flex;"><span>		<span style="color:#000;font-weight:bold">for</span> i <span style="color:#000;font-weight:bold">:=</span> <span style="color:#0086b3">uintptr</span>(<span style="color:#099">0</span>); i &lt; bucketCnt; i<span style="color:#000;font-weight:bold">++</span> {
</span></span><span style="display:flex;"><span>			<span style="color:#000;font-weight:bold">if</span> b.tophash[i] <span style="color:#000;font-weight:bold">!=</span> top {
</span></span><span style="display:flex;"><span>			<span style="color:#998;font-style:italic">//tophash不相等，则尝试看这个地址是否是空的
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"></span>				<span style="color:#000;font-weight:bold">if</span> b.tophash[i] <span style="color:#000;font-weight:bold">==</span> empty <span style="color:#000;font-weight:bold">&amp;&amp;</span> inserti <span style="color:#000;font-weight:bold">==</span> <span style="color:#000;font-weight:bold">nil</span> {
</span></span><span style="display:flex;"><span>					<span style="color:#998;font-style:italic">//这个位置是空的并且inserti的指针为空，则先让inserti指向这个位置
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"></span>					<span style="color:#998;font-style:italic">//如果map中没有当前key则可以用这个空位置存储key
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"></span>					inserti = <span style="color:#000;font-weight:bold">&amp;</span>b.tophash[i]
</span></span><span style="display:flex;"><span>					insertk = <span style="color:#900;font-weight:bold">add</span>(unsafe.<span style="color:#900;font-weight:bold">Pointer</span>(b), dataOffset<span style="color:#000;font-weight:bold">+</span>i<span style="color:#000;font-weight:bold">*</span><span style="color:#0086b3">uintptr</span>(t.keysize))
</span></span><span style="display:flex;"><span>					val = <span style="color:#900;font-weight:bold">add</span>(unsafe.<span style="color:#900;font-weight:bold">Pointer</span>(b), dataOffset<span style="color:#000;font-weight:bold">+</span>bucketCnt<span style="color:#000;font-weight:bold">*</span><span style="color:#0086b3">uintptr</span>(t.keysize)<span style="color:#000;font-weight:bold">+</span>i<span style="color:#000;font-weight:bold">*</span><span style="color:#0086b3">uintptr</span>(t.valuesize))
</span></span><span style="display:flex;"><span>				}
</span></span><span style="display:flex;"><span>				<span style="color:#000;font-weight:bold">continue</span>
</span></span><span style="display:flex;"><span>			}
</span></span><span style="display:flex;"><span>			<span style="color:#998;font-style:italic">//tophash一样，则通过equal看找到的k是否是key
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"></span>			k <span style="color:#000;font-weight:bold">:=</span> <span style="color:#900;font-weight:bold">add</span>(unsafe.<span style="color:#900;font-weight:bold">Pointer</span>(b), dataOffset<span style="color:#000;font-weight:bold">+</span>i<span style="color:#000;font-weight:bold">*</span><span style="color:#0086b3">uintptr</span>(t.keysize))
</span></span><span style="display:flex;"><span>			<span style="color:#000;font-weight:bold">if</span> t.indirectkey {
</span></span><span style="display:flex;"><span>				k = <span style="color:#000;font-weight:bold">*</span>((<span style="color:#000;font-weight:bold">*</span>unsafe.Pointer)(k))
</span></span><span style="display:flex;"><span>			}
</span></span><span style="display:flex;"><span>			<span style="color:#000;font-weight:bold">if</span> !alg.<span style="color:#900;font-weight:bold">equal</span>(key, k) {
</span></span><span style="display:flex;"><span>				<span style="color:#000;font-weight:bold">continue</span>
</span></span><span style="display:flex;"><span>			}
</span></span><span style="display:flex;"><span>			<span style="color:#998;font-style:italic">//走到这一步，确定map中已经有key了，则需要更新key的值
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"></span>			<span style="color:#998;font-style:italic">//needkeyupdate判断是否需要重写key，不知道为什么会有重写key的操作?留坑
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"></span>			<span style="color:#000;font-weight:bold">if</span> t.needkeyupdate {
</span></span><span style="display:flex;"><span>				<span style="color:#900;font-weight:bold">typedmemmove</span>(t.key, k, key)
</span></span><span style="display:flex;"><span>			}
</span></span><span style="display:flex;"><span>			<span style="color:#998;font-style:italic">//val作为值的地址拿出来，跳转到结束阶段
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"></span>			val = <span style="color:#900;font-weight:bold">add</span>(unsafe.<span style="color:#900;font-weight:bold">Pointer</span>(b), dataOffset<span style="color:#000;font-weight:bold">+</span>bucketCnt<span style="color:#000;font-weight:bold">*</span><span style="color:#0086b3">uintptr</span>(t.keysize)<span style="color:#000;font-weight:bold">+</span>i<span style="color:#000;font-weight:bold">*</span><span style="color:#0086b3">uintptr</span>(t.valuesize))
</span></span><span style="display:flex;"><span>			<span style="color:#000;font-weight:bold">goto</span> done
</span></span><span style="display:flex;"><span>		}
</span></span><span style="display:flex;"><span>		<span style="color:#998;font-style:italic">//这个桶里面没找打，则看看是否有溢出桶
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"></span>		ovf <span style="color:#000;font-weight:bold">:=</span> b.<span style="color:#900;font-weight:bold">overflow</span>(t)
</span></span><span style="display:flex;"><span>		<span style="color:#000;font-weight:bold">if</span> ovf <span style="color:#000;font-weight:bold">==</span> <span style="color:#000;font-weight:bold">nil</span> {
</span></span><span style="display:flex;"><span>			<span style="color:#998;font-style:italic">//没有就跳出for，说明map里没有包含key
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"></span>			<span style="color:#000;font-weight:bold">break</span>
</span></span><span style="display:flex;"><span>		}
</span></span><span style="display:flex;"><span>		b = ovf
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#998;font-style:italic">//map不在扩容状态，则判断是否需要扩容
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"></span>	<span style="color:#998;font-style:italic">//扩容准则1.是否超过转载因子 2.是否冗余溢出桶太多(原本很多key的map删除很多key之后的情况)
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"></span>	<span style="color:#000;font-weight:bold">if</span> !h.<span style="color:#900;font-weight:bold">growing</span>() <span style="color:#000;font-weight:bold">&amp;&amp;</span> (<span style="color:#900;font-weight:bold">overLoadFactor</span>(<span style="color:#0086b3">int64</span>(h.count), h.B) <span style="color:#000;font-weight:bold">||</span> <span style="color:#900;font-weight:bold">tooManyOverflowBuckets</span>(h.noverflow, h.B)) {
</span></span><span style="display:flex;"><span>		<span style="color:#998;font-style:italic">//扩容前操作，后面会分析，就是分配新的地址空间为扩容的搬迁做准备
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"></span>		<span style="color:#900;font-weight:bold">hashGrow</span>(t, h)
</span></span><span style="display:flex;"><span>		<span style="color:#998;font-style:italic">//重新走上面流程
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"></span>		<span style="color:#000;font-weight:bold">goto</span> again <span style="color:#998;font-style:italic">// Growing the table invalidates everything, so try again
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"></span>	}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#998;font-style:italic">//上面的扩容流程之后的在此寻找，其实会进行两次搬迁操作后定位key
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"></span>	<span style="color:#998;font-style:italic">//map里没有key的话就会给inserti一个新的地址
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"></span>	<span style="color:#998;font-style:italic">//这里inserti等于nil则说明map没有达到扩容阈值，而桶和它的溢出桶的8个位置已经用完了，则需要再加一个溢出桶
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"></span>	<span style="color:#000;font-weight:bold">if</span> inserti <span style="color:#000;font-weight:bold">==</span> <span style="color:#000;font-weight:bold">nil</span> {
</span></span><span style="display:flex;"><span>		<span style="color:#998;font-style:italic">//申请一个新的溢出桶
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"></span>		newb <span style="color:#000;font-weight:bold">:=</span> h.<span style="color:#900;font-weight:bold">newoverflow</span>(t, b)
</span></span><span style="display:flex;"><span>		<span style="color:#998;font-style:italic">//既然是新的，当然用第一位了
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"></span>		inserti = <span style="color:#000;font-weight:bold">&amp;</span>newb.tophash[<span style="color:#099">0</span>]
</span></span><span style="display:flex;"><span>		insertk = <span style="color:#900;font-weight:bold">add</span>(unsafe.<span style="color:#900;font-weight:bold">Pointer</span>(newb), dataOffset)
</span></span><span style="display:flex;"><span>		val = <span style="color:#900;font-weight:bold">add</span>(insertk, bucketCnt<span style="color:#000;font-weight:bold">*</span><span style="color:#0086b3">uintptr</span>(t.keysize))
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#998;font-style:italic">//到这里，说明key不存在map里，则新建对应的key和value
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"></span>	<span style="color:#998;font-style:italic">//key是指针，则申请一个key类型的数据
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"></span>	<span style="color:#998;font-style:italic">//insertk指向该数据的地址
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"></span>	<span style="color:#000;font-weight:bold">if</span> t.indirectkey {
</span></span><span style="display:flex;"><span>		kmem <span style="color:#000;font-weight:bold">:=</span> <span style="color:#900;font-weight:bold">newobject</span>(t.key)
</span></span><span style="display:flex;"><span>		<span style="color:#000;font-weight:bold">*</span>(<span style="color:#000;font-weight:bold">*</span>unsafe.Pointer)(insertk) = kmem
</span></span><span style="display:flex;"><span>		insertk = kmem
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>	<span style="color:#998;font-style:italic">//同理value一样
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"></span>	<span style="color:#000;font-weight:bold">if</span> t.indirectvalue {
</span></span><span style="display:flex;"><span>		vmem <span style="color:#000;font-weight:bold">:=</span> <span style="color:#900;font-weight:bold">newobject</span>(t.elem)
</span></span><span style="display:flex;"><span>		<span style="color:#000;font-weight:bold">*</span>(<span style="color:#000;font-weight:bold">*</span>unsafe.Pointer)(val) = vmem
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>	<span style="color:#998;font-style:italic">//拷贝key的值
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"></span>	<span style="color:#900;font-weight:bold">typedmemmove</span>(t.key, insertk, key)
</span></span><span style="display:flex;"><span>	<span style="color:#998;font-style:italic">//设置tophash
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"></span>	<span style="color:#000;font-weight:bold">*</span>inserti = top
</span></span><span style="display:flex;"><span>	<span style="color:#998;font-style:italic">//map的大小加一
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"></span>	h.count<span style="color:#000;font-weight:bold">++</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>done:
</span></span><span style="display:flex;"><span>	<span style="color:#998;font-style:italic">//判断写标记位是否存在，如果被清除了，说明并发写的情况
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"></span>	<span style="color:#998;font-style:italic">//直接抛错误
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"></span>	<span style="color:#000;font-weight:bold">if</span> h.flags<span style="color:#000;font-weight:bold">&amp;</span>hashWriting <span style="color:#000;font-weight:bold">==</span> <span style="color:#099">0</span> {
</span></span><span style="display:flex;"><span>		<span style="color:#900;font-weight:bold">throw</span>(<span style="color:#d14">&#34;concurrent map writes&#34;</span>)
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>	<span style="color:#998;font-style:italic">//清除写标志位
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"></span>	h.flags <span style="color:#000;font-weight:bold">&amp;^=</span> hashWriting
</span></span><span style="display:flex;"><span>	<span style="color:#998;font-style:italic">//
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"></span>	<span style="color:#000;font-weight:bold">if</span> t.indirectvalue {
</span></span><span style="display:flex;"><span>		val = <span style="color:#000;font-weight:bold">*</span>((<span style="color:#000;font-weight:bold">*</span>unsafe.Pointer)(val))
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>	<span style="color:#998;font-style:italic">//返回val的地址，具体赋值是编译器的额外汇编指令处理
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"></span>	<span style="color:#000;font-weight:bold">return</span> val
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></td></tr></table>
</div>
</div><h4 id="map删除">map删除</h4>
<div class="highlight"><div style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">16
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">17
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">18
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">19
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">20
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">21
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">22
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">23
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">24
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">25
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">26
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">27
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">28
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">29
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">30
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">31
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">32
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">33
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">34
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">35
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">36
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">37
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">38
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">39
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">40
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">41
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">42
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">43
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">44
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">45
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">46
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">47
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">48
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">49
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">50
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">51
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">52
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">53
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">54
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">55
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">56
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">57
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">58
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">59
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">60
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">61
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">62
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">63
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">64
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">65
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">66
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">67
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">68
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">69
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">70
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">71
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">72
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">73
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">74
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">75
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#000;font-weight:bold">func</span> <span style="color:#900;font-weight:bold">mapdelete</span>(t <span style="color:#000;font-weight:bold">*</span>maptype, h <span style="color:#000;font-weight:bold">*</span>hmap, key unsafe.Pointer) {
</span></span><span style="display:flex;"><span>	<span style="color:#998;font-style:italic">//好像又是不要的部分代码
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"></span>	<span style="color:#000;font-weight:bold">...</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#998;font-style:italic">//map为nil或者带下为0则直接返回了
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"></span>	<span style="color:#000;font-weight:bold">if</span> h <span style="color:#000;font-weight:bold">==</span> <span style="color:#000;font-weight:bold">nil</span> <span style="color:#000;font-weight:bold">||</span> h.count <span style="color:#000;font-weight:bold">==</span> <span style="color:#099">0</span> {
</span></span><span style="display:flex;"><span>		<span style="color:#000;font-weight:bold">return</span>
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>	<span style="color:#998;font-style:italic">//有协程在写，则抛异常，delete也是视为对map的写操作
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"></span>	<span style="color:#000;font-weight:bold">if</span> h.flags<span style="color:#000;font-weight:bold">&amp;</span>hashWriting <span style="color:#000;font-weight:bold">!=</span> <span style="color:#099">0</span> {
</span></span><span style="display:flex;"><span>		<span style="color:#900;font-weight:bold">throw</span>(<span style="color:#d14">&#34;concurrent map writes&#34;</span>)
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	alg <span style="color:#000;font-weight:bold">:=</span> t.key.alg
</span></span><span style="display:flex;"><span>	hash <span style="color:#000;font-weight:bold">:=</span> alg.<span style="color:#900;font-weight:bold">hash</span>(key, <span style="color:#0086b3">uintptr</span>(h.hash0))
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#998;font-style:italic">//设置写标记位
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"></span>	h.flags <span style="color:#000;font-weight:bold">|=</span> hashWriting
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	bucket <span style="color:#000;font-weight:bold">:=</span> hash <span style="color:#000;font-weight:bold">&amp;</span> (<span style="color:#0086b3">uintptr</span>(<span style="color:#099">1</span>)<span style="color:#000;font-weight:bold">&lt;&lt;</span>h.B <span style="color:#000;font-weight:bold">-</span> <span style="color:#099">1</span>)
</span></span><span style="display:flex;"><span>	<span style="color:#998;font-style:italic">//如果是搬迁状态则尝试搬迁这个桶
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"></span>	<span style="color:#000;font-weight:bold">if</span> h.<span style="color:#900;font-weight:bold">growing</span>() {
</span></span><span style="display:flex;"><span>		<span style="color:#900;font-weight:bold">growWork</span>(t, h, bucket)
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>	<span style="color:#998;font-style:italic">//以下阶段经典的找key阶段
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"></span>	b <span style="color:#000;font-weight:bold">:=</span> (<span style="color:#000;font-weight:bold">*</span>bmap)(unsafe.<span style="color:#900;font-weight:bold">Pointer</span>(<span style="color:#0086b3">uintptr</span>(h.buckets) <span style="color:#000;font-weight:bold">+</span> bucket<span style="color:#000;font-weight:bold">*</span><span style="color:#0086b3">uintptr</span>(t.bucketsize)))
</span></span><span style="display:flex;"><span>	top <span style="color:#000;font-weight:bold">:=</span> <span style="color:#0086b3">uint8</span>(hash <span style="color:#000;font-weight:bold">&gt;&gt;</span> (sys.PtrSize<span style="color:#000;font-weight:bold">*</span><span style="color:#099">8</span> <span style="color:#000;font-weight:bold">-</span> <span style="color:#099">8</span>))
</span></span><span style="display:flex;"><span>	<span style="color:#000;font-weight:bold">if</span> top &lt; minTopHash {
</span></span><span style="display:flex;"><span>		top <span style="color:#000;font-weight:bold">+=</span> minTopHash
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>	<span style="color:#000;font-weight:bold">for</span> {
</span></span><span style="display:flex;"><span>		<span style="color:#000;font-weight:bold">for</span> i <span style="color:#000;font-weight:bold">:=</span> <span style="color:#0086b3">uintptr</span>(<span style="color:#099">0</span>); i &lt; bucketCnt; i<span style="color:#000;font-weight:bold">++</span> {
</span></span><span style="display:flex;"><span>			<span style="color:#000;font-weight:bold">if</span> b.tophash[i] <span style="color:#000;font-weight:bold">!=</span> top {
</span></span><span style="display:flex;"><span>				<span style="color:#000;font-weight:bold">continue</span>
</span></span><span style="display:flex;"><span>			}
</span></span><span style="display:flex;"><span>			k <span style="color:#000;font-weight:bold">:=</span> <span style="color:#900;font-weight:bold">add</span>(unsafe.<span style="color:#900;font-weight:bold">Pointer</span>(b), dataOffset<span style="color:#000;font-weight:bold">+</span>i<span style="color:#000;font-weight:bold">*</span><span style="color:#0086b3">uintptr</span>(t.keysize))
</span></span><span style="display:flex;"><span>			k2 <span style="color:#000;font-weight:bold">:=</span> k
</span></span><span style="display:flex;"><span>			<span style="color:#000;font-weight:bold">if</span> t.indirectkey {
</span></span><span style="display:flex;"><span>				k2 = <span style="color:#000;font-weight:bold">*</span>((<span style="color:#000;font-weight:bold">*</span>unsafe.Pointer)(k2))
</span></span><span style="display:flex;"><span>			}
</span></span><span style="display:flex;"><span>			<span style="color:#000;font-weight:bold">if</span> !alg.<span style="color:#900;font-weight:bold">equal</span>(key, k2) {
</span></span><span style="display:flex;"><span>				<span style="color:#000;font-weight:bold">continue</span>
</span></span><span style="display:flex;"><span>			}
</span></span><span style="display:flex;"><span>			<span style="color:#000;font-weight:bold">if</span> t.indirectkey {
</span></span><span style="display:flex;"><span>				<span style="color:#000;font-weight:bold">*</span>(<span style="color:#000;font-weight:bold">*</span>unsafe.Pointer)(k) = <span style="color:#000;font-weight:bold">nil</span>
</span></span><span style="display:flex;"><span>			} <span style="color:#000;font-weight:bold">else</span> {
</span></span><span style="display:flex;"><span>				<span style="color:#900;font-weight:bold">typedmemclr</span>(t.key, k)
</span></span><span style="display:flex;"><span>			}
</span></span><span style="display:flex;"><span>			v <span style="color:#000;font-weight:bold">:=</span> unsafe.<span style="color:#900;font-weight:bold">Pointer</span>(<span style="color:#0086b3">uintptr</span>(unsafe.<span style="color:#900;font-weight:bold">Pointer</span>(b)) <span style="color:#000;font-weight:bold">+</span> dataOffset <span style="color:#000;font-weight:bold">+</span> bucketCnt<span style="color:#000;font-weight:bold">*</span><span style="color:#0086b3">uintptr</span>(t.keysize) <span style="color:#000;font-weight:bold">+</span> i<span style="color:#000;font-weight:bold">*</span><span style="color:#0086b3">uintptr</span>(t.valuesize))
</span></span><span style="display:flex;"><span>			<span style="color:#000;font-weight:bold">if</span> t.indirectvalue {
</span></span><span style="display:flex;"><span>				<span style="color:#000;font-weight:bold">*</span>(<span style="color:#000;font-weight:bold">*</span>unsafe.Pointer)(v) = <span style="color:#000;font-weight:bold">nil</span>
</span></span><span style="display:flex;"><span>			} <span style="color:#000;font-weight:bold">else</span> {
</span></span><span style="display:flex;"><span>				<span style="color:#900;font-weight:bold">typedmemclr</span>(t.elem, v)
</span></span><span style="display:flex;"><span>			}
</span></span><span style="display:flex;"><span>			<span style="color:#998;font-style:italic">//对应tophash置空
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"></span>			b.tophash[i] = empty
</span></span><span style="display:flex;"><span>			<span style="color:#998;font-style:italic">//大小减一
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"></span>			h.count<span style="color:#000;font-weight:bold">--</span>
</span></span><span style="display:flex;"><span>			<span style="color:#998;font-style:italic">//调整结束阶段
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"></span>			<span style="color:#000;font-weight:bold">goto</span> done
</span></span><span style="display:flex;"><span>		}
</span></span><span style="display:flex;"><span>		b = b.<span style="color:#900;font-weight:bold">overflow</span>(t)
</span></span><span style="display:flex;"><span>		<span style="color:#000;font-weight:bold">if</span> b <span style="color:#000;font-weight:bold">==</span> <span style="color:#000;font-weight:bold">nil</span> {
</span></span><span style="display:flex;"><span>			<span style="color:#000;font-weight:bold">goto</span> done
</span></span><span style="display:flex;"><span>		}
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>done:
</span></span><span style="display:flex;"><span>	<span style="color:#998;font-style:italic">//判断以下是否并发写
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"></span>	<span style="color:#000;font-weight:bold">if</span> h.flags<span style="color:#000;font-weight:bold">&amp;</span>hashWriting <span style="color:#000;font-weight:bold">==</span> <span style="color:#099">0</span> {
</span></span><span style="display:flex;"><span>		<span style="color:#900;font-weight:bold">throw</span>(<span style="color:#d14">&#34;concurrent map writes&#34;</span>)
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>	<span style="color:#998;font-style:italic">//清空写标志位
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"></span>	h.flags <span style="color:#000;font-weight:bold">&amp;^=</span> hashWriting
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></td></tr></table>
</div>
</div><h4 id="map扩容">map扩容</h4>
<div class="highlight"><div style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">  1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">  2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">  3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">  4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">  5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">  6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">  7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">  8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">  9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 16
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 17
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 18
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 19
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 20
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 21
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 22
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 23
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 24
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 25
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 26
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 27
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 28
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 29
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 30
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 31
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 32
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 33
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 34
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 35
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 36
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 37
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 38
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 39
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 40
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 41
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 42
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 43
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 44
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 45
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 46
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 47
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 48
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 49
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 50
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 51
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 52
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 53
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 54
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 55
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 56
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 57
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 58
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 59
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 60
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 61
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 62
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 63
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 64
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 65
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 66
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 67
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 68
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 69
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 70
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 71
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 72
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 73
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 74
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 75
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 76
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 77
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 78
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 79
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 80
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 81
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 82
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 83
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 84
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 85
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 86
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 87
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 88
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 89
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 90
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 91
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 92
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 93
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 94
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 95
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 96
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 97
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 98
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 99
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">100
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">101
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">102
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">103
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">104
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">105
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">106
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">107
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">108
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">109
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">110
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">111
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">112
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">113
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">114
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">115
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">116
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">117
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">118
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">119
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">120
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">121
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">122
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">123
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">124
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">125
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">126
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">127
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">128
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">129
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">130
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">131
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">132
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">133
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">134
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">135
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">136
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">137
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">138
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">139
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">140
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">141
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">142
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">143
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">144
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">145
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">146
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">147
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">148
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">149
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">150
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">151
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">152
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">153
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">154
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">155
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">156
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">157
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">158
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">159
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">160
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">161
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">162
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">163
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">164
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">165
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">166
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">167
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">168
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">169
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">170
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">171
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">172
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">173
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">174
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">175
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">176
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">177
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">178
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">179
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">180
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">181
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">182
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">183
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">184
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">185
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">186
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">187
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">188
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">189
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">190
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">191
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">192
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">193
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">194
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">195
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">196
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">197
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">198
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">199
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">200
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">201
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">202
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">203
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">204
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">205
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">206
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">207
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">208
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">209
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">210
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">211
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">212
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">213
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">214
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">215
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">216
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">217
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">218
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">219
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">220
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">221
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">222
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">223
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">224
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#000;font-weight:bold">func</span> <span style="color:#900;font-weight:bold">hashGrow</span>(t <span style="color:#000;font-weight:bold">*</span>maptype, h <span style="color:#000;font-weight:bold">*</span>hmap) {
</span></span><span style="display:flex;"><span>	bigger <span style="color:#000;font-weight:bold">:=</span> <span style="color:#0086b3">uint8</span>(<span style="color:#099">1</span>)
</span></span><span style="display:flex;"><span>	<span style="color:#000;font-weight:bold">if</span> !<span style="color:#900;font-weight:bold">overLoadFactor</span>(<span style="color:#0086b3">int64</span>(h.count), h.B) {
</span></span><span style="display:flex;"><span>		<span style="color:#998;font-style:italic">//不是因为超过装载因子而扩容，则bigger置0
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"></span>		bigger = <span style="color:#099">0</span>
</span></span><span style="display:flex;"><span>		<span style="color:#998;font-style:italic">//设置同大小扩容标志位
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"></span>		h.flags <span style="color:#000;font-weight:bold">|=</span> sameSizeGrow
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>	<span style="color:#998;font-style:italic">//当前桶数组地址复制到老桶数组地址
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"></span>	oldbuckets <span style="color:#000;font-weight:bold">:=</span> h.buckets
</span></span><span style="display:flex;"><span>	<span style="color:#998;font-style:italic">//申请新地址空间
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"></span>	newbuckets, nextOverflow <span style="color:#000;font-weight:bold">:=</span> <span style="color:#900;font-weight:bold">makeBucketArray</span>(t, h.B<span style="color:#000;font-weight:bold">+</span>bigger)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#998;font-style:italic">//当前flags清空两个标志位
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"></span>	flags <span style="color:#000;font-weight:bold">:=</span> h.flags <span style="color:#000;font-weight:bold">&amp;^</span> (iterator | oldIterator)
</span></span><span style="display:flex;"><span>	<span style="color:#998;font-style:italic">//如果map有迭代器在读
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"></span>	<span style="color:#000;font-weight:bold">if</span> h.flags<span style="color:#000;font-weight:bold">&amp;</span>iterator <span style="color:#000;font-weight:bold">!=</span> <span style="color:#099">0</span> {
</span></span><span style="display:flex;"><span>		<span style="color:#998;font-style:italic">//flags的老迭代器标志位置1
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"></span>		flags <span style="color:#000;font-weight:bold">|=</span> oldIterator
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>	<span style="color:#998;font-style:italic">//设置map的新属性值
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"></span>	h.B <span style="color:#000;font-weight:bold">+=</span> bigger
</span></span><span style="display:flex;"><span>	h.flags = flags
</span></span><span style="display:flex;"><span>	h.oldbuckets = oldbuckets
</span></span><span style="display:flex;"><span>	h.buckets = newbuckets
</span></span><span style="display:flex;"><span>	h.nevacuate = <span style="color:#099">0</span>
</span></span><span style="display:flex;"><span>	h.noverflow = <span style="color:#099">0</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#000;font-weight:bold">if</span> h.extra <span style="color:#000;font-weight:bold">!=</span> <span style="color:#000;font-weight:bold">nil</span> <span style="color:#000;font-weight:bold">&amp;&amp;</span> h.extra.overflow[<span style="color:#099">0</span>] <span style="color:#000;font-weight:bold">!=</span> <span style="color:#000;font-weight:bold">nil</span> {
</span></span><span style="display:flex;"><span>		<span style="color:#000;font-weight:bold">if</span> h.extra.overflow[<span style="color:#099">1</span>] <span style="color:#000;font-weight:bold">!=</span> <span style="color:#000;font-weight:bold">nil</span> {
</span></span><span style="display:flex;"><span>			<span style="color:#900;font-weight:bold">throw</span>(<span style="color:#d14">&#34;overflow is not nil&#34;</span>)
</span></span><span style="display:flex;"><span>		}
</span></span><span style="display:flex;"><span>		h.extra.overflow[<span style="color:#099">1</span>] = h.extra.overflow[<span style="color:#099">0</span>]
</span></span><span style="display:flex;"><span>		h.extra.overflow[<span style="color:#099">0</span>] = <span style="color:#000;font-weight:bold">nil</span>
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>	<span style="color:#000;font-weight:bold">if</span> nextOverflow <span style="color:#000;font-weight:bold">!=</span> <span style="color:#000;font-weight:bold">nil</span> {
</span></span><span style="display:flex;"><span>		<span style="color:#000;font-weight:bold">if</span> h.extra <span style="color:#000;font-weight:bold">==</span> <span style="color:#000;font-weight:bold">nil</span> {
</span></span><span style="display:flex;"><span>			h.extra = <span style="color:#0086b3">new</span>(mapextra)
</span></span><span style="display:flex;"><span>		}
</span></span><span style="display:flex;"><span>		h.extra.nextOverflow = nextOverflow
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">func</span> (h <span style="color:#000;font-weight:bold">*</span>hmap) <span style="color:#900;font-weight:bold">growing</span>() <span style="color:#458;font-weight:bold">bool</span> {
</span></span><span style="display:flex;"><span>	<span style="color:#000;font-weight:bold">return</span> h.oldbuckets <span style="color:#000;font-weight:bold">!=</span> <span style="color:#000;font-weight:bold">nil</span>
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">func</span> <span style="color:#900;font-weight:bold">growWork</span>(t <span style="color:#000;font-weight:bold">*</span>maptype, h <span style="color:#000;font-weight:bold">*</span>hmap, bucket <span style="color:#458;font-weight:bold">uintptr</span>) {
</span></span><span style="display:flex;"><span>	<span style="color:#998;font-style:italic">//搬迁bucket桶
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"></span>	<span style="color:#998;font-style:italic">//和老桶掩码运算，确保搬迁老的桶下标
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"></span>	<span style="color:#900;font-weight:bold">evacuate</span>(t, h, bucket<span style="color:#000;font-weight:bold">&amp;</span>h.<span style="color:#900;font-weight:bold">oldbucketmask</span>())
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#998;font-style:italic">//没有搬迁完，则在搬一个，这次搬最小未搬迁的桶
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"></span>	<span style="color:#000;font-weight:bold">if</span> h.<span style="color:#900;font-weight:bold">growing</span>() {
</span></span><span style="display:flex;"><span>		<span style="color:#900;font-weight:bold">evacuate</span>(t, h, h.nevacuate)
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">func</span> <span style="color:#900;font-weight:bold">evacuate</span>(t <span style="color:#000;font-weight:bold">*</span>maptype, h <span style="color:#000;font-weight:bold">*</span>hmap, oldbucket <span style="color:#458;font-weight:bold">uintptr</span>) {
</span></span><span style="display:flex;"><span>	<span style="color:#998;font-style:italic">//获取老桶数组中oldbucket的桶地址
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"></span>	b <span style="color:#000;font-weight:bold">:=</span> (<span style="color:#000;font-weight:bold">*</span>bmap)(<span style="color:#900;font-weight:bold">add</span>(h.oldbuckets, oldbucket<span style="color:#000;font-weight:bold">*</span><span style="color:#0086b3">uintptr</span>(t.bucketsize))) <span style="color:#998;font-style:italic">//增长的大小，例如原先map的B=4，扩容后B=5则newbit=2^4
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"></span>	<span style="color:#998;font-style:italic">//用于计算新搬迁桶地址以及相关标志位
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"></span>	newbit <span style="color:#000;font-weight:bold">:=</span> h.<span style="color:#900;font-weight:bold">noldbuckets</span>()
</span></span><span style="display:flex;"><span>	alg <span style="color:#000;font-weight:bold">:=</span> t.key.alg
</span></span><span style="display:flex;"><span>	<span style="color:#998;font-style:italic">//判断是否搬迁了
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"></span>	<span style="color:#000;font-weight:bold">if</span> !<span style="color:#900;font-weight:bold">evacuated</span>(b) {
</span></span><span style="display:flex;"><span>		<span style="color:#000;font-weight:bold">var</span> (
</span></span><span style="display:flex;"><span>			x, y   <span style="color:#000;font-weight:bold">*</span>bmap
</span></span><span style="display:flex;"><span>			xi, yi <span style="color:#458;font-weight:bold">int</span>
</span></span><span style="display:flex;"><span>			xk, yk unsafe.Pointer
</span></span><span style="display:flex;"><span>			xv, yv unsafe.Pointer
</span></span><span style="display:flex;"><span>		)
</span></span><span style="display:flex;"><span>		<span style="color:#998;font-style:italic">//x指向新桶数组中的老位置
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"></span>		x = (<span style="color:#000;font-weight:bold">*</span>bmap)(<span style="color:#900;font-weight:bold">add</span>(h.buckets, oldbucket<span style="color:#000;font-weight:bold">*</span><span style="color:#0086b3">uintptr</span>(t.bucketsize)))
</span></span><span style="display:flex;"><span>		xi = <span style="color:#099">0</span>
</span></span><span style="display:flex;"><span>		xk = <span style="color:#900;font-weight:bold">add</span>(unsafe.<span style="color:#900;font-weight:bold">Pointer</span>(x), dataOffset)
</span></span><span style="display:flex;"><span>		xv = <span style="color:#900;font-weight:bold">add</span>(xk, bucketCnt<span style="color:#000;font-weight:bold">*</span><span style="color:#0086b3">uintptr</span>(t.keysize))
</span></span><span style="display:flex;"><span>		<span style="color:#000;font-weight:bold">if</span> !h.<span style="color:#900;font-weight:bold">sameSizeGrow</span>() {
</span></span><span style="display:flex;"><span>			<span style="color:#998;font-style:italic">//真正扩容增长，y指向新桶数组的新位置
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"></span>			<span style="color:#998;font-style:italic">//和老位置的区别就是差newbit的个数
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"></span>			<span style="color:#998;font-style:italic">//按照取桶地址的方法，新B比老B多1位，也就是新的地址下标比老的下标多看hash值左边一位
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"></span>			y = (<span style="color:#000;font-weight:bold">*</span>bmap)(<span style="color:#900;font-weight:bold">add</span>(h.buckets, (oldbucket<span style="color:#000;font-weight:bold">+</span>newbit)<span style="color:#000;font-weight:bold">*</span><span style="color:#0086b3">uintptr</span>(t.bucketsize)))
</span></span><span style="display:flex;"><span>			yi = <span style="color:#099">0</span>
</span></span><span style="display:flex;"><span>			yk = <span style="color:#900;font-weight:bold">add</span>(unsafe.<span style="color:#900;font-weight:bold">Pointer</span>(y), dataOffset)
</span></span><span style="display:flex;"><span>			yv = <span style="color:#900;font-weight:bold">add</span>(yk, bucketCnt<span style="color:#000;font-weight:bold">*</span><span style="color:#0086b3">uintptr</span>(t.keysize))
</span></span><span style="display:flex;"><span>		}
</span></span><span style="display:flex;"><span>		<span style="color:#998;font-style:italic">//开始遍历b，进行搬迁
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"></span>		<span style="color:#000;font-weight:bold">for</span> ; b <span style="color:#000;font-weight:bold">!=</span> <span style="color:#000;font-weight:bold">nil</span>; b = b.<span style="color:#900;font-weight:bold">overflow</span>(t) {
</span></span><span style="display:flex;"><span>			k <span style="color:#000;font-weight:bold">:=</span> <span style="color:#900;font-weight:bold">add</span>(unsafe.<span style="color:#900;font-weight:bold">Pointer</span>(b), dataOffset)
</span></span><span style="display:flex;"><span>			v <span style="color:#000;font-weight:bold">:=</span> <span style="color:#900;font-weight:bold">add</span>(k, bucketCnt<span style="color:#000;font-weight:bold">*</span><span style="color:#0086b3">uintptr</span>(t.keysize))
</span></span><span style="display:flex;"><span>			<span style="color:#000;font-weight:bold">for</span> i <span style="color:#000;font-weight:bold">:=</span> <span style="color:#099">0</span>; i &lt; bucketCnt; i, k, v = i<span style="color:#000;font-weight:bold">+</span><span style="color:#099">1</span>, <span style="color:#900;font-weight:bold">add</span>(k, <span style="color:#0086b3">uintptr</span>(t.keysize)), <span style="color:#900;font-weight:bold">add</span>(v, <span style="color:#0086b3">uintptr</span>(t.valuesize)) {
</span></span><span style="display:flex;"><span>				top <span style="color:#000;font-weight:bold">:=</span> b.tophash[i]
</span></span><span style="display:flex;"><span>				<span style="color:#000;font-weight:bold">if</span> top <span style="color:#000;font-weight:bold">==</span> empty {
</span></span><span style="display:flex;"><span>					<span style="color:#998;font-style:italic">//标定搬迁空状态
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"></span>					b.tophash[i] = evacuatedEmpty
</span></span><span style="display:flex;"><span>					<span style="color:#000;font-weight:bold">continue</span>
</span></span><span style="display:flex;"><span>				}
</span></span><span style="display:flex;"><span>				<span style="color:#998;font-style:italic">//理论上不会出现小于minTopHash的值
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"></span>				<span style="color:#000;font-weight:bold">if</span> top &lt; minTopHash {
</span></span><span style="display:flex;"><span>					<span style="color:#900;font-weight:bold">throw</span>(<span style="color:#d14">&#34;bad map state&#34;</span>)
</span></span><span style="display:flex;"><span>				}
</span></span><span style="display:flex;"><span>				k2 <span style="color:#000;font-weight:bold">:=</span> k
</span></span><span style="display:flex;"><span>				<span style="color:#000;font-weight:bold">if</span> t.indirectkey {
</span></span><span style="display:flex;"><span>					k2 = <span style="color:#000;font-weight:bold">*</span>((<span style="color:#000;font-weight:bold">*</span>unsafe.Pointer)(k2))
</span></span><span style="display:flex;"><span>				}
</span></span><span style="display:flex;"><span>				useX <span style="color:#000;font-weight:bold">:=</span> <span style="color:#000;font-weight:bold">true</span>
</span></span><span style="display:flex;"><span>				<span style="color:#000;font-weight:bold">if</span> !h.<span style="color:#900;font-weight:bold">sameSizeGrow</span>() {
</span></span><span style="display:flex;"><span>					<span style="color:#998;font-style:italic">//计算hash值
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"></span>					hash <span style="color:#000;font-weight:bold">:=</span> alg.<span style="color:#900;font-weight:bold">hash</span>(k2, <span style="color:#0086b3">uintptr</span>(h.hash0))
</span></span><span style="display:flex;"><span>					<span style="color:#998;font-style:italic">//有迭代器访问的时候，这个和迭代器的遍历规则有关联，所以这里会判断
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"></span>					<span style="color:#000;font-weight:bold">if</span> h.flags<span style="color:#000;font-weight:bold">&amp;</span>iterator <span style="color:#000;font-weight:bold">!=</span> <span style="color:#099">0</span> {
</span></span><span style="display:flex;"><span>						<span style="color:#998;font-style:italic">//自己和自己对比，不一致，说明key是浮点NANs
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"></span>						<span style="color:#000;font-weight:bold">if</span> !t.reflexivekey <span style="color:#000;font-weight:bold">&amp;&amp;</span> !alg.<span style="color:#900;font-weight:bold">equal</span>(k2, k2) {
</span></span><span style="display:flex;"><span>							<span style="color:#998;font-style:italic">//看旧桶的top值最后一位
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"></span>							<span style="color:#000;font-weight:bold">if</span> top<span style="color:#000;font-weight:bold">&amp;</span><span style="color:#099">1</span> <span style="color:#000;font-weight:bold">!=</span> <span style="color:#099">0</span> {
</span></span><span style="display:flex;"><span>								<span style="color:#998;font-style:italic">//hash值在新B位置0，即将这个key放到新桶数组中的老位置
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"></span>								hash <span style="color:#000;font-weight:bold">|=</span> newbit
</span></span><span style="display:flex;"><span>							} <span style="color:#000;font-weight:bold">else</span> {
</span></span><span style="display:flex;"><span>								<span style="color:#998;font-style:italic">//放到新位置
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"></span>								hash <span style="color:#000;font-weight:bold">&amp;^=</span> newbit
</span></span><span style="display:flex;"><span>							}
</span></span><span style="display:flex;"><span>							<span style="color:#998;font-style:italic">//记录新的top值
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"></span>							top = <span style="color:#0086b3">uint8</span>(hash <span style="color:#000;font-weight:bold">&gt;&gt;</span> (sys.PtrSize<span style="color:#000;font-weight:bold">*</span><span style="color:#099">8</span> <span style="color:#000;font-weight:bold">-</span> <span style="color:#099">8</span>))
</span></span><span style="display:flex;"><span>							<span style="color:#998;font-style:italic">//top修正
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"></span>							<span style="color:#000;font-weight:bold">if</span> top &lt; minTopHash {
</span></span><span style="display:flex;"><span>								top <span style="color:#000;font-weight:bold">+=</span> minTopHash
</span></span><span style="display:flex;"><span>							}
</span></span><span style="display:flex;"><span>						}
</span></span><span style="display:flex;"><span>					}
</span></span><span style="display:flex;"><span>					<span style="color:#998;font-style:italic">//判断是是否是0即是否在新桶数组的老位置
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"></span>					useX = hash<span style="color:#000;font-weight:bold">&amp;</span>newbit <span style="color:#000;font-weight:bold">==</span> <span style="color:#099">0</span>
</span></span><span style="display:flex;"><span>				}
</span></span><span style="display:flex;"><span>				<span style="color:#000;font-weight:bold">if</span> useX {
</span></span><span style="display:flex;"><span>					<span style="color:#998;font-style:italic">//老桶中的key的tophash标记位迁移到x，即新桶数组的老位置
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"></span>					b.tophash[i] = evacuatedX
</span></span><span style="display:flex;"><span>					<span style="color:#998;font-style:italic">//xi等于8了，说明这个桶装满了，需要溢出桶
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"></span>					<span style="color:#000;font-weight:bold">if</span> xi <span style="color:#000;font-weight:bold">==</span> bucketCnt {
</span></span><span style="display:flex;"><span>						newx <span style="color:#000;font-weight:bold">:=</span> h.<span style="color:#900;font-weight:bold">newoverflow</span>(t, x)
</span></span><span style="display:flex;"><span>						x = newx
</span></span><span style="display:flex;"><span>						xi = <span style="color:#099">0</span>
</span></span><span style="display:flex;"><span>						xk = <span style="color:#900;font-weight:bold">add</span>(unsafe.<span style="color:#900;font-weight:bold">Pointer</span>(x), dataOffset)
</span></span><span style="display:flex;"><span>						xv = <span style="color:#900;font-weight:bold">add</span>(xk, bucketCnt<span style="color:#000;font-weight:bold">*</span><span style="color:#0086b3">uintptr</span>(t.keysize))
</span></span><span style="display:flex;"><span>					}
</span></span><span style="display:flex;"><span>					<span style="color:#998;font-style:italic">//设定新的tophash
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"></span>					x.tophash[xi] = top
</span></span><span style="display:flex;"><span>					<span style="color:#000;font-weight:bold">if</span> t.indirectkey {
</span></span><span style="display:flex;"><span>						<span style="color:#000;font-weight:bold">*</span>(<span style="color:#000;font-weight:bold">*</span>unsafe.Pointer)(xk) = k2
</span></span><span style="display:flex;"><span>					} <span style="color:#000;font-weight:bold">else</span> {
</span></span><span style="display:flex;"><span>						<span style="color:#900;font-weight:bold">typedmemmove</span>(t.key, xk, k)
</span></span><span style="display:flex;"><span>					}
</span></span><span style="display:flex;"><span>					<span style="color:#000;font-weight:bold">if</span> t.indirectvalue {
</span></span><span style="display:flex;"><span>						<span style="color:#000;font-weight:bold">*</span>(<span style="color:#000;font-weight:bold">*</span>unsafe.Pointer)(xv) = <span style="color:#000;font-weight:bold">*</span>(<span style="color:#000;font-weight:bold">*</span>unsafe.Pointer)(v)
</span></span><span style="display:flex;"><span>					} <span style="color:#000;font-weight:bold">else</span> {
</span></span><span style="display:flex;"><span>						<span style="color:#900;font-weight:bold">typedmemmove</span>(t.elem, xv, v)
</span></span><span style="display:flex;"><span>					}
</span></span><span style="display:flex;"><span>					<span style="color:#998;font-style:italic">//下一个
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"></span>					xi<span style="color:#000;font-weight:bold">++</span>
</span></span><span style="display:flex;"><span>					xk = <span style="color:#900;font-weight:bold">add</span>(xk, <span style="color:#0086b3">uintptr</span>(t.keysize))
</span></span><span style="display:flex;"><span>					xv = <span style="color:#900;font-weight:bold">add</span>(xv, <span style="color:#0086b3">uintptr</span>(t.valuesize))
</span></span><span style="display:flex;"><span>				} <span style="color:#000;font-weight:bold">else</span> {
</span></span><span style="display:flex;"><span>					<span style="color:#998;font-style:italic">//同上，只是把key放在新桶数组中的新位置
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"></span>					b.tophash[i] = evacuatedY
</span></span><span style="display:flex;"><span>					<span style="color:#000;font-weight:bold">if</span> yi <span style="color:#000;font-weight:bold">==</span> bucketCnt {
</span></span><span style="display:flex;"><span>						newy <span style="color:#000;font-weight:bold">:=</span> h.<span style="color:#900;font-weight:bold">newoverflow</span>(t, y)
</span></span><span style="display:flex;"><span>						y = newy
</span></span><span style="display:flex;"><span>						yi = <span style="color:#099">0</span>
</span></span><span style="display:flex;"><span>						yk = <span style="color:#900;font-weight:bold">add</span>(unsafe.<span style="color:#900;font-weight:bold">Pointer</span>(y), dataOffset)
</span></span><span style="display:flex;"><span>						yv = <span style="color:#900;font-weight:bold">add</span>(yk, bucketCnt<span style="color:#000;font-weight:bold">*</span><span style="color:#0086b3">uintptr</span>(t.keysize))
</span></span><span style="display:flex;"><span>					}
</span></span><span style="display:flex;"><span>					y.tophash[yi] = top
</span></span><span style="display:flex;"><span>					<span style="color:#000;font-weight:bold">if</span> t.indirectkey {
</span></span><span style="display:flex;"><span>						<span style="color:#000;font-weight:bold">*</span>(<span style="color:#000;font-weight:bold">*</span>unsafe.Pointer)(yk) = k2
</span></span><span style="display:flex;"><span>					} <span style="color:#000;font-weight:bold">else</span> {
</span></span><span style="display:flex;"><span>						<span style="color:#900;font-weight:bold">typedmemmove</span>(t.key, yk, k)
</span></span><span style="display:flex;"><span>					}
</span></span><span style="display:flex;"><span>					<span style="color:#000;font-weight:bold">if</span> t.indirectvalue {
</span></span><span style="display:flex;"><span>						<span style="color:#000;font-weight:bold">*</span>(<span style="color:#000;font-weight:bold">*</span>unsafe.Pointer)(yv) = <span style="color:#000;font-weight:bold">*</span>(<span style="color:#000;font-weight:bold">*</span>unsafe.Pointer)(v)
</span></span><span style="display:flex;"><span>					} <span style="color:#000;font-weight:bold">else</span> {
</span></span><span style="display:flex;"><span>						<span style="color:#900;font-weight:bold">typedmemmove</span>(t.elem, yv, v)
</span></span><span style="display:flex;"><span>					}
</span></span><span style="display:flex;"><span>					yi<span style="color:#000;font-weight:bold">++</span>
</span></span><span style="display:flex;"><span>					yk = <span style="color:#900;font-weight:bold">add</span>(yk, <span style="color:#0086b3">uintptr</span>(t.keysize))
</span></span><span style="display:flex;"><span>					yv = <span style="color:#900;font-weight:bold">add</span>(yv, <span style="color:#0086b3">uintptr</span>(t.valuesize))
</span></span><span style="display:flex;"><span>				}
</span></span><span style="display:flex;"><span>			}
</span></span><span style="display:flex;"><span>		}
</span></span><span style="display:flex;"><span>		<span style="color:#998;font-style:italic">//判断是否老桶数组还有迭代器在访问
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"></span>		<span style="color:#000;font-weight:bold">if</span> h.flags<span style="color:#000;font-weight:bold">&amp;</span>oldIterator <span style="color:#000;font-weight:bold">==</span> <span style="color:#099">0</span> {
</span></span><span style="display:flex;"><span>			<span style="color:#998;font-style:italic">//没有，则处理一下，帮助gc
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"></span>			b = (<span style="color:#000;font-weight:bold">*</span>bmap)(<span style="color:#900;font-weight:bold">add</span>(h.oldbuckets, oldbucket<span style="color:#000;font-weight:bold">*</span><span style="color:#0086b3">uintptr</span>(t.bucketsize)))
</span></span><span style="display:flex;"><span>			<span style="color:#000;font-weight:bold">if</span> t.bucket.kind<span style="color:#000;font-weight:bold">&amp;</span>kindNoPointers <span style="color:#000;font-weight:bold">==</span> <span style="color:#099">0</span> {
</span></span><span style="display:flex;"><span>				<span style="color:#900;font-weight:bold">memclrHasPointers</span>(<span style="color:#900;font-weight:bold">add</span>(unsafe.<span style="color:#900;font-weight:bold">Pointer</span>(b), dataOffset), <span style="color:#0086b3">uintptr</span>(t.bucketsize)<span style="color:#000;font-weight:bold">-</span>dataOffset)
</span></span><span style="display:flex;"><span>			} <span style="color:#000;font-weight:bold">else</span> {
</span></span><span style="display:flex;"><span>				<span style="color:#900;font-weight:bold">memclrNoHeapPointers</span>(<span style="color:#900;font-weight:bold">add</span>(unsafe.<span style="color:#900;font-weight:bold">Pointer</span>(b), dataOffset), <span style="color:#0086b3">uintptr</span>(t.bucketsize)<span style="color:#000;font-weight:bold">-</span>dataOffset)
</span></span><span style="display:flex;"><span>			}
</span></span><span style="display:flex;"><span>		}
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#998;font-style:italic">//刚好，上面处理的桶是最小未处理桶
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"></span>	<span style="color:#000;font-weight:bold">if</span> oldbucket <span style="color:#000;font-weight:bold">==</span> h.nevacuate {
</span></span><span style="display:flex;"><span>		<span style="color:#998;font-style:italic">//最小未处理桶往后走一位
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"></span>		h.nevacuate = oldbucket <span style="color:#000;font-weight:bold">+</span> <span style="color:#099">1</span>
</span></span><span style="display:flex;"><span>		<span style="color:#998;font-style:italic">//尝试往后判断1024次，看看当前的最小未处理桶是否已经处理了，以及是否有连续的已经处理的桶
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"></span>		<span style="color:#998;font-style:italic">//有的话，就更新这个最小未处理桶下标，让这个数值精确
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"></span>		stop <span style="color:#000;font-weight:bold">:=</span> h.nevacuate <span style="color:#000;font-weight:bold">+</span> <span style="color:#099">1024</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000;font-weight:bold">if</span> stop &gt; newbit {
</span></span><span style="display:flex;"><span>			stop = newbit
</span></span><span style="display:flex;"><span>		}
</span></span><span style="display:flex;"><span>		<span style="color:#000;font-weight:bold">for</span> h.nevacuate <span style="color:#000;font-weight:bold">!=</span> stop <span style="color:#000;font-weight:bold">&amp;&amp;</span> <span style="color:#900;font-weight:bold">bucketEvacuated</span>(t, h, h.nevacuate) {
</span></span><span style="display:flex;"><span>			h.nevacuate<span style="color:#000;font-weight:bold">++</span>
</span></span><span style="display:flex;"><span>		}
</span></span><span style="display:flex;"><span>		<span style="color:#998;font-style:italic">//已经处理完了
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"></span>		<span style="color:#000;font-weight:bold">if</span> h.nevacuate <span style="color:#000;font-weight:bold">==</span> newbit {
</span></span><span style="display:flex;"><span>			<span style="color:#998;font-style:italic">//oldbuckets指向空
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"></span>			h.oldbuckets = <span style="color:#000;font-weight:bold">nil</span>
</span></span><span style="display:flex;"><span>			<span style="color:#998;font-style:italic">//指向空，让gc处理
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"></span>			<span style="color:#000;font-weight:bold">if</span> h.extra <span style="color:#000;font-weight:bold">!=</span> <span style="color:#000;font-weight:bold">nil</span> {
</span></span><span style="display:flex;"><span>				h.extra.overflow[<span style="color:#099">1</span>] = <span style="color:#000;font-weight:bold">nil</span>
</span></span><span style="display:flex;"><span>			}
</span></span><span style="display:flex;"><span>			<span style="color:#998;font-style:italic">//标志位清空
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"></span>			h.flags <span style="color:#000;font-weight:bold">&amp;^=</span> sameSizeGrow
</span></span><span style="display:flex;"><span>		}
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></td></tr></table>
</div>
</div><h4 id="map遍历">map遍历</h4>
<div class="highlight"><div style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">  1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">  2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">  3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">  4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">  5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">  6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">  7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">  8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">  9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 16
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 17
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 18
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 19
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 20
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 21
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 22
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 23
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 24
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 25
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 26
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 27
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 28
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 29
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 30
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 31
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 32
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 33
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 34
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 35
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 36
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 37
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 38
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 39
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 40
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 41
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 42
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 43
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 44
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 45
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 46
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 47
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 48
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 49
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 50
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 51
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 52
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 53
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 54
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 55
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 56
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 57
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 58
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 59
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 60
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 61
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 62
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 63
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 64
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 65
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 66
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 67
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 68
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 69
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 70
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 71
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 72
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 73
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 74
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 75
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 76
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 77
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 78
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 79
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 80
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 81
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 82
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 83
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 84
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 85
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 86
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 87
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 88
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 89
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 90
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 91
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 92
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 93
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 94
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 95
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 96
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 97
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 98
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 99
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">100
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">101
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">102
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">103
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">104
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">105
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">106
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">107
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">108
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">109
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">110
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">111
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">112
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">113
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">114
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">115
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">116
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">117
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">118
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">119
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">120
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">121
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">122
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">123
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">124
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">125
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">126
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">127
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">128
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">129
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">130
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">131
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">132
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">133
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">134
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">135
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">136
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">137
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">138
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">139
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">140
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">141
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">142
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">143
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">144
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">145
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">146
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">147
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">148
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">149
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">150
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">151
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">152
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">153
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">154
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">155
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">156
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">157
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">158
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">159
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">160
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">161
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">162
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">163
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">164
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">165
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">166
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">167
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">168
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">169
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">170
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">171
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">172
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">173
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">174
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">175
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">176
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">177
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">178
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">179
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">180
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">181
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">182
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">183
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">184
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">185
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">186
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">187
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">188
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">189
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">190
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">191
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">192
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">193
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">194
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">195
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">196
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">197
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">198
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">199
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#998;font-style:italic">//for range遍历的时候，先调用这个函数初始化一下迭代器
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"></span><span style="color:#000;font-weight:bold">func</span> <span style="color:#900;font-weight:bold">mapiterinit</span>(t <span style="color:#000;font-weight:bold">*</span>maptype, h <span style="color:#000;font-weight:bold">*</span>hmap, it <span style="color:#000;font-weight:bold">*</span>hiter) {
</span></span><span style="display:flex;"><span>	it.key = <span style="color:#000;font-weight:bold">nil</span>
</span></span><span style="display:flex;"><span>	it.value = <span style="color:#000;font-weight:bold">nil</span>
</span></span><span style="display:flex;"><span>	it.t = <span style="color:#000;font-weight:bold">nil</span>
</span></span><span style="display:flex;"><span>	it.h = <span style="color:#000;font-weight:bold">nil</span>
</span></span><span style="display:flex;"><span>	it.buckets = <span style="color:#000;font-weight:bold">nil</span>
</span></span><span style="display:flex;"><span>	it.bptr = <span style="color:#000;font-weight:bold">nil</span>
</span></span><span style="display:flex;"><span>	it.overflow[<span style="color:#099">0</span>] = <span style="color:#000;font-weight:bold">nil</span>
</span></span><span style="display:flex;"><span>	it.overflow[<span style="color:#099">1</span>] = <span style="color:#000;font-weight:bold">nil</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#998;font-style:italic">//废弃代码?
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"></span>	<span style="color:#000;font-weight:bold">...</span>
</span></span><span style="display:flex;"><span>	<span style="color:#998;font-style:italic">//map空，或大小为0返回
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"></span>	<span style="color:#000;font-weight:bold">if</span> h <span style="color:#000;font-weight:bold">==</span> <span style="color:#000;font-weight:bold">nil</span> <span style="color:#000;font-weight:bold">||</span> h.count <span style="color:#000;font-weight:bold">==</span> <span style="color:#099">0</span> {
</span></span><span style="display:flex;"><span>		it.key = <span style="color:#000;font-weight:bold">nil</span>
</span></span><span style="display:flex;"><span>		it.value = <span style="color:#000;font-weight:bold">nil</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000;font-weight:bold">return</span>
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#998;font-style:italic">//检测
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"></span>	<span style="color:#000;font-weight:bold">if</span> unsafe.<span style="color:#900;font-weight:bold">Sizeof</span>(hiter{})<span style="color:#000;font-weight:bold">/</span>sys.PtrSize <span style="color:#000;font-weight:bold">!=</span> <span style="color:#099">12</span> {
</span></span><span style="display:flex;"><span>		<span style="color:#900;font-weight:bold">throw</span>(<span style="color:#d14">&#34;hash_iter size incorrect&#34;</span>) 
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>	it.t = t
</span></span><span style="display:flex;"><span>	it.h = h
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#998;font-style:italic">//记录当前map的B值
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"></span>	it.B = h.B
</span></span><span style="display:flex;"><span>	<span style="color:#998;font-style:italic">//记录当前桶数组地址
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"></span>	it.buckets = h.buckets
</span></span><span style="display:flex;"><span>	<span style="color:#000;font-weight:bold">if</span> t.bucket.kind<span style="color:#000;font-weight:bold">&amp;</span>kindNoPointers <span style="color:#000;font-weight:bold">!=</span> <span style="color:#099">0</span> {
</span></span><span style="display:flex;"><span>		<span style="color:#998;font-style:italic">//map不包含指针，则溢出桶地址在overflow中
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"></span>		h.<span style="color:#900;font-weight:bold">createOverflow</span>()
</span></span><span style="display:flex;"><span>		it.overflow = h.extra.overflow
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#998;font-style:italic">//随机一个开始桶下标,以及桶内开始的下标
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"></span>	<span style="color:#998;font-style:italic">//所以map的遍历结果是变化的
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"></span>	r <span style="color:#000;font-weight:bold">:=</span> <span style="color:#0086b3">uintptr</span>(<span style="color:#900;font-weight:bold">fastrand</span>())
</span></span><span style="display:flex;"><span>	<span style="color:#000;font-weight:bold">if</span> h.B &gt; <span style="color:#099">31</span><span style="color:#000;font-weight:bold">-</span>bucketCntBits {
</span></span><span style="display:flex;"><span>		r <span style="color:#000;font-weight:bold">+=</span> <span style="color:#0086b3">uintptr</span>(<span style="color:#900;font-weight:bold">fastrand</span>()) <span style="color:#000;font-weight:bold">&lt;&lt;</span> <span style="color:#099">31</span>
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>	it.startBucket = r <span style="color:#000;font-weight:bold">&amp;</span> (<span style="color:#0086b3">uintptr</span>(<span style="color:#099">1</span>)<span style="color:#000;font-weight:bold">&lt;&lt;</span>h.B <span style="color:#000;font-weight:bold">-</span> <span style="color:#099">1</span>)
</span></span><span style="display:flex;"><span>	it.offset = <span style="color:#0086b3">uint8</span>(r <span style="color:#000;font-weight:bold">&gt;&gt;</span> h.B <span style="color:#000;font-weight:bold">&amp;</span> (bucketCnt <span style="color:#000;font-weight:bold">-</span> <span style="color:#099">1</span>))
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	it.bucket = it.startBucket
</span></span><span style="display:flex;"><span>	<span style="color:#998;font-style:italic">//判断是否已经走了一圈的标记
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"></span>	it.wrapped = <span style="color:#000;font-weight:bold">false</span>
</span></span><span style="display:flex;"><span>	it.bptr = <span style="color:#000;font-weight:bold">nil</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#998;font-style:italic">//不太懂，留坑，好像是允许多个迭代器同时遍历map
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"></span>	<span style="color:#000;font-weight:bold">if</span> old <span style="color:#000;font-weight:bold">:=</span> h.flags; old<span style="color:#000;font-weight:bold">&amp;</span>(iterator|oldIterator) <span style="color:#000;font-weight:bold">!=</span> iterator|oldIterator {
</span></span><span style="display:flex;"><span>		atomic.<span style="color:#900;font-weight:bold">Or8</span>(<span style="color:#000;font-weight:bold">&amp;</span>h.flags, iterator|oldIterator)
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>	<span style="color:#998;font-style:italic">//遍历第一个元素
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"></span>	<span style="color:#900;font-weight:bold">mapiternext</span>(it)
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">func</span> <span style="color:#900;font-weight:bold">mapiternext</span>(it <span style="color:#000;font-weight:bold">*</span>hiter) {
</span></span><span style="display:flex;"><span>	h <span style="color:#000;font-weight:bold">:=</span> it.h
</span></span><span style="display:flex;"><span>	<span style="color:#998;font-style:italic">//废弃代码？
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"></span>	<span style="color:#000;font-weight:bold">...</span>
</span></span><span style="display:flex;"><span>	<span style="color:#998;font-style:italic">//不允许同时读写
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"></span>	<span style="color:#000;font-weight:bold">if</span> h.flags<span style="color:#000;font-weight:bold">&amp;</span>hashWriting <span style="color:#000;font-weight:bold">!=</span> <span style="color:#099">0</span> {
</span></span><span style="display:flex;"><span>		<span style="color:#900;font-weight:bold">throw</span>(<span style="color:#d14">&#34;concurrent map iteration and map write&#34;</span>)
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>	t <span style="color:#000;font-weight:bold">:=</span> it.t
</span></span><span style="display:flex;"><span>	<span style="color:#998;font-style:italic">//记录当前遍历桶下标
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"></span>	bucket <span style="color:#000;font-weight:bold">:=</span> it.bucket
</span></span><span style="display:flex;"><span>	<span style="color:#998;font-style:italic">//记录当前遍历桶地址
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"></span>	b <span style="color:#000;font-weight:bold">:=</span> it.bptr
</span></span><span style="display:flex;"><span>	<span style="color:#998;font-style:italic">//记录桶内下标
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"></span>	i <span style="color:#000;font-weight:bold">:=</span> it.i
</span></span><span style="display:flex;"><span>	<span style="color:#998;font-style:italic">//记录是否要检测新桶
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"></span>	checkBucket <span style="color:#000;font-weight:bold">:=</span> it.checkBucket
</span></span><span style="display:flex;"><span>	alg <span style="color:#000;font-weight:bold">:=</span> t.key.alg
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>next:
</span></span><span style="display:flex;"><span>	<span style="color:#000;font-weight:bold">if</span> b <span style="color:#000;font-weight:bold">==</span> <span style="color:#000;font-weight:bold">nil</span> {
</span></span><span style="display:flex;"><span>		<span style="color:#998;font-style:italic">//刚开始，或者结束了
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"></span>		<span style="color:#998;font-style:italic">//走了一圈了，bucket又等于开始的下标，则表示已经遍历结束了
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"></span>		<span style="color:#000;font-weight:bold">if</span> bucket <span style="color:#000;font-weight:bold">==</span> it.startBucket <span style="color:#000;font-weight:bold">&amp;&amp;</span> it.wrapped {
</span></span><span style="display:flex;"><span>			it.key = <span style="color:#000;font-weight:bold">nil</span>
</span></span><span style="display:flex;"><span>			it.value = <span style="color:#000;font-weight:bold">nil</span>
</span></span><span style="display:flex;"><span>			<span style="color:#000;font-weight:bold">return</span>
</span></span><span style="display:flex;"><span>		}
</span></span><span style="display:flex;"><span>		<span style="color:#000;font-weight:bold">if</span> h.<span style="color:#900;font-weight:bold">growing</span>() <span style="color:#000;font-weight:bold">&amp;&amp;</span> it.B <span style="color:#000;font-weight:bold">==</span> h.B {
</span></span><span style="display:flex;"><span>			<span style="color:#998;font-style:italic">//当前map已经处在扩容阶段，但迭代器记录的B和map现在的B一样
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"></span>			<span style="color:#998;font-style:italic">//说明，迭代器是扩容阶段初始化的
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"></span>			oldbucket <span style="color:#000;font-weight:bold">:=</span> bucket <span style="color:#000;font-weight:bold">&amp;</span> it.h.<span style="color:#900;font-weight:bold">oldbucketmask</span>()
</span></span><span style="display:flex;"><span>			<span style="color:#998;font-style:italic">//b为老桶数组的相关地址
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"></span>			b = (<span style="color:#000;font-weight:bold">*</span>bmap)(<span style="color:#900;font-weight:bold">add</span>(h.oldbuckets, oldbucket<span style="color:#000;font-weight:bold">*</span><span style="color:#0086b3">uintptr</span>(t.bucketsize)))
</span></span><span style="display:flex;"><span>			<span style="color:#998;font-style:italic">//看是否已经搬迁了
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"></span>			<span style="color:#000;font-weight:bold">if</span> !<span style="color:#900;font-weight:bold">evacuated</span>(b) {
</span></span><span style="display:flex;"><span>				<span style="color:#998;font-style:italic">//还没有搬迁，则我们要遍历的数据还在老桶数组对应下标的桶内
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"></span>				<span style="color:#998;font-style:italic">//但老桶的数据不一定全是新桶数组的一样下标，需要判断这个值以后是不是会在我们当前遍历桶下标
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"></span>				<span style="color:#998;font-style:italic">//因此，记录需要检测的下标
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"></span>				checkBucket = bucket
</span></span><span style="display:flex;"><span>			} <span style="color:#000;font-weight:bold">else</span> {
</span></span><span style="display:flex;"><span>				<span style="color:#998;font-style:italic">//已经搬迁了，则遍历新桶数组对应的bucket下标桶数据
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"></span>				b = (<span style="color:#000;font-weight:bold">*</span>bmap)(<span style="color:#900;font-weight:bold">add</span>(it.buckets, bucket<span style="color:#000;font-weight:bold">*</span><span style="color:#0086b3">uintptr</span>(t.bucketsize)))
</span></span><span style="display:flex;"><span>				checkBucket = noCheck
</span></span><span style="display:flex;"><span>			}
</span></span><span style="display:flex;"><span>		} <span style="color:#000;font-weight:bold">else</span> {
</span></span><span style="display:flex;"><span>			<span style="color:#998;font-style:italic">//情况1.迭代器是扩容前初始化的，处理直接遍历老桶数组，因为迭代器标准位的存在，老桶数组不会被清空
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"></span>			<span style="color:#998;font-style:italic">//情况2.map没有扩容，正常遍历桶数组
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"></span>			b = (<span style="color:#000;font-weight:bold">*</span>bmap)(<span style="color:#900;font-weight:bold">add</span>(it.buckets, bucket<span style="color:#000;font-weight:bold">*</span><span style="color:#0086b3">uintptr</span>(t.bucketsize)))
</span></span><span style="display:flex;"><span>			<span style="color:#998;font-style:italic">//上面情况都不会存在需要检测的桶
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"></span>			checkBucket = noCheck
</span></span><span style="display:flex;"><span>		}
</span></span><span style="display:flex;"><span>		<span style="color:#998;font-style:italic">//bucket下一个，后续遍历准备
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"></span>		bucket<span style="color:#000;font-weight:bold">++</span>
</span></span><span style="display:flex;"><span>		<span style="color:#998;font-style:italic">//到头了，从0开始，并且循环标记为true
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"></span>		<span style="color:#000;font-weight:bold">if</span> bucket <span style="color:#000;font-weight:bold">==</span> <span style="color:#0086b3">uintptr</span>(<span style="color:#099">1</span>)<span style="color:#000;font-weight:bold">&lt;&lt;</span>it.B {
</span></span><span style="display:flex;"><span>			bucket = <span style="color:#099">0</span>
</span></span><span style="display:flex;"><span>			it.wrapped = <span style="color:#000;font-weight:bold">true</span>
</span></span><span style="display:flex;"><span>		}
</span></span><span style="display:flex;"><span>		<span style="color:#998;font-style:italic">//桶内遍历个数置0
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"></span>		i = <span style="color:#099">0</span>
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>	<span style="color:#000;font-weight:bold">for</span> ; i &lt; bucketCnt; i<span style="color:#000;font-weight:bold">++</span> {
</span></span><span style="display:flex;"><span>		<span style="color:#998;font-style:italic">//offi 桶内随机开始下标的快速定位
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"></span>		offi <span style="color:#000;font-weight:bold">:=</span> (i <span style="color:#000;font-weight:bold">+</span> it.offset) <span style="color:#000;font-weight:bold">&amp;</span> (bucketCnt <span style="color:#000;font-weight:bold">-</span> <span style="color:#099">1</span>)
</span></span><span style="display:flex;"><span>		k <span style="color:#000;font-weight:bold">:=</span> <span style="color:#900;font-weight:bold">add</span>(unsafe.<span style="color:#900;font-weight:bold">Pointer</span>(b), dataOffset<span style="color:#000;font-weight:bold">+</span><span style="color:#0086b3">uintptr</span>(offi)<span style="color:#000;font-weight:bold">*</span><span style="color:#0086b3">uintptr</span>(t.keysize))
</span></span><span style="display:flex;"><span>		v <span style="color:#000;font-weight:bold">:=</span> <span style="color:#900;font-weight:bold">add</span>(unsafe.<span style="color:#900;font-weight:bold">Pointer</span>(b), dataOffset<span style="color:#000;font-weight:bold">+</span>bucketCnt<span style="color:#000;font-weight:bold">*</span><span style="color:#0086b3">uintptr</span>(t.keysize)<span style="color:#000;font-weight:bold">+</span><span style="color:#0086b3">uintptr</span>(offi)<span style="color:#000;font-weight:bold">*</span><span style="color:#0086b3">uintptr</span>(t.valuesize))
</span></span><span style="display:flex;"><span>		<span style="color:#998;font-style:italic">//tophash为空，则跳过
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"></span>		<span style="color:#000;font-weight:bold">if</span> b.tophash[offi] <span style="color:#000;font-weight:bold">!=</span> empty <span style="color:#000;font-weight:bold">&amp;&amp;</span> b.tophash[offi] <span style="color:#000;font-weight:bold">!=</span> evacuatedEmpty {
</span></span><span style="display:flex;"><span>			<span style="color:#000;font-weight:bold">if</span> checkBucket <span style="color:#000;font-weight:bold">!=</span> noCheck <span style="color:#000;font-weight:bold">&amp;&amp;</span> !h.<span style="color:#900;font-weight:bold">sameSizeGrow</span>() {
</span></span><span style="display:flex;"><span>				<span style="color:#998;font-style:italic">//是扩大一倍增长的，并且需要检测桶
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"></span>				k2 <span style="color:#000;font-weight:bold">:=</span> k
</span></span><span style="display:flex;"><span>				<span style="color:#000;font-weight:bold">if</span> t.indirectkey {
</span></span><span style="display:flex;"><span>					k2 = <span style="color:#000;font-weight:bold">*</span>((<span style="color:#000;font-weight:bold">*</span>unsafe.Pointer)(k2))
</span></span><span style="display:flex;"><span>				}
</span></span><span style="display:flex;"><span>				<span style="color:#000;font-weight:bold">if</span> t.reflexivekey <span style="color:#000;font-weight:bold">||</span> alg.<span style="color:#900;font-weight:bold">equal</span>(k2, k2) {
</span></span><span style="display:flex;"><span>					<span style="color:#998;font-style:italic">//是正常key，但hash取得的桶下标不是目前需要的，则跳过
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"></span>					<span style="color:#998;font-style:italic">//说明这个key以后会去新的下标桶
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"></span>					hash <span style="color:#000;font-weight:bold">:=</span> alg.<span style="color:#900;font-weight:bold">hash</span>(k2, <span style="color:#0086b3">uintptr</span>(h.hash0))
</span></span><span style="display:flex;"><span>					<span style="color:#000;font-weight:bold">if</span> hash<span style="color:#000;font-weight:bold">&amp;</span>(<span style="color:#0086b3">uintptr</span>(<span style="color:#099">1</span>)<span style="color:#000;font-weight:bold">&lt;&lt;</span>it.B<span style="color:#000;font-weight:bold">-</span><span style="color:#099">1</span>) <span style="color:#000;font-weight:bold">!=</span> checkBucket {
</span></span><span style="display:flex;"><span>						<span style="color:#000;font-weight:bold">continue</span>
</span></span><span style="display:flex;"><span>					}
</span></span><span style="display:flex;"><span>				} <span style="color:#000;font-weight:bold">else</span> {
</span></span><span style="display:flex;"><span>					<span style="color:#998;font-style:italic">//特殊值nan的处理，我们是看tophash的最后一位，是否是1，来决定搬迁去向的
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"></span>					<span style="color:#998;font-style:italic">//因此，这个这次也这么判断，看这个key是否会在checkBucket下标的桶
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"></span>					<span style="color:#000;font-weight:bold">if</span> checkBucket<span style="color:#000;font-weight:bold">&gt;&gt;</span>(it.B<span style="color:#000;font-weight:bold">-</span><span style="color:#099">1</span>) <span style="color:#000;font-weight:bold">!=</span> <span style="color:#0086b3">uintptr</span>(b.tophash[offi]<span style="color:#000;font-weight:bold">&amp;</span><span style="color:#099">1</span>) {
</span></span><span style="display:flex;"><span>						<span style="color:#000;font-weight:bold">continue</span>
</span></span><span style="display:flex;"><span>					}
</span></span><span style="display:flex;"><span>				}
</span></span><span style="display:flex;"><span>			}
</span></span><span style="display:flex;"><span>			<span style="color:#998;font-style:italic">//如果tophash不是特殊标记
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"></span>			<span style="color:#000;font-weight:bold">if</span> b.tophash[offi] <span style="color:#000;font-weight:bold">!=</span> evacuatedX <span style="color:#000;font-weight:bold">&amp;&amp;</span> b.tophash[offi] <span style="color:#000;font-weight:bold">!=</span> evacuatedY {
</span></span><span style="display:flex;"><span>				<span style="color:#998;font-style:italic">//黄金数据，直接返回
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"></span>				<span style="color:#000;font-weight:bold">if</span> t.indirectkey {
</span></span><span style="display:flex;"><span>					k = <span style="color:#000;font-weight:bold">*</span>((<span style="color:#000;font-weight:bold">*</span>unsafe.Pointer)(k))
</span></span><span style="display:flex;"><span>				}
</span></span><span style="display:flex;"><span>				it.key = k
</span></span><span style="display:flex;"><span>				<span style="color:#000;font-weight:bold">if</span> t.indirectvalue {
</span></span><span style="display:flex;"><span>					v = <span style="color:#000;font-weight:bold">*</span>((<span style="color:#000;font-weight:bold">*</span>unsafe.Pointer)(v))
</span></span><span style="display:flex;"><span>				}
</span></span><span style="display:flex;"><span>				it.value = v
</span></span><span style="display:flex;"><span>			} <span style="color:#000;font-weight:bold">else</span> {
</span></span><span style="display:flex;"><span>				<span style="color:#998;font-style:italic">//有特殊标记，则说明这个被搬迁了
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"></span>				<span style="color:#998;font-style:italic">//因为map只有读互斥，所以我们需要去找一下这个key
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"></span>				<span style="color:#998;font-style:italic">//看是不是还存在
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"></span>				k2 <span style="color:#000;font-weight:bold">:=</span> k
</span></span><span style="display:flex;"><span>				<span style="color:#000;font-weight:bold">if</span> t.indirectkey {
</span></span><span style="display:flex;"><span>					k2 = <span style="color:#000;font-weight:bold">*</span>((<span style="color:#000;font-weight:bold">*</span>unsafe.Pointer)(k2))
</span></span><span style="display:flex;"><span>				}
</span></span><span style="display:flex;"><span>				<span style="color:#000;font-weight:bold">if</span> t.reflexivekey <span style="color:#000;font-weight:bold">||</span> alg.<span style="color:#900;font-weight:bold">equal</span>(k2, k2) {
</span></span><span style="display:flex;"><span>					rk, rv <span style="color:#000;font-weight:bold">:=</span> <span style="color:#900;font-weight:bold">mapaccessK</span>(t, h, k2)
</span></span><span style="display:flex;"><span>					<span style="color:#000;font-weight:bold">if</span> rk <span style="color:#000;font-weight:bold">==</span> <span style="color:#000;font-weight:bold">nil</span> {
</span></span><span style="display:flex;"><span>						<span style="color:#000;font-weight:bold">continue</span> <span style="color:#998;font-style:italic">// key has been deleted
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"></span>					}
</span></span><span style="display:flex;"><span>					it.key = rk
</span></span><span style="display:flex;"><span>					it.value = rv
</span></span><span style="display:flex;"><span>				} <span style="color:#000;font-weight:bold">else</span> {
</span></span><span style="display:flex;"><span>					<span style="color:#998;font-style:italic">//特殊的NANs的键值，不可能找到的，因此直接返回
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"></span>					it.key = k2
</span></span><span style="display:flex;"><span>					<span style="color:#000;font-weight:bold">if</span> t.indirectvalue {
</span></span><span style="display:flex;"><span>						v = <span style="color:#000;font-weight:bold">*</span>((<span style="color:#000;font-weight:bold">*</span>unsafe.Pointer)(v))
</span></span><span style="display:flex;"><span>					}
</span></span><span style="display:flex;"><span>					it.value = v
</span></span><span style="display:flex;"><span>				}
</span></span><span style="display:flex;"><span>			}
</span></span><span style="display:flex;"><span>			<span style="color:#998;font-style:italic">//找到一个数据了，相关字段写入迭代器，方便下一次迭代
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"></span>			it.bucket = bucket
</span></span><span style="display:flex;"><span>			<span style="color:#000;font-weight:bold">if</span> it.bptr <span style="color:#000;font-weight:bold">!=</span> b { 
</span></span><span style="display:flex;"><span>				it.bptr = b
</span></span><span style="display:flex;"><span>			}
</span></span><span style="display:flex;"><span>			it.i = i <span style="color:#000;font-weight:bold">+</span> <span style="color:#099">1</span>
</span></span><span style="display:flex;"><span>			it.checkBucket = checkBucket
</span></span><span style="display:flex;"><span>			<span style="color:#000;font-weight:bold">return</span>
</span></span><span style="display:flex;"><span>		}
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>	<span style="color:#998;font-style:italic">//这个桶没有数据，看看溢出桶
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"></span>	b = b.<span style="color:#900;font-weight:bold">overflow</span>(t)
</span></span><span style="display:flex;"><span>	i = <span style="color:#099">0</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000;font-weight:bold">goto</span> next
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></td></tr></table>
</div>
</div><h3 id="参考">参考</h3>
<ol>
<li><a href="https://juejin.im/post/5ce4dd5ae51d4558936a9fde?utm_source=gold_browser_extension">深度解密Go语言之map</a></li>
<li><a href="https://github.com/cch123/golang-notes/blob/master/map.md">map解析</a></li>
</ol>

        </div>

        


        

<div class="post-archive">
    <h2>相关文章</h2>
    <ul class="listing">
        
        <li><a href="/blog/post/2020-03-13-%E4%BA%8C%E5%8F%89%E5%B9%B3%E8%A1%A1%E6%A0%91%E6%97%8B%E8%BD%AC/">二叉平衡树旋转</a></li>
        
        <li><a href="/blog/post/2020-03-13-%E4%BA%8C%E5%8F%89%E6%8E%92%E5%BA%8F%E6%A0%91%E8%AF%A6%E6%83%85/">二叉排序树详情</a></li>
        
        <li><a href="/blog/post/2020-03-13-%E7%BA%A2%E9%BB%91%E6%A0%91%E8%AF%A6%E6%83%85/">红黑树详情</a></li>
        
        <li><a href="/blog/post/2020-03-13-%E7%BA%A2%E9%BB%91%E6%A0%91%E5%AE%9E%E7%8E%B0/">红黑树实现</a></li>
        
        <li><a href="/blog/post/2020-03-13-%E6%9F%A5%E5%B9%B6%E9%9B%86/">查并集</a></li>
        
    </ul>
</div>


        <div class="post-meta meta-tags">
            
            没有标签
            
        </div>
    </article>
    
    

    
    
    <div class="post bg-white">
      <script src="https://utteranc.es/client.js"
            repo= "weiweng/blog"
            issue-term="pathname"
            theme="github-light"
            crossorigin="anonymous"
            async>
      </script>
    </div>
    
    
    

</div>

                    <footer id="footer">
    <div>
        &copy; 2023 <a href="https://weiweng.github.io/blog/">weiweng的博客 By weiweng</a>
        
    </div>
    <br />
    <div>
        <div class="github-badge">
            <a href="https://gohugo.io/" target="_black" rel="nofollow"><span class="badge-subject">Powered by</span><span class="badge-value bg-blue">Hugo</span></a>
        </div>
        <div class="github-badge">
            <a href="https://www.flysnow.org/" target="_black"><span class="badge-subject">Design by</span><span class="badge-value bg-brightgreen">飞雪无情</span></a>
        </div>
        <div class="github-badge">
            <a href="https://github.com/flysnow-org/maupassant-hugo" target="_black"><span class="badge-subject">Theme</span><span class="badge-value bg-yellowgreen">Maupassant</span></a>
        </div>
    </div>
</footer>


    
    
    <script type="text/javascript">
        window.MathJax = {
            tex2jax: {
                inlineMath: [['$', '$']],
                processEscapes: true
                }
            };
    </script>
    <script src='//cdn.bootcdn.net/ajax/libs/mathjax/2.7.5/MathJax.js?config=TeX-MML-AM_CHTML' async></script>

<a id="rocket" href="#top"></a>
<script type="text/javascript" src='/blog/js/totop.js?v=0.0.0' async=""></script>
<script async src="https://www.googletagmanager.com/gtag/js?id=G-XYCDHPQC9T"></script>
<script>
var doNotTrack = false;
if (!doNotTrack) {
	window.dataLayer = window.dataLayer || [];
	function gtag(){dataLayer.push(arguments);}
	gtag('js', new Date());
	gtag('config', 'G-XYCDHPQC9T', { 'anonymize_ip': false });
}
</script>

<style type="text/css">
div.highlight {
    position: relative;
    margin: 1em 0px;
}

.copy-code {
    display: none;
    position: absolute;
    top: 4px;
    right: 4px;
    color: rgba(255, 255, 255, 0.8);
    background: rgba(78, 78, 78, 0.8);
    border-radius: var(--radius);
    padding: 0 5px;
    font: inherit;
    user-select: none;
    cursor: pointer;
    border: 0;
    --radius: 8px;
}

div.highlight:hover .copy-code,pre:hover .copy-code {
    display: block;
}

</style>
<script>
    document.querySelectorAll('pre > code').forEach((codeblock) => {
        const container = codeblock.parentNode.parentNode;

        const copybutton = document.createElement('button');
        copybutton.classList.add('copy-code');
        copybutton.innerHTML = 'copy';

        function copyingDone() {
            copybutton.innerHTML = 'copied!';
            setTimeout(() => {
                copybutton.innerHTML = 'copy';
            }, 2000);
        }

        copybutton.addEventListener('click', (cb) => {
            if ('clipboard' in navigator) {
                navigator.clipboard.writeText(codeblock.textContent);
                copyingDone();
                return;
            }

            const range = document.createRange();
            range.selectNodeContents(codeblock);
            const selection = window.getSelection();
            selection.removeAllRanges();
            selection.addRange(range);
            try {
                document.execCommand('copy');
                copyingDone();
            } catch (e) { };
            selection.removeRange(range);
        });

        if (container.classList.contains("highlight")) {
            container.appendChild(copybutton);
        } else if (container.parentNode.firstChild == container) {
            
        } else if (codeblock.parentNode.parentNode.parentNode.parentNode.parentNode.nodeName == "TABLE") {
            
            codeblock.parentNode.parentNode.parentNode.parentNode.parentNode.appendChild(copybutton);
        } else {
            
            codeblock.parentNode.appendChild(copybutton);
        }
    });
</script>





                </div>

                <div id="secondary">
    <section class="widget">
        <form id="search" action='https://weiweng.github.io/blog/search' method="get" accept-charset="utf-8" target="_blank" _lpchecked="1">
      
      <input type="text" name="q" maxlength="20" placeholder="Search">
      <input type="hidden" name="sitesearch" value="https://weiweng.github.io/blog/">
      <button type="submit" class="submit icon-search"></button>
</form>
    </section>

    <section class="widget">
        <h3 class="widget-title">最近文章</h3>
<ul class="widget-list">
    
    <li>
        <a href="https://weiweng.github.io/blog/post/2023-06-16-%E5%8D%95%E8%B0%83%E6%A0%88/" title="算法专题|单调栈" target="_blank">算法专题|单调栈</a>
    </li>
    
    <li>
        <a href="https://weiweng.github.io/blog/post/2023-06-16-%E6%BB%91%E5%8A%A8%E7%AA%97%E5%8F%A3/" title="算法专题|滑动窗口" target="_blank">算法专题|滑动窗口</a>
    </li>
    
    <li>
        <a href="https://weiweng.github.io/blog/post/2023-06-11-%E5%8F%8C%E6%8C%87%E9%92%88/" title="算法专题|双指针" target="_blank">算法专题|双指针</a>
    </li>
    
    <li>
        <a href="https://weiweng.github.io/blog/post/2023-06-11-%E4%BA%8C%E5%88%86%E6%9F%A5%E6%89%BE/" title="算法专题|二分查找" target="_blank">算法专题|二分查找</a>
    </li>
    
    <li>
        <a href="https://weiweng.github.io/blog/post/2023-06-10-%E5%9B%9E%E6%BA%AF/" title="算法专题|回溯" target="_blank">算法专题|回溯</a>
    </li>
    
    <li>
        <a href="https://weiweng.github.io/blog/post/2023-06-06-%E5%8A%A8%E6%80%81%E8%A7%84%E5%88%92/" title="算法专题|动态规划" target="_blank">算法专题|动态规划</a>
    </li>
    
    <li>
        <a href="https://weiweng.github.io/blog/post/2023-04-22-k8s%E5%9F%BA%E7%A1%80%E8%BF%9B%E9%98%B6/" title="k8s|基础进阶" target="_blank">k8s|基础进阶</a>
    </li>
    
    <li>
        <a href="https://weiweng.github.io/blog/post/2023-03-21-k8s%E6%A6%82%E5%BF%B5/" title="k8s|基础概念" target="_blank">k8s|基础概念</a>
    </li>
    
    <li>
        <a href="https://weiweng.github.io/blog/post/2023-02-18-%E4%BA%91%E5%8E%9F%E7%94%9Fdocker/" title="k8s|Docker学习" target="_blank">k8s|Docker学习</a>
    </li>
    
    <li>
        <a href="https://weiweng.github.io/blog/post/2023-02-17-golangcobra/" title="Golang|Cobra学习" target="_blank">Golang|Cobra学习</a>
    </li>
    
</ul>
    </section>

    

    <section class="widget">
        <h3 class="widget-title"><a href='/blog/categories/'>分类</a></h3>
<ul class="widget-list">
    
    <li><a href="https://weiweng.github.io/blog/categories/Golang/">Golang (26)</a></li>
    
    <li><a href="https://weiweng.github.io/blog/categories/MQ/">MQ (3)</a></li>
    
    <li><a href="https://weiweng.github.io/blog/categories/Python/">Python (2)</a></li>
    
    <li><a href="https://weiweng.github.io/blog/categories/Redis/">Redis (9)</a></li>
    
    <li><a href="https://weiweng.github.io/blog/categories/k8s/">k8s (3)</a></li>
    
    <li><a href="https://weiweng.github.io/blog/categories/linux/">linux (2)</a></li>
    
    <li><a href="https://weiweng.github.io/blog/categories/mysql/">mysql (21)</a></li>
    
    <li><a href="https://weiweng.github.io/blog/categories/%E5%BE%AE%E6%9C%8D%E5%8A%A1/">微服务 (3)</a></li>
    
    <li><a href="https://weiweng.github.io/blog/categories/%E6%93%8D%E4%BD%9C%E7%B3%BB%E7%BB%9F/">操作系统 (1)</a></li>
    
    <li><a href="https://weiweng.github.io/blog/categories/%E7%AE%97%E6%B3%95%E4%B8%93%E9%A2%98/">算法专题 (6)</a></li>
    
    <li><a href="https://weiweng.github.io/blog/categories/%E7%AE%97%E6%B3%95%E6%95%B0%E6%8D%AE%E7%BB%93%E6%9E%84/">算法&amp;数据结构 (36)</a></li>
    
    <li><a href="https://weiweng.github.io/blog/categories/%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%BD%91%E7%BB%9C/">计算机网络 (1)</a></li>
    
</ul>
    </section>

    <section class="widget">
        <h3 class="widget-title"><a href='/blog/tags/'>标签</a></h3>
<div class="tagcloud">
    
    <a href="https://weiweng.github.io/blog/tags/awk/">awk</a>
    
    <a href="https://weiweng.github.io/blog/tags/curl/">curl</a>
    
    <a href="https://weiweng.github.io/blog/tags/find/">find</a>
    
    <a href="https://weiweng.github.io/blog/tags/git/">git</a>
    
    <a href="https://weiweng.github.io/blog/tags/grep/">grep</a>
    
    <a href="https://weiweng.github.io/blog/tags/item2/">item2</a>
    
    <a href="https://weiweng.github.io/blog/tags/nginx/">nginx</a>
    
    <a href="https://weiweng.github.io/blog/tags/sed/">sed</a>
    
    <a href="https://weiweng.github.io/blog/tags/shell/">shell</a>
    
    <a href="https://weiweng.github.io/blog/tags/tmux/">tmux</a>
    
    <a href="https://weiweng.github.io/blog/tags/uml/">uml</a>
    
    <a href="https://weiweng.github.io/blog/tags/vim/">vim</a>
    
    <a href="https://weiweng.github.io/blog/tags/%E5%AD%A6%E4%B9%A0/">学习</a>
    
    <a href="https://weiweng.github.io/blog/tags/%E5%BC%80%E6%BA%90%E5%8D%8F%E8%AE%AE/">开源协议</a>
    
    <a href="https://weiweng.github.io/blog/tags/%E5%BF%83%E5%BE%97/">心得</a>
    
    <a href="https://weiweng.github.io/blog/tags/%E6%90%9C%E7%B4%A2%E5%BC%95%E6%93%8E%E6%8A%80%E5%B7%A7/">搜索引擎技巧</a>
    
</div>
    </section>

    
<section class="widget">
    <h3 class="widget-title">友情链接</h3>
    <ul class="widget-list">
        
        <li>
            <a target="_blank" href="https://www.flysnow.org/" title="飞雪无情的博客">飞雪无情的博客</a>
        </li>
        
        <li>
            <a target="_blank" href="https://draveness.me/" title="面向信仰编程">面向信仰编程</a>
        </li>
        
        <li>
            <a target="_blank" href="https://xargin.com/" title="No Headback">No Headback</a>
        </li>
        
        <li>
            <a target="_blank" href="https://eddycjy.com/" title="煎鱼的博客">煎鱼的博客</a>
        </li>
        
        <li>
            <a target="_blank" href="https://polarisxu.studygolang.com/" title="polarisxu的博客">polarisxu的博客</a>
        </li>
        
        <li>
            <a target="_blank" href="https://qcrao.com/" title="qcrao 的博客">qcrao 的博客</a>
        </li>
        
    </ul>
</section>


    <section class="widget">
        <h3 class="widget-title">其它</h3>
        <ul class="widget-list">
            <li><a href="https://weiweng.github.io/blog/index.xml">文章 RSS</a></li>
        </ul>
    </section>
</div>
            </div>
        </div>
    </div>
</body>

</html>