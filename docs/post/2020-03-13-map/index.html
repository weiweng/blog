<!doctype html>
<html lang="zh-CN">
<head>
    <script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-1207188090915424" crossorigin="anonymous"></script>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    

    <title>Golang|map | weiweng的博客</title>
    <meta property="og:title" content="Golang|map - weiweng的博客">
    <meta property="og:type" content="article">
        
    <meta property="article:published_time" content='2020-03-13T06:38:00&#43;08:00'>
        
        
    <meta property="article:modified_time" content='2020-03-13T06:38:00&#43;08:00'>
        
    <meta name="Keywords" content="golang,go语言,go语言笔记,博客,项目管理,软件架构">
    <meta name="description" content="Golang|map">
        
    <meta name="author" content="">
    <meta property="og:url" content="https://weiweng.github.io/blog/post/2020-03-13-map/">
    <link rel="shortcut icon" href='/blog/favicon.ico'  type="image/x-icon">

    <link rel="stylesheet" href='/blog/css/normalize.css'>
    <link rel="stylesheet" href='/blog/css/style.css'>
    <script type="text/javascript" src="//cdn.bootcdn.net/ajax/libs/jquery/3.4.1/jquery.min.js"></script>

    
    
    
    
    
    
</head>

<body>
    <header id="header" class="clearfix">
    <div class="container">
        <div class="col-group">
            <div class="site-name ">
                
                    <a id="logo" href="https://weiweng.github.io/blog/">
                        weiweng的博客
                    </a>
                
                <p class="description">记录所学所思所想，专注于Go语言、软件架构</p>
            </div>
            <div>
                <nav id="nav-menu" class="clearfix">
                    <a class="current" href="https://weiweng.github.io/blog/">首页</a>
                    
                    <a  href="https://weiweng.github.io/blog/tools/" title="工具">工具</a>
                    
                    <a  href="https://weiweng.github.io/blog/read/" title="阅读">阅读</a>
                    
                    <a  href="https://weiweng.github.io/blog/about/" title="关于">关于</a>
                    
                    <a  href="https://weiweng.github.io/blog/archives/" title="归档">归档</a>
                    
                </nav>
            </div>
        </div>
    </div>
</header>

    <div id="body">
        <div class="container">
            <div class="col-group">

                <div class="col-8" id="main">
                    
<div class="res-cons">
    
    <article class="post">
        <header>
            <h1 class="post-title">Golang|map</h1>
        </header>
        
  <time datetime="2020-03-12T22:38:00Z" class="post-meta meta-date dt-published">
    2020年3月13日
  </time>


<div class="post-meta meta-category">
  <span>&nbsp;|</span>
  
    <a href='/blog/categories/Golang' target="_blank">Golang</a>
  
</div>


        
        
        <div class="post-content">
            <h3 id="map">map</h3>
<p>由&lt;key,value&gt;对组成的抽象数据结构，并且同一个key只出现一次</p>
<h3 id="实现对比">实现对比</h3>
<p>方法 | hash | 搜索树 -|-|- 复杂度 | O(1) | O(logN) 顺序 | 乱序 | 有序 痛点 | 碰撞问题 | 平衡问题</p>
<h3 id="源码位置">源码位置</h3>
<div class="highlight"><div style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">7
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#57606a">//main.go</span>
</span></span><span style="display:flex;"><span><span style="color:#cf222e">package</span> <span style="color:#1f2328">main</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#cf222e">func</span> <span style="color:#6639ba">main</span><span style="color:#1f2328">()</span> <span style="color:#1f2328">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#1f2328">m</span> <span style="color:#0550ae">:=</span> <span style="color:#6639ba">make</span><span style="color:#1f2328">(</span><span style="color:#cf222e">map</span><span style="color:#1f2328">[</span><span style="color:#cf222e">int</span><span style="color:#1f2328">]</span><span style="color:#cf222e">int</span><span style="color:#1f2328">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#1f2328">m</span><span style="color:#1f2328">[</span><span style="color:#0550ae">2</span><span style="color:#1f2328">]</span> <span style="color:#1f2328">=</span> <span style="color:#0550ae">2</span>
</span></span><span style="display:flex;"><span><span style="color:#1f2328">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>上面代码通过以下指令查看汇编语句 <code>go tool compile -S main.go</code></p>
<p>map源码位置 src/runtime/hashmap.go (go1.9.2版本)</p>
<h3 id="源码分析">源码分析</h3>
<h4 id="数据结构">数据结构</h4>
<div class="highlight"><div style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">16
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">17
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">18
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">19
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">20
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">21
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">22
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">23
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">24
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">25
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">26
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">27
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">28
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">29
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">30
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">31
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">32
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">33
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">34
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">35
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">36
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">37
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">38
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">39
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">40
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">41
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">42
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">43
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">44
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">45
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">46
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">47
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">48
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">49
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#cf222e">type</span> <span style="color:#1f2328">hmap</span> <span style="color:#cf222e">struct</span> <span style="color:#1f2328">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#57606a">//计数,map包含key个数</span>
</span></span><span style="display:flex;"><span>	<span style="color:#1f2328">count</span> <span style="color:#cf222e">int</span>
</span></span><span style="display:flex;"><span>	<span style="color:#57606a">//标志位,包含是否写、是否遍历，老迭代器还是新迭代器遍历以及是否同大小增长</span>
</span></span><span style="display:flex;"><span>	<span style="color:#1f2328">flags</span> <span style="color:#cf222e">uint8</span>
</span></span><span style="display:flex;"><span>	<span style="color:#57606a">//map里桶的个数的指数</span>
</span></span><span style="display:flex;"><span>	<span style="color:#1f2328">B</span> <span style="color:#cf222e">uint8</span>
</span></span><span style="display:flex;"><span>	<span style="color:#57606a">//溢出桶的个数(数值过大是会随机计数大致统计)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#1f2328">noverflow</span> <span style="color:#cf222e">uint16</span>
</span></span><span style="display:flex;"><span>	<span style="color:#57606a">//key的hash种子</span>
</span></span><span style="display:flex;"><span>	<span style="color:#1f2328">hash0</span> <span style="color:#cf222e">uint32</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#57606a">//指向当前桶数组的指针</span>
</span></span><span style="display:flex;"><span>	<span style="color:#1f2328">buckets</span> <span style="color:#1f2328">unsafe</span><span style="color:#1f2328">.</span><span style="color:#1f2328">Pointer</span>
</span></span><span style="display:flex;"><span>	<span style="color:#57606a">//指向老桶数组的指针</span>
</span></span><span style="display:flex;"><span>	<span style="color:#1f2328">oldbuckets</span> <span style="color:#1f2328">unsafe</span><span style="color:#1f2328">.</span><span style="color:#1f2328">Pointer</span>
</span></span><span style="display:flex;"><span>	<span style="color:#57606a">//已迁移的地址，改地址以前的桶都已经迁移(扩容相关)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#1f2328">nevacuate</span> <span style="color:#cf222e">uintptr</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#57606a">//特殊用途</span>
</span></span><span style="display:flex;"><span>	<span style="color:#1f2328">extra</span> <span style="color:#0550ae">*</span><span style="color:#1f2328">mapextra</span>
</span></span><span style="display:flex;"><span><span style="color:#1f2328">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#57606a">//当map的键和值都不是指针并且类型为内置类型时，会将桶标记为不包含指针类型，从而减少GC扫描</span>
</span></span><span style="display:flex;"><span><span style="color:#57606a">//但是桶的结构体中包含overflow指针，因此上述map会将桶的overflow指针放在如下结构体中</span>
</span></span><span style="display:flex;"><span><span style="color:#cf222e">type</span> <span style="color:#1f2328">mapextra</span> <span style="color:#cf222e">struct</span> <span style="color:#1f2328">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#57606a">//大小为2的数组，值为指向数组的指针</span>
</span></span><span style="display:flex;"><span>	<span style="color:#57606a">//0号指向当前桶数组的地址</span>
</span></span><span style="display:flex;"><span>	<span style="color:#57606a">//1号指向老桶数组的地址</span>
</span></span><span style="display:flex;"><span>	<span style="color:#1f2328">overflow</span> <span style="color:#1f2328">[</span><span style="color:#0550ae">2</span><span style="color:#1f2328">]</span><span style="color:#0550ae">*</span><span style="color:#1f2328">[]</span><span style="color:#0550ae">*</span><span style="color:#1f2328">bmap</span>
</span></span><span style="display:flex;"><span>	<span style="color:#57606a">//指向预分配的桶的地址，具体功用还未理解，带填坑</span>
</span></span><span style="display:flex;"><span>	<span style="color:#1f2328">nextOverflow</span> <span style="color:#0550ae">*</span><span style="color:#1f2328">bmap</span>
</span></span><span style="display:flex;"><span><span style="color:#1f2328">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#57606a">//具体桶的结构体</span>
</span></span><span style="display:flex;"><span><span style="color:#cf222e">type</span> <span style="color:#1f2328">bmap</span> <span style="color:#cf222e">struct</span> <span style="color:#1f2328">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#57606a">//大小为8的数组，作用是快速索引key以及记录迁移状态</span>
</span></span><span style="display:flex;"><span>	<span style="color:#1f2328">topbits</span> <span style="color:#1f2328">[</span><span style="color:#0550ae">8</span><span style="color:#1f2328">]</span><span style="color:#cf222e">uint8</span>
</span></span><span style="display:flex;"><span>	<span style="color:#57606a">//键值存储位置</span>
</span></span><span style="display:flex;"><span>	<span style="color:#1f2328">keys</span>   <span style="color:#1f2328">[</span><span style="color:#0550ae">8</span><span style="color:#1f2328">]</span><span style="color:#1f2328">keytype</span>
</span></span><span style="display:flex;"><span>	<span style="color:#1f2328">values</span> <span style="color:#1f2328">[</span><span style="color:#0550ae">8</span><span style="color:#1f2328">]</span><span style="color:#1f2328">valuetype</span>
</span></span><span style="display:flex;"><span>	<span style="color:#57606a">//对其字节</span>
</span></span><span style="display:flex;"><span>	<span style="color:#1f2328">pad</span> <span style="color:#cf222e">uintptr</span>
</span></span><span style="display:flex;"><span>	<span style="color:#57606a">//溢出桶指针</span>
</span></span><span style="display:flex;"><span>	<span style="color:#1f2328">overflow</span> <span style="color:#cf222e">uintptr</span>
</span></span><span style="display:flex;"><span><span style="color:#1f2328">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#57606a">//bmap的key和value都是大小为8的数组，并且先key后value的排列</span>
</span></span><span style="display:flex;"><span><span style="color:#57606a">//目的是减少因为字节对齐产生的pad</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>
        <img class="mx-auto" alt="hmap结构体示例图" src="img_0.png" />   
    </p>
<h4 id="map创建">map创建</h4>
<div class="highlight"><div style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">16
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">17
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">18
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">19
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">20
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">21
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">22
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">23
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">24
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">25
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">26
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">27
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">28
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">29
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">30
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">31
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">32
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">33
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">34
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">35
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#cf222e">func</span> <span style="color:#6639ba">makemap</span><span style="color:#1f2328">(</span><span style="color:#1f2328">t</span> <span style="color:#0550ae">*</span><span style="color:#1f2328">maptype</span><span style="color:#1f2328">,</span> <span style="color:#1f2328">hint</span> <span style="color:#cf222e">int64</span><span style="color:#1f2328">,</span> <span style="color:#1f2328">h</span> <span style="color:#0550ae">*</span><span style="color:#1f2328">hmap</span><span style="color:#1f2328">,</span> <span style="color:#1f2328">bucket</span> <span style="color:#1f2328">unsafe</span><span style="color:#1f2328">.</span><span style="color:#1f2328">Pointer</span><span style="color:#1f2328">)</span> <span style="color:#0550ae">*</span><span style="color:#1f2328">hmap</span> <span style="color:#1f2328">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#57606a">//key的合法判断、大小判断、设定的常量判断等操作</span>
</span></span><span style="display:flex;"><span>	<span style="color:#0550ae">...</span>
</span></span><span style="display:flex;"><span>	<span style="color:#57606a">// B初始值为0 </span>
</span></span><span style="display:flex;"><span>	<span style="color:#1f2328">B</span> <span style="color:#0550ae">:=</span> <span style="color:#6639ba">uint8</span><span style="color:#1f2328">(</span><span style="color:#0550ae">0</span><span style="color:#1f2328">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#57606a">//hint大于8并且hint/2^B超过转载因子则增加B</span>
</span></span><span style="display:flex;"><span>	<span style="color:#cf222e">for</span> <span style="color:#1f2328">;</span> <span style="color:#6639ba">overLoadFactor</span><span style="color:#1f2328">(</span><span style="color:#1f2328">hint</span><span style="color:#1f2328">,</span> <span style="color:#1f2328">B</span><span style="color:#1f2328">);</span> <span style="color:#1f2328">B</span><span style="color:#0550ae">++</span> <span style="color:#1f2328">{</span> <span style="color:#1f2328">}</span> <span style="color:#57606a">//桶地址赋值，如果B=0，则会在mapassign阶段分配一个桶</span>
</span></span><span style="display:flex;"><span>	<span style="color:#1f2328">buckets</span> <span style="color:#0550ae">:=</span> <span style="color:#1f2328">bucket</span>
</span></span><span style="display:flex;"><span>	<span style="color:#cf222e">var</span> <span style="color:#1f2328">extra</span> <span style="color:#0550ae">*</span><span style="color:#1f2328">mapextra</span>
</span></span><span style="display:flex;"><span>	<span style="color:#cf222e">if</span> <span style="color:#1f2328">B</span> <span style="color:#0550ae">!=</span> <span style="color:#0550ae">0</span> <span style="color:#1f2328">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#cf222e">var</span> <span style="color:#1f2328">nextOverflow</span> <span style="color:#0550ae">*</span><span style="color:#1f2328">bmap</span>
</span></span><span style="display:flex;"><span>		<span style="color:#57606a">//根据B大小分配桶数组的地址空间，以及预分配一些桶的空间</span>
</span></span><span style="display:flex;"><span>		<span style="color:#1f2328">buckets</span><span style="color:#1f2328">,</span> <span style="color:#1f2328">nextOverflow</span> <span style="color:#1f2328">=</span> <span style="color:#6639ba">makeBucketArray</span><span style="color:#1f2328">(</span><span style="color:#1f2328">t</span><span style="color:#1f2328">,</span> <span style="color:#1f2328">B</span><span style="color:#1f2328">)</span>
</span></span><span style="display:flex;"><span>		<span style="color:#cf222e">if</span> <span style="color:#1f2328">nextOverflow</span> <span style="color:#0550ae">!=</span> <span style="color:#cf222e">nil</span> <span style="color:#1f2328">{</span>
</span></span><span style="display:flex;"><span>			<span style="color:#1f2328">extra</span> <span style="color:#1f2328">=</span> <span style="color:#6639ba">new</span><span style="color:#1f2328">(</span><span style="color:#1f2328">mapextra</span><span style="color:#1f2328">)</span>
</span></span><span style="display:flex;"><span>			<span style="color:#1f2328">extra</span><span style="color:#1f2328">.</span><span style="color:#1f2328">nextOverflow</span> <span style="color:#1f2328">=</span> <span style="color:#1f2328">nextOverflow</span>
</span></span><span style="display:flex;"><span>		<span style="color:#1f2328">}</span>
</span></span><span style="display:flex;"><span>	<span style="color:#1f2328">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#57606a">// 初始化hmap的其他数值 </span>
</span></span><span style="display:flex;"><span>	<span style="color:#cf222e">if</span> <span style="color:#1f2328">h</span> <span style="color:#0550ae">==</span> <span style="color:#cf222e">nil</span> <span style="color:#1f2328">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#1f2328">h</span> <span style="color:#1f2328">=</span> <span style="color:#1f2328">(</span><span style="color:#0550ae">*</span><span style="color:#1f2328">hmap</span><span style="color:#1f2328">)(</span><span style="color:#6639ba">newobject</span><span style="color:#1f2328">(</span><span style="color:#1f2328">t</span><span style="color:#1f2328">.</span><span style="color:#1f2328">hmap</span><span style="color:#1f2328">))</span>
</span></span><span style="display:flex;"><span>	<span style="color:#1f2328">}</span>
</span></span><span style="display:flex;"><span>	<span style="color:#1f2328">h</span><span style="color:#1f2328">.</span><span style="color:#1f2328">count</span> <span style="color:#1f2328">=</span> <span style="color:#0550ae">0</span>
</span></span><span style="display:flex;"><span>	<span style="color:#1f2328">h</span><span style="color:#1f2328">.</span><span style="color:#1f2328">B</span> <span style="color:#1f2328">=</span> <span style="color:#1f2328">B</span>
</span></span><span style="display:flex;"><span>	<span style="color:#1f2328">h</span><span style="color:#1f2328">.</span><span style="color:#1f2328">extra</span> <span style="color:#1f2328">=</span> <span style="color:#1f2328">extra</span>
</span></span><span style="display:flex;"><span>	<span style="color:#1f2328">h</span><span style="color:#1f2328">.</span><span style="color:#1f2328">flags</span> <span style="color:#1f2328">=</span> <span style="color:#0550ae">0</span>
</span></span><span style="display:flex;"><span>	<span style="color:#1f2328">h</span><span style="color:#1f2328">.</span><span style="color:#1f2328">hash0</span> <span style="color:#1f2328">=</span> <span style="color:#6639ba">fastrand</span><span style="color:#1f2328">()</span>
</span></span><span style="display:flex;"><span>	<span style="color:#1f2328">h</span><span style="color:#1f2328">.</span><span style="color:#1f2328">buckets</span> <span style="color:#1f2328">=</span> <span style="color:#1f2328">buckets</span>
</span></span><span style="display:flex;"><span>	<span style="color:#1f2328">h</span><span style="color:#1f2328">.</span><span style="color:#1f2328">oldbuckets</span> <span style="color:#1f2328">=</span> <span style="color:#cf222e">nil</span>
</span></span><span style="display:flex;"><span>	<span style="color:#1f2328">h</span><span style="color:#1f2328">.</span><span style="color:#1f2328">nevacuate</span> <span style="color:#1f2328">=</span> <span style="color:#0550ae">0</span>
</span></span><span style="display:flex;"><span>	<span style="color:#1f2328">h</span><span style="color:#1f2328">.</span><span style="color:#1f2328">noverflow</span> <span style="color:#1f2328">=</span> <span style="color:#0550ae">0</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#cf222e">return</span> <span style="color:#1f2328">h</span>
</span></span><span style="display:flex;"><span><span style="color:#1f2328">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h4 id="map读取">map读取</h4>
<p>map的读取函数很多但核心都一样，下面重点分析mapaccess2函数</p>
<p>
        <img class="mx-auto" alt="map读取过程示例图" src="img_1.png" />   
    </p>
<div class="highlight"><div style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">16
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">17
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">18
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">19
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">20
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">21
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">22
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">23
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">24
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">25
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">26
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">27
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">28
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">29
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">30
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">31
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">32
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">33
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">34
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">35
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">36
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">37
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">38
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">39
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">40
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">41
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">42
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">43
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">44
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">45
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">46
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">47
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">48
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">49
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">50
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">51
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">52
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">53
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">54
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">55
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">56
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">57
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">58
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">59
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">60
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">61
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">62
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">63
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">64
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">65
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">66
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">67
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">68
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">69
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">70
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">71
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">72
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">73
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">74
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#cf222e">func</span> <span style="color:#6639ba">mapaccess2</span><span style="color:#1f2328">(</span><span style="color:#1f2328">t</span> <span style="color:#0550ae">*</span><span style="color:#1f2328">maptype</span><span style="color:#1f2328">,</span> <span style="color:#1f2328">h</span> <span style="color:#0550ae">*</span><span style="color:#1f2328">hmap</span><span style="color:#1f2328">,</span> <span style="color:#1f2328">key</span> <span style="color:#1f2328">unsafe</span><span style="color:#1f2328">.</span><span style="color:#1f2328">Pointer</span><span style="color:#1f2328">)</span> <span style="color:#1f2328">(</span><span style="color:#1f2328">unsafe</span><span style="color:#1f2328">.</span><span style="color:#1f2328">Pointer</span><span style="color:#1f2328">,</span> <span style="color:#cf222e">bool</span><span style="color:#1f2328">)</span> <span style="color:#1f2328">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#57606a">//不知道干啥的，好像已经不适用了</span>
</span></span><span style="display:flex;"><span>	<span style="color:#0550ae">...</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#57606a">//map为nil或者大小等于0则返回value类型的0值</span>
</span></span><span style="display:flex;"><span>	<span style="color:#cf222e">if</span> <span style="color:#1f2328">h</span> <span style="color:#0550ae">==</span> <span style="color:#cf222e">nil</span> <span style="color:#0550ae">||</span> <span style="color:#1f2328">h</span><span style="color:#1f2328">.</span><span style="color:#1f2328">count</span> <span style="color:#0550ae">==</span> <span style="color:#0550ae">0</span> <span style="color:#1f2328">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#cf222e">return</span> <span style="color:#1f2328">unsafe</span><span style="color:#1f2328">.</span><span style="color:#6639ba">Pointer</span><span style="color:#1f2328">(</span><span style="color:#0550ae">&amp;</span><span style="color:#1f2328">zeroVal</span><span style="color:#1f2328">[</span><span style="color:#0550ae">0</span><span style="color:#1f2328">]),</span> <span style="color:#cf222e">false</span>
</span></span><span style="display:flex;"><span>	<span style="color:#1f2328">}</span>
</span></span><span style="display:flex;"><span>	<span style="color:#57606a">//标志位判断是否有协程在写map，有的话抛错误</span>
</span></span><span style="display:flex;"><span>	<span style="color:#cf222e">if</span> <span style="color:#1f2328">h</span><span style="color:#1f2328">.</span><span style="color:#1f2328">flags</span><span style="color:#0550ae">&amp;</span><span style="color:#1f2328">hashWriting</span> <span style="color:#0550ae">!=</span> <span style="color:#0550ae">0</span> <span style="color:#1f2328">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#6639ba">throw</span><span style="color:#1f2328">(</span><span style="color:#0a3069">&#34;concurrent map read and map write&#34;</span><span style="color:#1f2328">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#1f2328">}</span>
</span></span><span style="display:flex;"><span>	<span style="color:#57606a">//拿到key的hash函数</span>
</span></span><span style="display:flex;"><span>	<span style="color:#1f2328">alg</span> <span style="color:#0550ae">:=</span> <span style="color:#1f2328">t</span><span style="color:#1f2328">.</span><span style="color:#1f2328">key</span><span style="color:#1f2328">.</span><span style="color:#1f2328">alg</span>
</span></span><span style="display:flex;"><span>	<span style="color:#57606a">//通过map的hash种子和key的hash函数算出哈希值</span>
</span></span><span style="display:flex;"><span>	<span style="color:#1f2328">hash</span> <span style="color:#0550ae">:=</span> <span style="color:#1f2328">alg</span><span style="color:#1f2328">.</span><span style="color:#6639ba">hash</span><span style="color:#1f2328">(</span><span style="color:#1f2328">key</span><span style="color:#1f2328">,</span> <span style="color:#6639ba">uintptr</span><span style="color:#1f2328">(</span><span style="color:#1f2328">h</span><span style="color:#1f2328">.</span><span style="color:#1f2328">hash0</span><span style="color:#1f2328">))</span> <span style="color:#57606a">//获取桶的掩码值,即B=5则m=11111</span>
</span></span><span style="display:flex;"><span>	<span style="color:#1f2328">m</span> <span style="color:#0550ae">:=</span> <span style="color:#6639ba">uintptr</span><span style="color:#1f2328">(</span><span style="color:#0550ae">1</span><span style="color:#1f2328">)</span><span style="color:#0550ae">&lt;&lt;</span><span style="color:#1f2328">h</span><span style="color:#1f2328">.</span><span style="color:#1f2328">B</span> <span style="color:#0550ae">-</span> <span style="color:#0550ae">1</span>
</span></span><span style="display:flex;"><span>	<span style="color:#57606a">//通过掩码m获取hash值最后B位数值，得到key所在的桶数组的下标地址</span>
</span></span><span style="display:flex;"><span>	<span style="color:#1f2328">b</span> <span style="color:#0550ae">:=</span> <span style="color:#1f2328">(</span><span style="color:#0550ae">*</span><span style="color:#1f2328">bmap</span><span style="color:#1f2328">)(</span><span style="color:#1f2328">unsafe</span><span style="color:#1f2328">.</span><span style="color:#6639ba">Pointer</span><span style="color:#1f2328">(</span><span style="color:#6639ba">uintptr</span><span style="color:#1f2328">(</span><span style="color:#1f2328">h</span><span style="color:#1f2328">.</span><span style="color:#1f2328">buckets</span><span style="color:#1f2328">)</span> <span style="color:#0550ae">+</span> <span style="color:#1f2328">(</span><span style="color:#1f2328">hash</span><span style="color:#0550ae">&amp;</span><span style="color:#1f2328">m</span><span style="color:#1f2328">)</span><span style="color:#0550ae">*</span><span style="color:#6639ba">uintptr</span><span style="color:#1f2328">(</span><span style="color:#1f2328">t</span><span style="color:#1f2328">.</span><span style="color:#1f2328">bucketsize</span><span style="color:#1f2328">)))</span>
</span></span><span style="display:flex;"><span>	<span style="color:#57606a">//查看是否有老桶数组，有的话表示map正在扩容</span>
</span></span><span style="display:flex;"><span>	<span style="color:#cf222e">if</span> <span style="color:#1f2328">c</span> <span style="color:#0550ae">:=</span> <span style="color:#1f2328">h</span><span style="color:#1f2328">.</span><span style="color:#1f2328">oldbuckets</span><span style="color:#1f2328">;</span> <span style="color:#1f2328">c</span> <span style="color:#0550ae">!=</span> <span style="color:#cf222e">nil</span> <span style="color:#1f2328">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#57606a">//如果不是等大小扩容，则说明是真正的增加桶个数的扩容</span>
</span></span><span style="display:flex;"><span>		<span style="color:#57606a">//通常是翻倍增加，因此m右移一位即，老桶的掩码值</span>
</span></span><span style="display:flex;"><span>		<span style="color:#cf222e">if</span> <span style="color:#1f2328">!</span><span style="color:#1f2328">h</span><span style="color:#1f2328">.</span><span style="color:#6639ba">sameSizeGrow</span><span style="color:#1f2328">()</span> <span style="color:#1f2328">{</span>
</span></span><span style="display:flex;"><span>			<span style="color:#1f2328">m</span> <span style="color:#0550ae">&gt;&gt;=</span> <span style="color:#0550ae">1</span>
</span></span><span style="display:flex;"><span>		<span style="color:#1f2328">}</span>
</span></span><span style="display:flex;"><span>		<span style="color:#57606a">//通过老桶数组的掩码值计算老桶数组中key对应的桶地址</span>
</span></span><span style="display:flex;"><span>		<span style="color:#1f2328">oldb</span> <span style="color:#0550ae">:=</span> <span style="color:#1f2328">(</span><span style="color:#0550ae">*</span><span style="color:#1f2328">bmap</span><span style="color:#1f2328">)(</span><span style="color:#1f2328">unsafe</span><span style="color:#1f2328">.</span><span style="color:#6639ba">Pointer</span><span style="color:#1f2328">(</span><span style="color:#6639ba">uintptr</span><span style="color:#1f2328">(</span><span style="color:#1f2328">c</span><span style="color:#1f2328">)</span> <span style="color:#0550ae">+</span> <span style="color:#1f2328">(</span><span style="color:#1f2328">hash</span><span style="color:#0550ae">&amp;</span><span style="color:#1f2328">m</span><span style="color:#1f2328">)</span><span style="color:#0550ae">*</span><span style="color:#6639ba">uintptr</span><span style="color:#1f2328">(</span><span style="color:#1f2328">t</span><span style="color:#1f2328">.</span><span style="color:#1f2328">bucketsize</span><span style="color:#1f2328">)))</span>
</span></span><span style="display:flex;"><span>		<span style="color:#57606a">//判断是否已经搬迁，如果没有搬迁，则用老桶地址来寻找</span>
</span></span><span style="display:flex;"><span>		<span style="color:#57606a">//怎么判断是否搬迁？看桶的第一个tophash是否在1-3之间，1-3为桶的特殊标记</span>
</span></span><span style="display:flex;"><span>		<span style="color:#57606a">//一次搬迁一个桶及其溢出桶，只有搬迁后才会设置特殊标记</span>
</span></span><span style="display:flex;"><span>		<span style="color:#cf222e">if</span> <span style="color:#1f2328">!</span><span style="color:#6639ba">evacuated</span><span style="color:#1f2328">(</span><span style="color:#1f2328">oldb</span><span style="color:#1f2328">)</span> <span style="color:#1f2328">{</span>
</span></span><span style="display:flex;"><span>			<span style="color:#1f2328">b</span> <span style="color:#1f2328">=</span> <span style="color:#1f2328">oldb</span>
</span></span><span style="display:flex;"><span>		<span style="color:#1f2328">}</span>
</span></span><span style="display:flex;"><span>	<span style="color:#1f2328">}</span>
</span></span><span style="display:flex;"><span>	<span style="color:#57606a">//取hash值前8位作为tophash值和桶的tonghash数组对比进行快速定位查找</span>
</span></span><span style="display:flex;"><span>	<span style="color:#1f2328">top</span> <span style="color:#0550ae">:=</span> <span style="color:#6639ba">uint8</span><span style="color:#1f2328">(</span><span style="color:#1f2328">hash</span> <span style="color:#0550ae">&gt;&gt;</span> <span style="color:#1f2328">(</span><span style="color:#1f2328">sys</span><span style="color:#1f2328">.</span><span style="color:#1f2328">PtrSize</span><span style="color:#0550ae">*</span><span style="color:#0550ae">8</span> <span style="color:#0550ae">-</span> <span style="color:#0550ae">8</span><span style="color:#1f2328">))</span>
</span></span><span style="display:flex;"><span>	<span style="color:#57606a">//top取值小于4的,需要加4,因为0-3是tophash的特殊标记</span>
</span></span><span style="display:flex;"><span>	<span style="color:#cf222e">if</span> <span style="color:#1f2328">top</span> <span style="color:#1f2328">&lt;</span> <span style="color:#1f2328">minTopHash</span> <span style="color:#1f2328">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#1f2328">top</span> <span style="color:#0550ae">+=</span> <span style="color:#1f2328">minTopHash</span>
</span></span><span style="display:flex;"><span>	<span style="color:#1f2328">}</span>
</span></span><span style="display:flex;"><span>	<span style="color:#cf222e">for</span> <span style="color:#1f2328">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#57606a">//遍历桶的8个位置</span>
</span></span><span style="display:flex;"><span>		<span style="color:#cf222e">for</span> <span style="color:#1f2328">i</span> <span style="color:#0550ae">:=</span> <span style="color:#6639ba">uintptr</span><span style="color:#1f2328">(</span><span style="color:#0550ae">0</span><span style="color:#1f2328">);</span> <span style="color:#1f2328">i</span> <span style="color:#1f2328">&lt;</span> <span style="color:#1f2328">bucketCnt</span><span style="color:#1f2328">;</span> <span style="color:#1f2328">i</span><span style="color:#0550ae">++</span> <span style="color:#1f2328">{</span>
</span></span><span style="display:flex;"><span>			<span style="color:#57606a">//通过tophash快速判断</span>
</span></span><span style="display:flex;"><span>			<span style="color:#cf222e">if</span> <span style="color:#1f2328">b</span><span style="color:#1f2328">.</span><span style="color:#1f2328">tophash</span><span style="color:#1f2328">[</span><span style="color:#1f2328">i</span><span style="color:#1f2328">]</span> <span style="color:#0550ae">!=</span> <span style="color:#1f2328">top</span> <span style="color:#1f2328">{</span>
</span></span><span style="display:flex;"><span>				<span style="color:#cf222e">continue</span>
</span></span><span style="display:flex;"><span>			<span style="color:#1f2328">}</span>
</span></span><span style="display:flex;"><span>			<span style="color:#57606a">//tophash值相同的，则把key拿出来</span>
</span></span><span style="display:flex;"><span>			<span style="color:#1f2328">k</span> <span style="color:#0550ae">:=</span> <span style="color:#6639ba">add</span><span style="color:#1f2328">(</span><span style="color:#1f2328">unsafe</span><span style="color:#1f2328">.</span><span style="color:#6639ba">Pointer</span><span style="color:#1f2328">(</span><span style="color:#1f2328">b</span><span style="color:#1f2328">),</span> <span style="color:#1f2328">dataOffset</span><span style="color:#0550ae">+</span><span style="color:#1f2328">i</span><span style="color:#0550ae">*</span><span style="color:#6639ba">uintptr</span><span style="color:#1f2328">(</span><span style="color:#1f2328">t</span><span style="color:#1f2328">.</span><span style="color:#1f2328">keysize</span><span style="color:#1f2328">))</span>
</span></span><span style="display:flex;"><span>			<span style="color:#57606a">//如果key存的是指针 </span>
</span></span><span style="display:flex;"><span>			<span style="color:#cf222e">if</span> <span style="color:#1f2328">t</span><span style="color:#1f2328">.</span><span style="color:#1f2328">indirectkey</span> <span style="color:#1f2328">{</span>
</span></span><span style="display:flex;"><span>				<span style="color:#57606a">//取出值来</span>
</span></span><span style="display:flex;"><span>				<span style="color:#1f2328">k</span> <span style="color:#1f2328">=</span> <span style="color:#0550ae">*</span><span style="color:#1f2328">((</span><span style="color:#0550ae">*</span><span style="color:#1f2328">unsafe</span><span style="color:#1f2328">.</span><span style="color:#1f2328">Pointer</span><span style="color:#1f2328">)(</span><span style="color:#1f2328">k</span><span style="color:#1f2328">))</span>
</span></span><span style="display:flex;"><span>			<span style="color:#1f2328">}</span>
</span></span><span style="display:flex;"><span>			<span style="color:#57606a">//计算key和k的值是否相等，tophash一样的不一定key一样哈</span>
</span></span><span style="display:flex;"><span>			<span style="color:#cf222e">if</span> <span style="color:#1f2328">alg</span><span style="color:#1f2328">.</span><span style="color:#6639ba">equal</span><span style="color:#1f2328">(</span><span style="color:#1f2328">key</span><span style="color:#1f2328">,</span> <span style="color:#1f2328">k</span><span style="color:#1f2328">)</span> <span style="color:#1f2328">{</span>
</span></span><span style="display:flex;"><span>				<span style="color:#57606a">//一样的话，拿对应的值</span>
</span></span><span style="display:flex;"><span>				<span style="color:#1f2328">v</span> <span style="color:#0550ae">:=</span> <span style="color:#6639ba">add</span><span style="color:#1f2328">(</span><span style="color:#1f2328">unsafe</span><span style="color:#1f2328">.</span><span style="color:#6639ba">Pointer</span><span style="color:#1f2328">(</span><span style="color:#1f2328">b</span><span style="color:#1f2328">),</span> <span style="color:#1f2328">dataOffset</span><span style="color:#0550ae">+</span><span style="color:#1f2328">bucketCnt</span><span style="color:#0550ae">*</span><span style="color:#6639ba">uintptr</span><span style="color:#1f2328">(</span><span style="color:#1f2328">t</span><span style="color:#1f2328">.</span><span style="color:#1f2328">keysize</span><span style="color:#1f2328">)</span><span style="color:#0550ae">+</span><span style="color:#1f2328">i</span><span style="color:#0550ae">*</span><span style="color:#6639ba">uintptr</span><span style="color:#1f2328">(</span><span style="color:#1f2328">t</span><span style="color:#1f2328">.</span><span style="color:#1f2328">valuesize</span><span style="color:#1f2328">))</span>
</span></span><span style="display:flex;"><span>				<span style="color:#57606a">//值存的是指针，则通过指针获取正在的值</span>
</span></span><span style="display:flex;"><span>				<span style="color:#cf222e">if</span> <span style="color:#1f2328">t</span><span style="color:#1f2328">.</span><span style="color:#1f2328">indirectvalue</span> <span style="color:#1f2328">{</span>
</span></span><span style="display:flex;"><span>					<span style="color:#1f2328">v</span> <span style="color:#1f2328">=</span> <span style="color:#0550ae">*</span><span style="color:#1f2328">((</span><span style="color:#0550ae">*</span><span style="color:#1f2328">unsafe</span><span style="color:#1f2328">.</span><span style="color:#1f2328">Pointer</span><span style="color:#1f2328">)(</span><span style="color:#1f2328">v</span><span style="color:#1f2328">))</span>
</span></span><span style="display:flex;"><span>				<span style="color:#1f2328">}</span>
</span></span><span style="display:flex;"><span>				<span style="color:#cf222e">return</span> <span style="color:#1f2328">v</span><span style="color:#1f2328">,</span> <span style="color:#cf222e">true</span>
</span></span><span style="display:flex;"><span>			<span style="color:#1f2328">}</span>
</span></span><span style="display:flex;"><span>		<span style="color:#1f2328">}</span>
</span></span><span style="display:flex;"><span>		<span style="color:#57606a">//8个都没有则看是否有溢出桶</span>
</span></span><span style="display:flex;"><span>		<span style="color:#1f2328">b</span> <span style="color:#1f2328">=</span> <span style="color:#1f2328">b</span><span style="color:#1f2328">.</span><span style="color:#6639ba">overflow</span><span style="color:#1f2328">(</span><span style="color:#1f2328">t</span><span style="color:#1f2328">)</span>
</span></span><span style="display:flex;"><span>		<span style="color:#cf222e">if</span> <span style="color:#1f2328">b</span> <span style="color:#0550ae">==</span> <span style="color:#cf222e">nil</span> <span style="color:#1f2328">{</span>
</span></span><span style="display:flex;"><span>			<span style="color:#57606a">//没有溢出桶，返回value类型的0值</span>
</span></span><span style="display:flex;"><span>			<span style="color:#cf222e">return</span> <span style="color:#1f2328">unsafe</span><span style="color:#1f2328">.</span><span style="color:#6639ba">Pointer</span><span style="color:#1f2328">(</span><span style="color:#0550ae">&amp;</span><span style="color:#1f2328">zeroVal</span><span style="color:#1f2328">[</span><span style="color:#0550ae">0</span><span style="color:#1f2328">]),</span> <span style="color:#cf222e">false</span>
</span></span><span style="display:flex;"><span>		<span style="color:#1f2328">}</span>
</span></span><span style="display:flex;"><span>	<span style="color:#1f2328">}</span>
</span></span><span style="display:flex;"><span><span style="color:#1f2328">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h4 id="map赋值">map赋值</h4>
<div class="highlight"><div style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">  1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">  2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">  3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">  4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">  5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">  6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">  7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">  8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">  9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 16
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 17
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 18
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 19
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 20
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 21
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 22
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 23
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 24
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 25
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 26
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 27
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 28
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 29
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 30
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 31
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 32
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 33
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 34
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 35
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 36
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 37
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 38
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 39
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 40
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 41
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 42
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 43
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 44
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 45
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 46
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 47
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 48
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 49
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 50
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 51
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 52
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 53
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 54
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 55
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 56
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 57
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 58
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 59
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 60
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 61
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 62
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 63
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 64
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 65
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 66
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 67
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 68
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 69
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 70
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 71
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 72
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 73
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 74
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 75
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 76
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 77
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 78
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 79
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 80
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 81
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 82
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 83
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 84
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 85
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 86
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 87
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 88
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 89
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 90
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 91
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 92
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 93
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 94
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 95
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 96
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 97
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 98
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 99
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">100
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">101
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">102
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">103
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">104
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">105
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">106
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">107
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">108
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">109
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">110
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">111
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">112
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">113
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">114
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">115
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">116
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">117
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">118
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">119
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">120
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">121
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">122
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">123
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">124
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">125
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">126
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">127
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">128
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">129
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">130
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">131
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">132
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">133
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">134
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">135
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">136
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#cf222e">func</span> <span style="color:#6639ba">mapassign</span><span style="color:#1f2328">(</span><span style="color:#1f2328">t</span> <span style="color:#0550ae">*</span><span style="color:#1f2328">maptype</span><span style="color:#1f2328">,</span> <span style="color:#1f2328">h</span> <span style="color:#0550ae">*</span><span style="color:#1f2328">hmap</span><span style="color:#1f2328">,</span> <span style="color:#1f2328">key</span> <span style="color:#1f2328">unsafe</span><span style="color:#1f2328">.</span><span style="color:#1f2328">Pointer</span><span style="color:#1f2328">)</span> <span style="color:#1f2328">unsafe</span><span style="color:#1f2328">.</span><span style="color:#1f2328">Pointer</span> <span style="color:#1f2328">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#57606a">//map为nil 抛panic</span>
</span></span><span style="display:flex;"><span>	<span style="color:#cf222e">if</span> <span style="color:#1f2328">h</span> <span style="color:#0550ae">==</span> <span style="color:#cf222e">nil</span> <span style="color:#1f2328">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#6639ba">panic</span><span style="color:#1f2328">(</span><span style="color:#6639ba">plainError</span><span style="color:#1f2328">(</span><span style="color:#0a3069">&#34;assignment to entry in nil map&#34;</span><span style="color:#1f2328">))</span>
</span></span><span style="display:flex;"><span>	<span style="color:#1f2328">}</span>
</span></span><span style="display:flex;"><span>	<span style="color:#57606a">//好像是废弃的代码</span>
</span></span><span style="display:flex;"><span>	<span style="color:#0550ae">...</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#57606a">//判断是否有写的协程在操作</span>
</span></span><span style="display:flex;"><span>	<span style="color:#cf222e">if</span> <span style="color:#1f2328">h</span><span style="color:#1f2328">.</span><span style="color:#1f2328">flags</span><span style="color:#0550ae">&amp;</span><span style="color:#1f2328">hashWriting</span> <span style="color:#0550ae">!=</span> <span style="color:#0550ae">0</span> <span style="color:#1f2328">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#6639ba">throw</span><span style="color:#1f2328">(</span><span style="color:#0a3069">&#34;concurrent map writes&#34;</span><span style="color:#1f2328">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#1f2328">}</span>
</span></span><span style="display:flex;"><span>	<span style="color:#1f2328">alg</span> <span style="color:#0550ae">:=</span> <span style="color:#1f2328">t</span><span style="color:#1f2328">.</span><span style="color:#1f2328">key</span><span style="color:#1f2328">.</span><span style="color:#1f2328">alg</span>
</span></span><span style="display:flex;"><span>	<span style="color:#1f2328">hash</span> <span style="color:#0550ae">:=</span> <span style="color:#1f2328">alg</span><span style="color:#1f2328">.</span><span style="color:#6639ba">hash</span><span style="color:#1f2328">(</span><span style="color:#1f2328">key</span><span style="color:#1f2328">,</span> <span style="color:#6639ba">uintptr</span><span style="color:#1f2328">(</span><span style="color:#1f2328">h</span><span style="color:#1f2328">.</span><span style="color:#1f2328">hash0</span><span style="color:#1f2328">))</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#57606a">//map的标志位设置写状态</span>
</span></span><span style="display:flex;"><span>	<span style="color:#1f2328">h</span><span style="color:#1f2328">.</span><span style="color:#1f2328">flags</span> <span style="color:#0550ae">|=</span> <span style="color:#1f2328">hashWriting</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#57606a">//如果桶数组为nil则分配1个</span>
</span></span><span style="display:flex;"><span>	<span style="color:#cf222e">if</span> <span style="color:#1f2328">h</span><span style="color:#1f2328">.</span><span style="color:#1f2328">buckets</span> <span style="color:#0550ae">==</span> <span style="color:#cf222e">nil</span> <span style="color:#1f2328">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#1f2328">h</span><span style="color:#1f2328">.</span><span style="color:#1f2328">buckets</span> <span style="color:#1f2328">=</span> <span style="color:#6639ba">newarray</span><span style="color:#1f2328">(</span><span style="color:#1f2328">t</span><span style="color:#1f2328">.</span><span style="color:#1f2328">bucket</span><span style="color:#1f2328">,</span> <span style="color:#0550ae">1</span><span style="color:#1f2328">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#1f2328">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#1f2328">again</span><span style="color:#1f2328">:</span>
</span></span><span style="display:flex;"><span>	<span style="color:#57606a">//拿到key对应的桶数组地址</span>
</span></span><span style="display:flex;"><span>	<span style="color:#1f2328">bucket</span> <span style="color:#0550ae">:=</span> <span style="color:#1f2328">hash</span> <span style="color:#0550ae">&amp;</span> <span style="color:#1f2328">(</span><span style="color:#6639ba">uintptr</span><span style="color:#1f2328">(</span><span style="color:#0550ae">1</span><span style="color:#1f2328">)</span><span style="color:#0550ae">&lt;&lt;</span><span style="color:#1f2328">h</span><span style="color:#1f2328">.</span><span style="color:#1f2328">B</span> <span style="color:#0550ae">-</span> <span style="color:#0550ae">1</span><span style="color:#1f2328">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#57606a">//如果map处于扩容状态则尝试搬迁当前桶</span>
</span></span><span style="display:flex;"><span>	<span style="color:#cf222e">if</span> <span style="color:#1f2328">h</span><span style="color:#1f2328">.</span><span style="color:#6639ba">growing</span><span style="color:#1f2328">()</span> <span style="color:#1f2328">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#57606a">//桶的搬迁工作，一次尝试搬迁两个桶，具体后续分析</span>
</span></span><span style="display:flex;"><span>		<span style="color:#6639ba">growWork</span><span style="color:#1f2328">(</span><span style="color:#1f2328">t</span><span style="color:#1f2328">,</span> <span style="color:#1f2328">h</span><span style="color:#1f2328">,</span> <span style="color:#1f2328">bucket</span><span style="color:#1f2328">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#1f2328">}</span>
</span></span><span style="display:flex;"><span>	<span style="color:#57606a">//以下部分和map的查找逻辑一样</span>
</span></span><span style="display:flex;"><span>	<span style="color:#1f2328">b</span> <span style="color:#0550ae">:=</span> <span style="color:#1f2328">(</span><span style="color:#0550ae">*</span><span style="color:#1f2328">bmap</span><span style="color:#1f2328">)(</span><span style="color:#1f2328">unsafe</span><span style="color:#1f2328">.</span><span style="color:#6639ba">Pointer</span><span style="color:#1f2328">(</span><span style="color:#6639ba">uintptr</span><span style="color:#1f2328">(</span><span style="color:#1f2328">h</span><span style="color:#1f2328">.</span><span style="color:#1f2328">buckets</span><span style="color:#1f2328">)</span> <span style="color:#0550ae">+</span> <span style="color:#1f2328">bucket</span><span style="color:#0550ae">*</span><span style="color:#6639ba">uintptr</span><span style="color:#1f2328">(</span><span style="color:#1f2328">t</span><span style="color:#1f2328">.</span><span style="color:#1f2328">bucketsize</span><span style="color:#1f2328">)))</span>
</span></span><span style="display:flex;"><span>	<span style="color:#1f2328">top</span> <span style="color:#0550ae">:=</span> <span style="color:#6639ba">uint8</span><span style="color:#1f2328">(</span><span style="color:#1f2328">hash</span> <span style="color:#0550ae">&gt;&gt;</span> <span style="color:#1f2328">(</span><span style="color:#1f2328">sys</span><span style="color:#1f2328">.</span><span style="color:#1f2328">PtrSize</span><span style="color:#0550ae">*</span><span style="color:#0550ae">8</span> <span style="color:#0550ae">-</span> <span style="color:#0550ae">8</span><span style="color:#1f2328">))</span>
</span></span><span style="display:flex;"><span>	<span style="color:#cf222e">if</span> <span style="color:#1f2328">top</span> <span style="color:#1f2328">&lt;</span> <span style="color:#1f2328">minTopHash</span> <span style="color:#1f2328">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#1f2328">top</span> <span style="color:#0550ae">+=</span> <span style="color:#1f2328">minTopHash</span>
</span></span><span style="display:flex;"><span>	<span style="color:#1f2328">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#cf222e">var</span> <span style="color:#1f2328">inserti</span> <span style="color:#0550ae">*</span><span style="color:#cf222e">uint8</span>
</span></span><span style="display:flex;"><span>	<span style="color:#cf222e">var</span> <span style="color:#1f2328">insertk</span> <span style="color:#1f2328">unsafe</span><span style="color:#1f2328">.</span><span style="color:#1f2328">Pointer</span>
</span></span><span style="display:flex;"><span>	<span style="color:#cf222e">var</span> <span style="color:#1f2328">val</span> <span style="color:#1f2328">unsafe</span><span style="color:#1f2328">.</span><span style="color:#1f2328">Pointer</span>
</span></span><span style="display:flex;"><span>	<span style="color:#cf222e">for</span> <span style="color:#1f2328">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#cf222e">for</span> <span style="color:#1f2328">i</span> <span style="color:#0550ae">:=</span> <span style="color:#6639ba">uintptr</span><span style="color:#1f2328">(</span><span style="color:#0550ae">0</span><span style="color:#1f2328">);</span> <span style="color:#1f2328">i</span> <span style="color:#1f2328">&lt;</span> <span style="color:#1f2328">bucketCnt</span><span style="color:#1f2328">;</span> <span style="color:#1f2328">i</span><span style="color:#0550ae">++</span> <span style="color:#1f2328">{</span>
</span></span><span style="display:flex;"><span>			<span style="color:#cf222e">if</span> <span style="color:#1f2328">b</span><span style="color:#1f2328">.</span><span style="color:#1f2328">tophash</span><span style="color:#1f2328">[</span><span style="color:#1f2328">i</span><span style="color:#1f2328">]</span> <span style="color:#0550ae">!=</span> <span style="color:#1f2328">top</span> <span style="color:#1f2328">{</span>
</span></span><span style="display:flex;"><span>			<span style="color:#57606a">//tophash不相等，则尝试看这个地址是否是空的</span>
</span></span><span style="display:flex;"><span>				<span style="color:#cf222e">if</span> <span style="color:#1f2328">b</span><span style="color:#1f2328">.</span><span style="color:#1f2328">tophash</span><span style="color:#1f2328">[</span><span style="color:#1f2328">i</span><span style="color:#1f2328">]</span> <span style="color:#0550ae">==</span> <span style="color:#1f2328">empty</span> <span style="color:#0550ae">&amp;&amp;</span> <span style="color:#1f2328">inserti</span> <span style="color:#0550ae">==</span> <span style="color:#cf222e">nil</span> <span style="color:#1f2328">{</span>
</span></span><span style="display:flex;"><span>					<span style="color:#57606a">//这个位置是空的并且inserti的指针为空，则先让inserti指向这个位置</span>
</span></span><span style="display:flex;"><span>					<span style="color:#57606a">//如果map中没有当前key则可以用这个空位置存储key</span>
</span></span><span style="display:flex;"><span>					<span style="color:#1f2328">inserti</span> <span style="color:#1f2328">=</span> <span style="color:#0550ae">&amp;</span><span style="color:#1f2328">b</span><span style="color:#1f2328">.</span><span style="color:#1f2328">tophash</span><span style="color:#1f2328">[</span><span style="color:#1f2328">i</span><span style="color:#1f2328">]</span>
</span></span><span style="display:flex;"><span>					<span style="color:#1f2328">insertk</span> <span style="color:#1f2328">=</span> <span style="color:#6639ba">add</span><span style="color:#1f2328">(</span><span style="color:#1f2328">unsafe</span><span style="color:#1f2328">.</span><span style="color:#6639ba">Pointer</span><span style="color:#1f2328">(</span><span style="color:#1f2328">b</span><span style="color:#1f2328">),</span> <span style="color:#1f2328">dataOffset</span><span style="color:#0550ae">+</span><span style="color:#1f2328">i</span><span style="color:#0550ae">*</span><span style="color:#6639ba">uintptr</span><span style="color:#1f2328">(</span><span style="color:#1f2328">t</span><span style="color:#1f2328">.</span><span style="color:#1f2328">keysize</span><span style="color:#1f2328">))</span>
</span></span><span style="display:flex;"><span>					<span style="color:#1f2328">val</span> <span style="color:#1f2328">=</span> <span style="color:#6639ba">add</span><span style="color:#1f2328">(</span><span style="color:#1f2328">unsafe</span><span style="color:#1f2328">.</span><span style="color:#6639ba">Pointer</span><span style="color:#1f2328">(</span><span style="color:#1f2328">b</span><span style="color:#1f2328">),</span> <span style="color:#1f2328">dataOffset</span><span style="color:#0550ae">+</span><span style="color:#1f2328">bucketCnt</span><span style="color:#0550ae">*</span><span style="color:#6639ba">uintptr</span><span style="color:#1f2328">(</span><span style="color:#1f2328">t</span><span style="color:#1f2328">.</span><span style="color:#1f2328">keysize</span><span style="color:#1f2328">)</span><span style="color:#0550ae">+</span><span style="color:#1f2328">i</span><span style="color:#0550ae">*</span><span style="color:#6639ba">uintptr</span><span style="color:#1f2328">(</span><span style="color:#1f2328">t</span><span style="color:#1f2328">.</span><span style="color:#1f2328">valuesize</span><span style="color:#1f2328">))</span>
</span></span><span style="display:flex;"><span>				<span style="color:#1f2328">}</span>
</span></span><span style="display:flex;"><span>				<span style="color:#cf222e">continue</span>
</span></span><span style="display:flex;"><span>			<span style="color:#1f2328">}</span>
</span></span><span style="display:flex;"><span>			<span style="color:#57606a">//tophash一样，则通过equal看找到的k是否是key</span>
</span></span><span style="display:flex;"><span>			<span style="color:#1f2328">k</span> <span style="color:#0550ae">:=</span> <span style="color:#6639ba">add</span><span style="color:#1f2328">(</span><span style="color:#1f2328">unsafe</span><span style="color:#1f2328">.</span><span style="color:#6639ba">Pointer</span><span style="color:#1f2328">(</span><span style="color:#1f2328">b</span><span style="color:#1f2328">),</span> <span style="color:#1f2328">dataOffset</span><span style="color:#0550ae">+</span><span style="color:#1f2328">i</span><span style="color:#0550ae">*</span><span style="color:#6639ba">uintptr</span><span style="color:#1f2328">(</span><span style="color:#1f2328">t</span><span style="color:#1f2328">.</span><span style="color:#1f2328">keysize</span><span style="color:#1f2328">))</span>
</span></span><span style="display:flex;"><span>			<span style="color:#cf222e">if</span> <span style="color:#1f2328">t</span><span style="color:#1f2328">.</span><span style="color:#1f2328">indirectkey</span> <span style="color:#1f2328">{</span>
</span></span><span style="display:flex;"><span>				<span style="color:#1f2328">k</span> <span style="color:#1f2328">=</span> <span style="color:#0550ae">*</span><span style="color:#1f2328">((</span><span style="color:#0550ae">*</span><span style="color:#1f2328">unsafe</span><span style="color:#1f2328">.</span><span style="color:#1f2328">Pointer</span><span style="color:#1f2328">)(</span><span style="color:#1f2328">k</span><span style="color:#1f2328">))</span>
</span></span><span style="display:flex;"><span>			<span style="color:#1f2328">}</span>
</span></span><span style="display:flex;"><span>			<span style="color:#cf222e">if</span> <span style="color:#1f2328">!</span><span style="color:#1f2328">alg</span><span style="color:#1f2328">.</span><span style="color:#6639ba">equal</span><span style="color:#1f2328">(</span><span style="color:#1f2328">key</span><span style="color:#1f2328">,</span> <span style="color:#1f2328">k</span><span style="color:#1f2328">)</span> <span style="color:#1f2328">{</span>
</span></span><span style="display:flex;"><span>				<span style="color:#cf222e">continue</span>
</span></span><span style="display:flex;"><span>			<span style="color:#1f2328">}</span>
</span></span><span style="display:flex;"><span>			<span style="color:#57606a">//走到这一步，确定map中已经有key了，则需要更新key的值</span>
</span></span><span style="display:flex;"><span>			<span style="color:#57606a">//needkeyupdate判断是否需要重写key，不知道为什么会有重写key的操作?留坑</span>
</span></span><span style="display:flex;"><span>			<span style="color:#cf222e">if</span> <span style="color:#1f2328">t</span><span style="color:#1f2328">.</span><span style="color:#1f2328">needkeyupdate</span> <span style="color:#1f2328">{</span>
</span></span><span style="display:flex;"><span>				<span style="color:#6639ba">typedmemmove</span><span style="color:#1f2328">(</span><span style="color:#1f2328">t</span><span style="color:#1f2328">.</span><span style="color:#1f2328">key</span><span style="color:#1f2328">,</span> <span style="color:#1f2328">k</span><span style="color:#1f2328">,</span> <span style="color:#1f2328">key</span><span style="color:#1f2328">)</span>
</span></span><span style="display:flex;"><span>			<span style="color:#1f2328">}</span>
</span></span><span style="display:flex;"><span>			<span style="color:#57606a">//val作为值的地址拿出来，跳转到结束阶段</span>
</span></span><span style="display:flex;"><span>			<span style="color:#1f2328">val</span> <span style="color:#1f2328">=</span> <span style="color:#6639ba">add</span><span style="color:#1f2328">(</span><span style="color:#1f2328">unsafe</span><span style="color:#1f2328">.</span><span style="color:#6639ba">Pointer</span><span style="color:#1f2328">(</span><span style="color:#1f2328">b</span><span style="color:#1f2328">),</span> <span style="color:#1f2328">dataOffset</span><span style="color:#0550ae">+</span><span style="color:#1f2328">bucketCnt</span><span style="color:#0550ae">*</span><span style="color:#6639ba">uintptr</span><span style="color:#1f2328">(</span><span style="color:#1f2328">t</span><span style="color:#1f2328">.</span><span style="color:#1f2328">keysize</span><span style="color:#1f2328">)</span><span style="color:#0550ae">+</span><span style="color:#1f2328">i</span><span style="color:#0550ae">*</span><span style="color:#6639ba">uintptr</span><span style="color:#1f2328">(</span><span style="color:#1f2328">t</span><span style="color:#1f2328">.</span><span style="color:#1f2328">valuesize</span><span style="color:#1f2328">))</span>
</span></span><span style="display:flex;"><span>			<span style="color:#cf222e">goto</span> <span style="color:#1f2328">done</span>
</span></span><span style="display:flex;"><span>		<span style="color:#1f2328">}</span>
</span></span><span style="display:flex;"><span>		<span style="color:#57606a">//这个桶里面没找打，则看看是否有溢出桶</span>
</span></span><span style="display:flex;"><span>		<span style="color:#1f2328">ovf</span> <span style="color:#0550ae">:=</span> <span style="color:#1f2328">b</span><span style="color:#1f2328">.</span><span style="color:#6639ba">overflow</span><span style="color:#1f2328">(</span><span style="color:#1f2328">t</span><span style="color:#1f2328">)</span>
</span></span><span style="display:flex;"><span>		<span style="color:#cf222e">if</span> <span style="color:#1f2328">ovf</span> <span style="color:#0550ae">==</span> <span style="color:#cf222e">nil</span> <span style="color:#1f2328">{</span>
</span></span><span style="display:flex;"><span>			<span style="color:#57606a">//没有就跳出for，说明map里没有包含key</span>
</span></span><span style="display:flex;"><span>			<span style="color:#cf222e">break</span>
</span></span><span style="display:flex;"><span>		<span style="color:#1f2328">}</span>
</span></span><span style="display:flex;"><span>		<span style="color:#1f2328">b</span> <span style="color:#1f2328">=</span> <span style="color:#1f2328">ovf</span>
</span></span><span style="display:flex;"><span>	<span style="color:#1f2328">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#57606a">//map不在扩容状态，则判断是否需要扩容</span>
</span></span><span style="display:flex;"><span>	<span style="color:#57606a">//扩容准则1.是否超过转载因子 2.是否冗余溢出桶太多(原本很多key的map删除很多key之后的情况)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#cf222e">if</span> <span style="color:#1f2328">!</span><span style="color:#1f2328">h</span><span style="color:#1f2328">.</span><span style="color:#6639ba">growing</span><span style="color:#1f2328">()</span> <span style="color:#0550ae">&amp;&amp;</span> <span style="color:#1f2328">(</span><span style="color:#6639ba">overLoadFactor</span><span style="color:#1f2328">(</span><span style="color:#6639ba">int64</span><span style="color:#1f2328">(</span><span style="color:#1f2328">h</span><span style="color:#1f2328">.</span><span style="color:#1f2328">count</span><span style="color:#1f2328">),</span> <span style="color:#1f2328">h</span><span style="color:#1f2328">.</span><span style="color:#1f2328">B</span><span style="color:#1f2328">)</span> <span style="color:#0550ae">||</span> <span style="color:#6639ba">tooManyOverflowBuckets</span><span style="color:#1f2328">(</span><span style="color:#1f2328">h</span><span style="color:#1f2328">.</span><span style="color:#1f2328">noverflow</span><span style="color:#1f2328">,</span> <span style="color:#1f2328">h</span><span style="color:#1f2328">.</span><span style="color:#1f2328">B</span><span style="color:#1f2328">))</span> <span style="color:#1f2328">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#57606a">//扩容前操作，后面会分析，就是分配新的地址空间为扩容的搬迁做准备</span>
</span></span><span style="display:flex;"><span>		<span style="color:#6639ba">hashGrow</span><span style="color:#1f2328">(</span><span style="color:#1f2328">t</span><span style="color:#1f2328">,</span> <span style="color:#1f2328">h</span><span style="color:#1f2328">)</span>
</span></span><span style="display:flex;"><span>		<span style="color:#57606a">//重新走上面流程</span>
</span></span><span style="display:flex;"><span>		<span style="color:#cf222e">goto</span> <span style="color:#1f2328">again</span> <span style="color:#57606a">// Growing the table invalidates everything, so try again</span>
</span></span><span style="display:flex;"><span>	<span style="color:#1f2328">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#57606a">//上面的扩容流程之后的在此寻找，其实会进行两次搬迁操作后定位key</span>
</span></span><span style="display:flex;"><span>	<span style="color:#57606a">//map里没有key的话就会给inserti一个新的地址</span>
</span></span><span style="display:flex;"><span>	<span style="color:#57606a">//这里inserti等于nil则说明map没有达到扩容阈值，而桶和它的溢出桶的8个位置已经用完了，则需要再加一个溢出桶</span>
</span></span><span style="display:flex;"><span>	<span style="color:#cf222e">if</span> <span style="color:#1f2328">inserti</span> <span style="color:#0550ae">==</span> <span style="color:#cf222e">nil</span> <span style="color:#1f2328">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#57606a">//申请一个新的溢出桶</span>
</span></span><span style="display:flex;"><span>		<span style="color:#1f2328">newb</span> <span style="color:#0550ae">:=</span> <span style="color:#1f2328">h</span><span style="color:#1f2328">.</span><span style="color:#6639ba">newoverflow</span><span style="color:#1f2328">(</span><span style="color:#1f2328">t</span><span style="color:#1f2328">,</span> <span style="color:#1f2328">b</span><span style="color:#1f2328">)</span>
</span></span><span style="display:flex;"><span>		<span style="color:#57606a">//既然是新的，当然用第一位了</span>
</span></span><span style="display:flex;"><span>		<span style="color:#1f2328">inserti</span> <span style="color:#1f2328">=</span> <span style="color:#0550ae">&amp;</span><span style="color:#1f2328">newb</span><span style="color:#1f2328">.</span><span style="color:#1f2328">tophash</span><span style="color:#1f2328">[</span><span style="color:#0550ae">0</span><span style="color:#1f2328">]</span>
</span></span><span style="display:flex;"><span>		<span style="color:#1f2328">insertk</span> <span style="color:#1f2328">=</span> <span style="color:#6639ba">add</span><span style="color:#1f2328">(</span><span style="color:#1f2328">unsafe</span><span style="color:#1f2328">.</span><span style="color:#6639ba">Pointer</span><span style="color:#1f2328">(</span><span style="color:#1f2328">newb</span><span style="color:#1f2328">),</span> <span style="color:#1f2328">dataOffset</span><span style="color:#1f2328">)</span>
</span></span><span style="display:flex;"><span>		<span style="color:#1f2328">val</span> <span style="color:#1f2328">=</span> <span style="color:#6639ba">add</span><span style="color:#1f2328">(</span><span style="color:#1f2328">insertk</span><span style="color:#1f2328">,</span> <span style="color:#1f2328">bucketCnt</span><span style="color:#0550ae">*</span><span style="color:#6639ba">uintptr</span><span style="color:#1f2328">(</span><span style="color:#1f2328">t</span><span style="color:#1f2328">.</span><span style="color:#1f2328">keysize</span><span style="color:#1f2328">))</span>
</span></span><span style="display:flex;"><span>	<span style="color:#1f2328">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#57606a">//到这里，说明key不存在map里，则新建对应的key和value</span>
</span></span><span style="display:flex;"><span>	<span style="color:#57606a">//key是指针，则申请一个key类型的数据</span>
</span></span><span style="display:flex;"><span>	<span style="color:#57606a">//insertk指向该数据的地址</span>
</span></span><span style="display:flex;"><span>	<span style="color:#cf222e">if</span> <span style="color:#1f2328">t</span><span style="color:#1f2328">.</span><span style="color:#1f2328">indirectkey</span> <span style="color:#1f2328">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#1f2328">kmem</span> <span style="color:#0550ae">:=</span> <span style="color:#6639ba">newobject</span><span style="color:#1f2328">(</span><span style="color:#1f2328">t</span><span style="color:#1f2328">.</span><span style="color:#1f2328">key</span><span style="color:#1f2328">)</span>
</span></span><span style="display:flex;"><span>		<span style="color:#0550ae">*</span><span style="color:#1f2328">(</span><span style="color:#0550ae">*</span><span style="color:#1f2328">unsafe</span><span style="color:#1f2328">.</span><span style="color:#1f2328">Pointer</span><span style="color:#1f2328">)(</span><span style="color:#1f2328">insertk</span><span style="color:#1f2328">)</span> <span style="color:#1f2328">=</span> <span style="color:#1f2328">kmem</span>
</span></span><span style="display:flex;"><span>		<span style="color:#1f2328">insertk</span> <span style="color:#1f2328">=</span> <span style="color:#1f2328">kmem</span>
</span></span><span style="display:flex;"><span>	<span style="color:#1f2328">}</span>
</span></span><span style="display:flex;"><span>	<span style="color:#57606a">//同理value一样</span>
</span></span><span style="display:flex;"><span>	<span style="color:#cf222e">if</span> <span style="color:#1f2328">t</span><span style="color:#1f2328">.</span><span style="color:#1f2328">indirectvalue</span> <span style="color:#1f2328">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#1f2328">vmem</span> <span style="color:#0550ae">:=</span> <span style="color:#6639ba">newobject</span><span style="color:#1f2328">(</span><span style="color:#1f2328">t</span><span style="color:#1f2328">.</span><span style="color:#1f2328">elem</span><span style="color:#1f2328">)</span>
</span></span><span style="display:flex;"><span>		<span style="color:#0550ae">*</span><span style="color:#1f2328">(</span><span style="color:#0550ae">*</span><span style="color:#1f2328">unsafe</span><span style="color:#1f2328">.</span><span style="color:#1f2328">Pointer</span><span style="color:#1f2328">)(</span><span style="color:#1f2328">val</span><span style="color:#1f2328">)</span> <span style="color:#1f2328">=</span> <span style="color:#1f2328">vmem</span>
</span></span><span style="display:flex;"><span>	<span style="color:#1f2328">}</span>
</span></span><span style="display:flex;"><span>	<span style="color:#57606a">//拷贝key的值</span>
</span></span><span style="display:flex;"><span>	<span style="color:#6639ba">typedmemmove</span><span style="color:#1f2328">(</span><span style="color:#1f2328">t</span><span style="color:#1f2328">.</span><span style="color:#1f2328">key</span><span style="color:#1f2328">,</span> <span style="color:#1f2328">insertk</span><span style="color:#1f2328">,</span> <span style="color:#1f2328">key</span><span style="color:#1f2328">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#57606a">//设置tophash</span>
</span></span><span style="display:flex;"><span>	<span style="color:#0550ae">*</span><span style="color:#1f2328">inserti</span> <span style="color:#1f2328">=</span> <span style="color:#1f2328">top</span>
</span></span><span style="display:flex;"><span>	<span style="color:#57606a">//map的大小加一</span>
</span></span><span style="display:flex;"><span>	<span style="color:#1f2328">h</span><span style="color:#1f2328">.</span><span style="color:#1f2328">count</span><span style="color:#0550ae">++</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#1f2328">done</span><span style="color:#1f2328">:</span>
</span></span><span style="display:flex;"><span>	<span style="color:#57606a">//判断写标记位是否存在，如果被清除了，说明并发写的情况</span>
</span></span><span style="display:flex;"><span>	<span style="color:#57606a">//直接抛错误</span>
</span></span><span style="display:flex;"><span>	<span style="color:#cf222e">if</span> <span style="color:#1f2328">h</span><span style="color:#1f2328">.</span><span style="color:#1f2328">flags</span><span style="color:#0550ae">&amp;</span><span style="color:#1f2328">hashWriting</span> <span style="color:#0550ae">==</span> <span style="color:#0550ae">0</span> <span style="color:#1f2328">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#6639ba">throw</span><span style="color:#1f2328">(</span><span style="color:#0a3069">&#34;concurrent map writes&#34;</span><span style="color:#1f2328">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#1f2328">}</span>
</span></span><span style="display:flex;"><span>	<span style="color:#57606a">//清除写标志位</span>
</span></span><span style="display:flex;"><span>	<span style="color:#1f2328">h</span><span style="color:#1f2328">.</span><span style="color:#1f2328">flags</span> <span style="color:#0550ae">&amp;^=</span> <span style="color:#1f2328">hashWriting</span>
</span></span><span style="display:flex;"><span>	<span style="color:#57606a">//</span>
</span></span><span style="display:flex;"><span>	<span style="color:#cf222e">if</span> <span style="color:#1f2328">t</span><span style="color:#1f2328">.</span><span style="color:#1f2328">indirectvalue</span> <span style="color:#1f2328">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#1f2328">val</span> <span style="color:#1f2328">=</span> <span style="color:#0550ae">*</span><span style="color:#1f2328">((</span><span style="color:#0550ae">*</span><span style="color:#1f2328">unsafe</span><span style="color:#1f2328">.</span><span style="color:#1f2328">Pointer</span><span style="color:#1f2328">)(</span><span style="color:#1f2328">val</span><span style="color:#1f2328">))</span>
</span></span><span style="display:flex;"><span>	<span style="color:#1f2328">}</span>
</span></span><span style="display:flex;"><span>	<span style="color:#57606a">//返回val的地址，具体赋值是编译器的额外汇编指令处理</span>
</span></span><span style="display:flex;"><span>	<span style="color:#cf222e">return</span> <span style="color:#1f2328">val</span>
</span></span><span style="display:flex;"><span><span style="color:#1f2328">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h4 id="map删除">map删除</h4>
<div class="highlight"><div style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">16
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">17
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">18
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">19
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">20
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">21
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">22
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">23
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">24
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">25
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">26
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">27
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">28
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">29
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">30
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">31
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">32
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">33
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">34
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">35
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">36
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">37
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">38
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">39
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">40
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">41
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">42
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">43
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">44
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">45
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">46
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">47
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">48
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">49
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">50
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">51
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">52
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">53
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">54
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">55
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">56
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">57
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">58
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">59
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">60
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">61
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">62
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">63
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">64
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">65
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">66
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">67
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">68
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">69
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">70
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">71
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">72
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">73
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">74
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">75
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#cf222e">func</span> <span style="color:#6639ba">mapdelete</span><span style="color:#1f2328">(</span><span style="color:#1f2328">t</span> <span style="color:#0550ae">*</span><span style="color:#1f2328">maptype</span><span style="color:#1f2328">,</span> <span style="color:#1f2328">h</span> <span style="color:#0550ae">*</span><span style="color:#1f2328">hmap</span><span style="color:#1f2328">,</span> <span style="color:#1f2328">key</span> <span style="color:#1f2328">unsafe</span><span style="color:#1f2328">.</span><span style="color:#1f2328">Pointer</span><span style="color:#1f2328">)</span> <span style="color:#1f2328">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#57606a">//好像又是不要的部分代码</span>
</span></span><span style="display:flex;"><span>	<span style="color:#0550ae">...</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#57606a">//map为nil或者带下为0则直接返回了</span>
</span></span><span style="display:flex;"><span>	<span style="color:#cf222e">if</span> <span style="color:#1f2328">h</span> <span style="color:#0550ae">==</span> <span style="color:#cf222e">nil</span> <span style="color:#0550ae">||</span> <span style="color:#1f2328">h</span><span style="color:#1f2328">.</span><span style="color:#1f2328">count</span> <span style="color:#0550ae">==</span> <span style="color:#0550ae">0</span> <span style="color:#1f2328">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#cf222e">return</span>
</span></span><span style="display:flex;"><span>	<span style="color:#1f2328">}</span>
</span></span><span style="display:flex;"><span>	<span style="color:#57606a">//有协程在写，则抛异常，delete也是视为对map的写操作</span>
</span></span><span style="display:flex;"><span>	<span style="color:#cf222e">if</span> <span style="color:#1f2328">h</span><span style="color:#1f2328">.</span><span style="color:#1f2328">flags</span><span style="color:#0550ae">&amp;</span><span style="color:#1f2328">hashWriting</span> <span style="color:#0550ae">!=</span> <span style="color:#0550ae">0</span> <span style="color:#1f2328">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#6639ba">throw</span><span style="color:#1f2328">(</span><span style="color:#0a3069">&#34;concurrent map writes&#34;</span><span style="color:#1f2328">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#1f2328">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#1f2328">alg</span> <span style="color:#0550ae">:=</span> <span style="color:#1f2328">t</span><span style="color:#1f2328">.</span><span style="color:#1f2328">key</span><span style="color:#1f2328">.</span><span style="color:#1f2328">alg</span>
</span></span><span style="display:flex;"><span>	<span style="color:#1f2328">hash</span> <span style="color:#0550ae">:=</span> <span style="color:#1f2328">alg</span><span style="color:#1f2328">.</span><span style="color:#6639ba">hash</span><span style="color:#1f2328">(</span><span style="color:#1f2328">key</span><span style="color:#1f2328">,</span> <span style="color:#6639ba">uintptr</span><span style="color:#1f2328">(</span><span style="color:#1f2328">h</span><span style="color:#1f2328">.</span><span style="color:#1f2328">hash0</span><span style="color:#1f2328">))</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#57606a">//设置写标记位</span>
</span></span><span style="display:flex;"><span>	<span style="color:#1f2328">h</span><span style="color:#1f2328">.</span><span style="color:#1f2328">flags</span> <span style="color:#0550ae">|=</span> <span style="color:#1f2328">hashWriting</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#1f2328">bucket</span> <span style="color:#0550ae">:=</span> <span style="color:#1f2328">hash</span> <span style="color:#0550ae">&amp;</span> <span style="color:#1f2328">(</span><span style="color:#6639ba">uintptr</span><span style="color:#1f2328">(</span><span style="color:#0550ae">1</span><span style="color:#1f2328">)</span><span style="color:#0550ae">&lt;&lt;</span><span style="color:#1f2328">h</span><span style="color:#1f2328">.</span><span style="color:#1f2328">B</span> <span style="color:#0550ae">-</span> <span style="color:#0550ae">1</span><span style="color:#1f2328">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#57606a">//如果是搬迁状态则尝试搬迁这个桶</span>
</span></span><span style="display:flex;"><span>	<span style="color:#cf222e">if</span> <span style="color:#1f2328">h</span><span style="color:#1f2328">.</span><span style="color:#6639ba">growing</span><span style="color:#1f2328">()</span> <span style="color:#1f2328">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#6639ba">growWork</span><span style="color:#1f2328">(</span><span style="color:#1f2328">t</span><span style="color:#1f2328">,</span> <span style="color:#1f2328">h</span><span style="color:#1f2328">,</span> <span style="color:#1f2328">bucket</span><span style="color:#1f2328">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#1f2328">}</span>
</span></span><span style="display:flex;"><span>	<span style="color:#57606a">//以下阶段经典的找key阶段</span>
</span></span><span style="display:flex;"><span>	<span style="color:#1f2328">b</span> <span style="color:#0550ae">:=</span> <span style="color:#1f2328">(</span><span style="color:#0550ae">*</span><span style="color:#1f2328">bmap</span><span style="color:#1f2328">)(</span><span style="color:#1f2328">unsafe</span><span style="color:#1f2328">.</span><span style="color:#6639ba">Pointer</span><span style="color:#1f2328">(</span><span style="color:#6639ba">uintptr</span><span style="color:#1f2328">(</span><span style="color:#1f2328">h</span><span style="color:#1f2328">.</span><span style="color:#1f2328">buckets</span><span style="color:#1f2328">)</span> <span style="color:#0550ae">+</span> <span style="color:#1f2328">bucket</span><span style="color:#0550ae">*</span><span style="color:#6639ba">uintptr</span><span style="color:#1f2328">(</span><span style="color:#1f2328">t</span><span style="color:#1f2328">.</span><span style="color:#1f2328">bucketsize</span><span style="color:#1f2328">)))</span>
</span></span><span style="display:flex;"><span>	<span style="color:#1f2328">top</span> <span style="color:#0550ae">:=</span> <span style="color:#6639ba">uint8</span><span style="color:#1f2328">(</span><span style="color:#1f2328">hash</span> <span style="color:#0550ae">&gt;&gt;</span> <span style="color:#1f2328">(</span><span style="color:#1f2328">sys</span><span style="color:#1f2328">.</span><span style="color:#1f2328">PtrSize</span><span style="color:#0550ae">*</span><span style="color:#0550ae">8</span> <span style="color:#0550ae">-</span> <span style="color:#0550ae">8</span><span style="color:#1f2328">))</span>
</span></span><span style="display:flex;"><span>	<span style="color:#cf222e">if</span> <span style="color:#1f2328">top</span> <span style="color:#1f2328">&lt;</span> <span style="color:#1f2328">minTopHash</span> <span style="color:#1f2328">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#1f2328">top</span> <span style="color:#0550ae">+=</span> <span style="color:#1f2328">minTopHash</span>
</span></span><span style="display:flex;"><span>	<span style="color:#1f2328">}</span>
</span></span><span style="display:flex;"><span>	<span style="color:#cf222e">for</span> <span style="color:#1f2328">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#cf222e">for</span> <span style="color:#1f2328">i</span> <span style="color:#0550ae">:=</span> <span style="color:#6639ba">uintptr</span><span style="color:#1f2328">(</span><span style="color:#0550ae">0</span><span style="color:#1f2328">);</span> <span style="color:#1f2328">i</span> <span style="color:#1f2328">&lt;</span> <span style="color:#1f2328">bucketCnt</span><span style="color:#1f2328">;</span> <span style="color:#1f2328">i</span><span style="color:#0550ae">++</span> <span style="color:#1f2328">{</span>
</span></span><span style="display:flex;"><span>			<span style="color:#cf222e">if</span> <span style="color:#1f2328">b</span><span style="color:#1f2328">.</span><span style="color:#1f2328">tophash</span><span style="color:#1f2328">[</span><span style="color:#1f2328">i</span><span style="color:#1f2328">]</span> <span style="color:#0550ae">!=</span> <span style="color:#1f2328">top</span> <span style="color:#1f2328">{</span>
</span></span><span style="display:flex;"><span>				<span style="color:#cf222e">continue</span>
</span></span><span style="display:flex;"><span>			<span style="color:#1f2328">}</span>
</span></span><span style="display:flex;"><span>			<span style="color:#1f2328">k</span> <span style="color:#0550ae">:=</span> <span style="color:#6639ba">add</span><span style="color:#1f2328">(</span><span style="color:#1f2328">unsafe</span><span style="color:#1f2328">.</span><span style="color:#6639ba">Pointer</span><span style="color:#1f2328">(</span><span style="color:#1f2328">b</span><span style="color:#1f2328">),</span> <span style="color:#1f2328">dataOffset</span><span style="color:#0550ae">+</span><span style="color:#1f2328">i</span><span style="color:#0550ae">*</span><span style="color:#6639ba">uintptr</span><span style="color:#1f2328">(</span><span style="color:#1f2328">t</span><span style="color:#1f2328">.</span><span style="color:#1f2328">keysize</span><span style="color:#1f2328">))</span>
</span></span><span style="display:flex;"><span>			<span style="color:#1f2328">k2</span> <span style="color:#0550ae">:=</span> <span style="color:#1f2328">k</span>
</span></span><span style="display:flex;"><span>			<span style="color:#cf222e">if</span> <span style="color:#1f2328">t</span><span style="color:#1f2328">.</span><span style="color:#1f2328">indirectkey</span> <span style="color:#1f2328">{</span>
</span></span><span style="display:flex;"><span>				<span style="color:#1f2328">k2</span> <span style="color:#1f2328">=</span> <span style="color:#0550ae">*</span><span style="color:#1f2328">((</span><span style="color:#0550ae">*</span><span style="color:#1f2328">unsafe</span><span style="color:#1f2328">.</span><span style="color:#1f2328">Pointer</span><span style="color:#1f2328">)(</span><span style="color:#1f2328">k2</span><span style="color:#1f2328">))</span>
</span></span><span style="display:flex;"><span>			<span style="color:#1f2328">}</span>
</span></span><span style="display:flex;"><span>			<span style="color:#cf222e">if</span> <span style="color:#1f2328">!</span><span style="color:#1f2328">alg</span><span style="color:#1f2328">.</span><span style="color:#6639ba">equal</span><span style="color:#1f2328">(</span><span style="color:#1f2328">key</span><span style="color:#1f2328">,</span> <span style="color:#1f2328">k2</span><span style="color:#1f2328">)</span> <span style="color:#1f2328">{</span>
</span></span><span style="display:flex;"><span>				<span style="color:#cf222e">continue</span>
</span></span><span style="display:flex;"><span>			<span style="color:#1f2328">}</span>
</span></span><span style="display:flex;"><span>			<span style="color:#cf222e">if</span> <span style="color:#1f2328">t</span><span style="color:#1f2328">.</span><span style="color:#1f2328">indirectkey</span> <span style="color:#1f2328">{</span>
</span></span><span style="display:flex;"><span>				<span style="color:#0550ae">*</span><span style="color:#1f2328">(</span><span style="color:#0550ae">*</span><span style="color:#1f2328">unsafe</span><span style="color:#1f2328">.</span><span style="color:#1f2328">Pointer</span><span style="color:#1f2328">)(</span><span style="color:#1f2328">k</span><span style="color:#1f2328">)</span> <span style="color:#1f2328">=</span> <span style="color:#cf222e">nil</span>
</span></span><span style="display:flex;"><span>			<span style="color:#1f2328">}</span> <span style="color:#cf222e">else</span> <span style="color:#1f2328">{</span>
</span></span><span style="display:flex;"><span>				<span style="color:#6639ba">typedmemclr</span><span style="color:#1f2328">(</span><span style="color:#1f2328">t</span><span style="color:#1f2328">.</span><span style="color:#1f2328">key</span><span style="color:#1f2328">,</span> <span style="color:#1f2328">k</span><span style="color:#1f2328">)</span>
</span></span><span style="display:flex;"><span>			<span style="color:#1f2328">}</span>
</span></span><span style="display:flex;"><span>			<span style="color:#1f2328">v</span> <span style="color:#0550ae">:=</span> <span style="color:#1f2328">unsafe</span><span style="color:#1f2328">.</span><span style="color:#6639ba">Pointer</span><span style="color:#1f2328">(</span><span style="color:#6639ba">uintptr</span><span style="color:#1f2328">(</span><span style="color:#1f2328">unsafe</span><span style="color:#1f2328">.</span><span style="color:#6639ba">Pointer</span><span style="color:#1f2328">(</span><span style="color:#1f2328">b</span><span style="color:#1f2328">))</span> <span style="color:#0550ae">+</span> <span style="color:#1f2328">dataOffset</span> <span style="color:#0550ae">+</span> <span style="color:#1f2328">bucketCnt</span><span style="color:#0550ae">*</span><span style="color:#6639ba">uintptr</span><span style="color:#1f2328">(</span><span style="color:#1f2328">t</span><span style="color:#1f2328">.</span><span style="color:#1f2328">keysize</span><span style="color:#1f2328">)</span> <span style="color:#0550ae">+</span> <span style="color:#1f2328">i</span><span style="color:#0550ae">*</span><span style="color:#6639ba">uintptr</span><span style="color:#1f2328">(</span><span style="color:#1f2328">t</span><span style="color:#1f2328">.</span><span style="color:#1f2328">valuesize</span><span style="color:#1f2328">))</span>
</span></span><span style="display:flex;"><span>			<span style="color:#cf222e">if</span> <span style="color:#1f2328">t</span><span style="color:#1f2328">.</span><span style="color:#1f2328">indirectvalue</span> <span style="color:#1f2328">{</span>
</span></span><span style="display:flex;"><span>				<span style="color:#0550ae">*</span><span style="color:#1f2328">(</span><span style="color:#0550ae">*</span><span style="color:#1f2328">unsafe</span><span style="color:#1f2328">.</span><span style="color:#1f2328">Pointer</span><span style="color:#1f2328">)(</span><span style="color:#1f2328">v</span><span style="color:#1f2328">)</span> <span style="color:#1f2328">=</span> <span style="color:#cf222e">nil</span>
</span></span><span style="display:flex;"><span>			<span style="color:#1f2328">}</span> <span style="color:#cf222e">else</span> <span style="color:#1f2328">{</span>
</span></span><span style="display:flex;"><span>				<span style="color:#6639ba">typedmemclr</span><span style="color:#1f2328">(</span><span style="color:#1f2328">t</span><span style="color:#1f2328">.</span><span style="color:#1f2328">elem</span><span style="color:#1f2328">,</span> <span style="color:#1f2328">v</span><span style="color:#1f2328">)</span>
</span></span><span style="display:flex;"><span>			<span style="color:#1f2328">}</span>
</span></span><span style="display:flex;"><span>			<span style="color:#57606a">//对应tophash置空</span>
</span></span><span style="display:flex;"><span>			<span style="color:#1f2328">b</span><span style="color:#1f2328">.</span><span style="color:#1f2328">tophash</span><span style="color:#1f2328">[</span><span style="color:#1f2328">i</span><span style="color:#1f2328">]</span> <span style="color:#1f2328">=</span> <span style="color:#1f2328">empty</span>
</span></span><span style="display:flex;"><span>			<span style="color:#57606a">//大小减一</span>
</span></span><span style="display:flex;"><span>			<span style="color:#1f2328">h</span><span style="color:#1f2328">.</span><span style="color:#1f2328">count</span><span style="color:#0550ae">--</span>
</span></span><span style="display:flex;"><span>			<span style="color:#57606a">//调整结束阶段</span>
</span></span><span style="display:flex;"><span>			<span style="color:#cf222e">goto</span> <span style="color:#1f2328">done</span>
</span></span><span style="display:flex;"><span>		<span style="color:#1f2328">}</span>
</span></span><span style="display:flex;"><span>		<span style="color:#1f2328">b</span> <span style="color:#1f2328">=</span> <span style="color:#1f2328">b</span><span style="color:#1f2328">.</span><span style="color:#6639ba">overflow</span><span style="color:#1f2328">(</span><span style="color:#1f2328">t</span><span style="color:#1f2328">)</span>
</span></span><span style="display:flex;"><span>		<span style="color:#cf222e">if</span> <span style="color:#1f2328">b</span> <span style="color:#0550ae">==</span> <span style="color:#cf222e">nil</span> <span style="color:#1f2328">{</span>
</span></span><span style="display:flex;"><span>			<span style="color:#cf222e">goto</span> <span style="color:#1f2328">done</span>
</span></span><span style="display:flex;"><span>		<span style="color:#1f2328">}</span>
</span></span><span style="display:flex;"><span>	<span style="color:#1f2328">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#1f2328">done</span><span style="color:#1f2328">:</span>
</span></span><span style="display:flex;"><span>	<span style="color:#57606a">//判断以下是否并发写</span>
</span></span><span style="display:flex;"><span>	<span style="color:#cf222e">if</span> <span style="color:#1f2328">h</span><span style="color:#1f2328">.</span><span style="color:#1f2328">flags</span><span style="color:#0550ae">&amp;</span><span style="color:#1f2328">hashWriting</span> <span style="color:#0550ae">==</span> <span style="color:#0550ae">0</span> <span style="color:#1f2328">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#6639ba">throw</span><span style="color:#1f2328">(</span><span style="color:#0a3069">&#34;concurrent map writes&#34;</span><span style="color:#1f2328">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#1f2328">}</span>
</span></span><span style="display:flex;"><span>	<span style="color:#57606a">//清空写标志位</span>
</span></span><span style="display:flex;"><span>	<span style="color:#1f2328">h</span><span style="color:#1f2328">.</span><span style="color:#1f2328">flags</span> <span style="color:#0550ae">&amp;^=</span> <span style="color:#1f2328">hashWriting</span>
</span></span><span style="display:flex;"><span><span style="color:#1f2328">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h4 id="map扩容">map扩容</h4>
<div class="highlight"><div style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">  1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">  2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">  3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">  4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">  5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">  6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">  7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">  8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">  9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 16
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 17
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 18
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 19
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 20
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 21
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 22
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 23
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 24
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 25
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 26
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 27
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 28
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 29
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 30
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 31
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 32
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 33
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 34
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 35
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 36
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 37
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 38
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 39
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 40
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 41
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 42
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 43
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 44
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 45
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 46
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 47
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 48
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 49
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 50
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 51
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 52
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 53
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 54
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 55
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 56
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 57
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 58
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 59
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 60
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 61
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 62
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 63
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 64
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 65
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 66
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 67
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 68
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 69
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 70
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 71
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 72
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 73
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 74
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 75
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 76
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 77
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 78
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 79
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 80
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 81
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 82
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 83
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 84
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 85
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 86
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 87
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 88
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 89
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 90
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 91
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 92
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 93
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 94
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 95
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 96
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 97
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 98
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 99
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">100
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">101
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">102
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">103
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">104
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">105
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">106
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">107
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">108
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">109
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">110
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">111
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">112
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">113
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">114
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">115
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">116
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">117
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">118
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">119
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">120
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">121
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">122
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">123
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">124
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">125
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">126
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">127
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">128
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">129
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">130
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">131
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">132
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">133
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">134
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">135
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">136
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">137
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">138
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">139
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">140
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">141
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">142
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">143
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">144
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">145
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">146
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">147
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">148
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">149
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">150
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">151
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">152
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">153
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">154
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">155
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">156
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">157
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">158
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">159
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">160
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">161
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">162
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">163
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">164
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">165
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">166
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">167
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">168
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">169
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">170
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">171
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">172
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">173
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">174
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">175
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">176
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">177
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">178
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">179
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">180
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">181
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">182
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">183
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">184
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">185
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">186
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">187
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">188
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">189
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">190
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">191
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">192
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">193
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">194
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">195
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">196
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">197
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">198
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">199
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">200
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">201
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">202
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">203
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">204
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">205
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">206
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">207
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">208
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">209
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">210
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">211
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">212
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">213
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">214
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">215
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">216
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">217
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">218
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">219
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">220
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">221
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">222
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">223
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">224
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#cf222e">func</span> <span style="color:#6639ba">hashGrow</span><span style="color:#1f2328">(</span><span style="color:#1f2328">t</span> <span style="color:#0550ae">*</span><span style="color:#1f2328">maptype</span><span style="color:#1f2328">,</span> <span style="color:#1f2328">h</span> <span style="color:#0550ae">*</span><span style="color:#1f2328">hmap</span><span style="color:#1f2328">)</span> <span style="color:#1f2328">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#1f2328">bigger</span> <span style="color:#0550ae">:=</span> <span style="color:#6639ba">uint8</span><span style="color:#1f2328">(</span><span style="color:#0550ae">1</span><span style="color:#1f2328">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#cf222e">if</span> <span style="color:#1f2328">!</span><span style="color:#6639ba">overLoadFactor</span><span style="color:#1f2328">(</span><span style="color:#6639ba">int64</span><span style="color:#1f2328">(</span><span style="color:#1f2328">h</span><span style="color:#1f2328">.</span><span style="color:#1f2328">count</span><span style="color:#1f2328">),</span> <span style="color:#1f2328">h</span><span style="color:#1f2328">.</span><span style="color:#1f2328">B</span><span style="color:#1f2328">)</span> <span style="color:#1f2328">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#57606a">//不是因为超过装载因子而扩容，则bigger置0</span>
</span></span><span style="display:flex;"><span>		<span style="color:#1f2328">bigger</span> <span style="color:#1f2328">=</span> <span style="color:#0550ae">0</span>
</span></span><span style="display:flex;"><span>		<span style="color:#57606a">//设置同大小扩容标志位</span>
</span></span><span style="display:flex;"><span>		<span style="color:#1f2328">h</span><span style="color:#1f2328">.</span><span style="color:#1f2328">flags</span> <span style="color:#0550ae">|=</span> <span style="color:#1f2328">sameSizeGrow</span>
</span></span><span style="display:flex;"><span>	<span style="color:#1f2328">}</span>
</span></span><span style="display:flex;"><span>	<span style="color:#57606a">//当前桶数组地址复制到老桶数组地址</span>
</span></span><span style="display:flex;"><span>	<span style="color:#1f2328">oldbuckets</span> <span style="color:#0550ae">:=</span> <span style="color:#1f2328">h</span><span style="color:#1f2328">.</span><span style="color:#1f2328">buckets</span>
</span></span><span style="display:flex;"><span>	<span style="color:#57606a">//申请新地址空间</span>
</span></span><span style="display:flex;"><span>	<span style="color:#1f2328">newbuckets</span><span style="color:#1f2328">,</span> <span style="color:#1f2328">nextOverflow</span> <span style="color:#0550ae">:=</span> <span style="color:#6639ba">makeBucketArray</span><span style="color:#1f2328">(</span><span style="color:#1f2328">t</span><span style="color:#1f2328">,</span> <span style="color:#1f2328">h</span><span style="color:#1f2328">.</span><span style="color:#1f2328">B</span><span style="color:#0550ae">+</span><span style="color:#1f2328">bigger</span><span style="color:#1f2328">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#57606a">//当前flags清空两个标志位</span>
</span></span><span style="display:flex;"><span>	<span style="color:#1f2328">flags</span> <span style="color:#0550ae">:=</span> <span style="color:#1f2328">h</span><span style="color:#1f2328">.</span><span style="color:#1f2328">flags</span> <span style="color:#0550ae">&amp;^</span> <span style="color:#1f2328">(</span><span style="color:#1f2328">iterator</span> <span style="color:#1f2328">|</span> <span style="color:#1f2328">oldIterator</span><span style="color:#1f2328">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#57606a">//如果map有迭代器在读</span>
</span></span><span style="display:flex;"><span>	<span style="color:#cf222e">if</span> <span style="color:#1f2328">h</span><span style="color:#1f2328">.</span><span style="color:#1f2328">flags</span><span style="color:#0550ae">&amp;</span><span style="color:#1f2328">iterator</span> <span style="color:#0550ae">!=</span> <span style="color:#0550ae">0</span> <span style="color:#1f2328">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#57606a">//flags的老迭代器标志位置1</span>
</span></span><span style="display:flex;"><span>		<span style="color:#1f2328">flags</span> <span style="color:#0550ae">|=</span> <span style="color:#1f2328">oldIterator</span>
</span></span><span style="display:flex;"><span>	<span style="color:#1f2328">}</span>
</span></span><span style="display:flex;"><span>	<span style="color:#57606a">//设置map的新属性值</span>
</span></span><span style="display:flex;"><span>	<span style="color:#1f2328">h</span><span style="color:#1f2328">.</span><span style="color:#1f2328">B</span> <span style="color:#0550ae">+=</span> <span style="color:#1f2328">bigger</span>
</span></span><span style="display:flex;"><span>	<span style="color:#1f2328">h</span><span style="color:#1f2328">.</span><span style="color:#1f2328">flags</span> <span style="color:#1f2328">=</span> <span style="color:#1f2328">flags</span>
</span></span><span style="display:flex;"><span>	<span style="color:#1f2328">h</span><span style="color:#1f2328">.</span><span style="color:#1f2328">oldbuckets</span> <span style="color:#1f2328">=</span> <span style="color:#1f2328">oldbuckets</span>
</span></span><span style="display:flex;"><span>	<span style="color:#1f2328">h</span><span style="color:#1f2328">.</span><span style="color:#1f2328">buckets</span> <span style="color:#1f2328">=</span> <span style="color:#1f2328">newbuckets</span>
</span></span><span style="display:flex;"><span>	<span style="color:#1f2328">h</span><span style="color:#1f2328">.</span><span style="color:#1f2328">nevacuate</span> <span style="color:#1f2328">=</span> <span style="color:#0550ae">0</span>
</span></span><span style="display:flex;"><span>	<span style="color:#1f2328">h</span><span style="color:#1f2328">.</span><span style="color:#1f2328">noverflow</span> <span style="color:#1f2328">=</span> <span style="color:#0550ae">0</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#cf222e">if</span> <span style="color:#1f2328">h</span><span style="color:#1f2328">.</span><span style="color:#1f2328">extra</span> <span style="color:#0550ae">!=</span> <span style="color:#cf222e">nil</span> <span style="color:#0550ae">&amp;&amp;</span> <span style="color:#1f2328">h</span><span style="color:#1f2328">.</span><span style="color:#1f2328">extra</span><span style="color:#1f2328">.</span><span style="color:#1f2328">overflow</span><span style="color:#1f2328">[</span><span style="color:#0550ae">0</span><span style="color:#1f2328">]</span> <span style="color:#0550ae">!=</span> <span style="color:#cf222e">nil</span> <span style="color:#1f2328">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#cf222e">if</span> <span style="color:#1f2328">h</span><span style="color:#1f2328">.</span><span style="color:#1f2328">extra</span><span style="color:#1f2328">.</span><span style="color:#1f2328">overflow</span><span style="color:#1f2328">[</span><span style="color:#0550ae">1</span><span style="color:#1f2328">]</span> <span style="color:#0550ae">!=</span> <span style="color:#cf222e">nil</span> <span style="color:#1f2328">{</span>
</span></span><span style="display:flex;"><span>			<span style="color:#6639ba">throw</span><span style="color:#1f2328">(</span><span style="color:#0a3069">&#34;overflow is not nil&#34;</span><span style="color:#1f2328">)</span>
</span></span><span style="display:flex;"><span>		<span style="color:#1f2328">}</span>
</span></span><span style="display:flex;"><span>		<span style="color:#1f2328">h</span><span style="color:#1f2328">.</span><span style="color:#1f2328">extra</span><span style="color:#1f2328">.</span><span style="color:#1f2328">overflow</span><span style="color:#1f2328">[</span><span style="color:#0550ae">1</span><span style="color:#1f2328">]</span> <span style="color:#1f2328">=</span> <span style="color:#1f2328">h</span><span style="color:#1f2328">.</span><span style="color:#1f2328">extra</span><span style="color:#1f2328">.</span><span style="color:#1f2328">overflow</span><span style="color:#1f2328">[</span><span style="color:#0550ae">0</span><span style="color:#1f2328">]</span>
</span></span><span style="display:flex;"><span>		<span style="color:#1f2328">h</span><span style="color:#1f2328">.</span><span style="color:#1f2328">extra</span><span style="color:#1f2328">.</span><span style="color:#1f2328">overflow</span><span style="color:#1f2328">[</span><span style="color:#0550ae">0</span><span style="color:#1f2328">]</span> <span style="color:#1f2328">=</span> <span style="color:#cf222e">nil</span>
</span></span><span style="display:flex;"><span>	<span style="color:#1f2328">}</span>
</span></span><span style="display:flex;"><span>	<span style="color:#cf222e">if</span> <span style="color:#1f2328">nextOverflow</span> <span style="color:#0550ae">!=</span> <span style="color:#cf222e">nil</span> <span style="color:#1f2328">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#cf222e">if</span> <span style="color:#1f2328">h</span><span style="color:#1f2328">.</span><span style="color:#1f2328">extra</span> <span style="color:#0550ae">==</span> <span style="color:#cf222e">nil</span> <span style="color:#1f2328">{</span>
</span></span><span style="display:flex;"><span>			<span style="color:#1f2328">h</span><span style="color:#1f2328">.</span><span style="color:#1f2328">extra</span> <span style="color:#1f2328">=</span> <span style="color:#6639ba">new</span><span style="color:#1f2328">(</span><span style="color:#1f2328">mapextra</span><span style="color:#1f2328">)</span>
</span></span><span style="display:flex;"><span>		<span style="color:#1f2328">}</span>
</span></span><span style="display:flex;"><span>		<span style="color:#1f2328">h</span><span style="color:#1f2328">.</span><span style="color:#1f2328">extra</span><span style="color:#1f2328">.</span><span style="color:#1f2328">nextOverflow</span> <span style="color:#1f2328">=</span> <span style="color:#1f2328">nextOverflow</span>
</span></span><span style="display:flex;"><span>	<span style="color:#1f2328">}</span>
</span></span><span style="display:flex;"><span><span style="color:#1f2328">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#cf222e">func</span> <span style="color:#1f2328">(</span><span style="color:#1f2328">h</span> <span style="color:#0550ae">*</span><span style="color:#1f2328">hmap</span><span style="color:#1f2328">)</span> <span style="color:#6639ba">growing</span><span style="color:#1f2328">()</span> <span style="color:#cf222e">bool</span> <span style="color:#1f2328">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#cf222e">return</span> <span style="color:#1f2328">h</span><span style="color:#1f2328">.</span><span style="color:#1f2328">oldbuckets</span> <span style="color:#0550ae">!=</span> <span style="color:#cf222e">nil</span>
</span></span><span style="display:flex;"><span><span style="color:#1f2328">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#cf222e">func</span> <span style="color:#6639ba">growWork</span><span style="color:#1f2328">(</span><span style="color:#1f2328">t</span> <span style="color:#0550ae">*</span><span style="color:#1f2328">maptype</span><span style="color:#1f2328">,</span> <span style="color:#1f2328">h</span> <span style="color:#0550ae">*</span><span style="color:#1f2328">hmap</span><span style="color:#1f2328">,</span> <span style="color:#1f2328">bucket</span> <span style="color:#cf222e">uintptr</span><span style="color:#1f2328">)</span> <span style="color:#1f2328">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#57606a">//搬迁bucket桶</span>
</span></span><span style="display:flex;"><span>	<span style="color:#57606a">//和老桶掩码运算，确保搬迁老的桶下标</span>
</span></span><span style="display:flex;"><span>	<span style="color:#6639ba">evacuate</span><span style="color:#1f2328">(</span><span style="color:#1f2328">t</span><span style="color:#1f2328">,</span> <span style="color:#1f2328">h</span><span style="color:#1f2328">,</span> <span style="color:#1f2328">bucket</span><span style="color:#0550ae">&amp;</span><span style="color:#1f2328">h</span><span style="color:#1f2328">.</span><span style="color:#6639ba">oldbucketmask</span><span style="color:#1f2328">())</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#57606a">//没有搬迁完，则在搬一个，这次搬最小未搬迁的桶</span>
</span></span><span style="display:flex;"><span>	<span style="color:#cf222e">if</span> <span style="color:#1f2328">h</span><span style="color:#1f2328">.</span><span style="color:#6639ba">growing</span><span style="color:#1f2328">()</span> <span style="color:#1f2328">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#6639ba">evacuate</span><span style="color:#1f2328">(</span><span style="color:#1f2328">t</span><span style="color:#1f2328">,</span> <span style="color:#1f2328">h</span><span style="color:#1f2328">,</span> <span style="color:#1f2328">h</span><span style="color:#1f2328">.</span><span style="color:#1f2328">nevacuate</span><span style="color:#1f2328">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#1f2328">}</span>
</span></span><span style="display:flex;"><span><span style="color:#1f2328">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#cf222e">func</span> <span style="color:#6639ba">evacuate</span><span style="color:#1f2328">(</span><span style="color:#1f2328">t</span> <span style="color:#0550ae">*</span><span style="color:#1f2328">maptype</span><span style="color:#1f2328">,</span> <span style="color:#1f2328">h</span> <span style="color:#0550ae">*</span><span style="color:#1f2328">hmap</span><span style="color:#1f2328">,</span> <span style="color:#1f2328">oldbucket</span> <span style="color:#cf222e">uintptr</span><span style="color:#1f2328">)</span> <span style="color:#1f2328">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#57606a">//获取老桶数组中oldbucket的桶地址</span>
</span></span><span style="display:flex;"><span>	<span style="color:#1f2328">b</span> <span style="color:#0550ae">:=</span> <span style="color:#1f2328">(</span><span style="color:#0550ae">*</span><span style="color:#1f2328">bmap</span><span style="color:#1f2328">)(</span><span style="color:#6639ba">add</span><span style="color:#1f2328">(</span><span style="color:#1f2328">h</span><span style="color:#1f2328">.</span><span style="color:#1f2328">oldbuckets</span><span style="color:#1f2328">,</span> <span style="color:#1f2328">oldbucket</span><span style="color:#0550ae">*</span><span style="color:#6639ba">uintptr</span><span style="color:#1f2328">(</span><span style="color:#1f2328">t</span><span style="color:#1f2328">.</span><span style="color:#1f2328">bucketsize</span><span style="color:#1f2328">)))</span> <span style="color:#57606a">//增长的大小，例如原先map的B=4，扩容后B=5则newbit=2^4</span>
</span></span><span style="display:flex;"><span>	<span style="color:#57606a">//用于计算新搬迁桶地址以及相关标志位</span>
</span></span><span style="display:flex;"><span>	<span style="color:#1f2328">newbit</span> <span style="color:#0550ae">:=</span> <span style="color:#1f2328">h</span><span style="color:#1f2328">.</span><span style="color:#6639ba">noldbuckets</span><span style="color:#1f2328">()</span>
</span></span><span style="display:flex;"><span>	<span style="color:#1f2328">alg</span> <span style="color:#0550ae">:=</span> <span style="color:#1f2328">t</span><span style="color:#1f2328">.</span><span style="color:#1f2328">key</span><span style="color:#1f2328">.</span><span style="color:#1f2328">alg</span>
</span></span><span style="display:flex;"><span>	<span style="color:#57606a">//判断是否搬迁了</span>
</span></span><span style="display:flex;"><span>	<span style="color:#cf222e">if</span> <span style="color:#1f2328">!</span><span style="color:#6639ba">evacuated</span><span style="color:#1f2328">(</span><span style="color:#1f2328">b</span><span style="color:#1f2328">)</span> <span style="color:#1f2328">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#cf222e">var</span> <span style="color:#1f2328">(</span>
</span></span><span style="display:flex;"><span>			<span style="color:#1f2328">x</span><span style="color:#1f2328">,</span> <span style="color:#1f2328">y</span>   <span style="color:#0550ae">*</span><span style="color:#1f2328">bmap</span>
</span></span><span style="display:flex;"><span>			<span style="color:#1f2328">xi</span><span style="color:#1f2328">,</span> <span style="color:#1f2328">yi</span> <span style="color:#cf222e">int</span>
</span></span><span style="display:flex;"><span>			<span style="color:#1f2328">xk</span><span style="color:#1f2328">,</span> <span style="color:#1f2328">yk</span> <span style="color:#1f2328">unsafe</span><span style="color:#1f2328">.</span><span style="color:#1f2328">Pointer</span>
</span></span><span style="display:flex;"><span>			<span style="color:#1f2328">xv</span><span style="color:#1f2328">,</span> <span style="color:#1f2328">yv</span> <span style="color:#1f2328">unsafe</span><span style="color:#1f2328">.</span><span style="color:#1f2328">Pointer</span>
</span></span><span style="display:flex;"><span>		<span style="color:#1f2328">)</span>
</span></span><span style="display:flex;"><span>		<span style="color:#57606a">//x指向新桶数组中的老位置</span>
</span></span><span style="display:flex;"><span>		<span style="color:#1f2328">x</span> <span style="color:#1f2328">=</span> <span style="color:#1f2328">(</span><span style="color:#0550ae">*</span><span style="color:#1f2328">bmap</span><span style="color:#1f2328">)(</span><span style="color:#6639ba">add</span><span style="color:#1f2328">(</span><span style="color:#1f2328">h</span><span style="color:#1f2328">.</span><span style="color:#1f2328">buckets</span><span style="color:#1f2328">,</span> <span style="color:#1f2328">oldbucket</span><span style="color:#0550ae">*</span><span style="color:#6639ba">uintptr</span><span style="color:#1f2328">(</span><span style="color:#1f2328">t</span><span style="color:#1f2328">.</span><span style="color:#1f2328">bucketsize</span><span style="color:#1f2328">)))</span>
</span></span><span style="display:flex;"><span>		<span style="color:#1f2328">xi</span> <span style="color:#1f2328">=</span> <span style="color:#0550ae">0</span>
</span></span><span style="display:flex;"><span>		<span style="color:#1f2328">xk</span> <span style="color:#1f2328">=</span> <span style="color:#6639ba">add</span><span style="color:#1f2328">(</span><span style="color:#1f2328">unsafe</span><span style="color:#1f2328">.</span><span style="color:#6639ba">Pointer</span><span style="color:#1f2328">(</span><span style="color:#1f2328">x</span><span style="color:#1f2328">),</span> <span style="color:#1f2328">dataOffset</span><span style="color:#1f2328">)</span>
</span></span><span style="display:flex;"><span>		<span style="color:#1f2328">xv</span> <span style="color:#1f2328">=</span> <span style="color:#6639ba">add</span><span style="color:#1f2328">(</span><span style="color:#1f2328">xk</span><span style="color:#1f2328">,</span> <span style="color:#1f2328">bucketCnt</span><span style="color:#0550ae">*</span><span style="color:#6639ba">uintptr</span><span style="color:#1f2328">(</span><span style="color:#1f2328">t</span><span style="color:#1f2328">.</span><span style="color:#1f2328">keysize</span><span style="color:#1f2328">))</span>
</span></span><span style="display:flex;"><span>		<span style="color:#cf222e">if</span> <span style="color:#1f2328">!</span><span style="color:#1f2328">h</span><span style="color:#1f2328">.</span><span style="color:#6639ba">sameSizeGrow</span><span style="color:#1f2328">()</span> <span style="color:#1f2328">{</span>
</span></span><span style="display:flex;"><span>			<span style="color:#57606a">//真正扩容增长，y指向新桶数组的新位置</span>
</span></span><span style="display:flex;"><span>			<span style="color:#57606a">//和老位置的区别就是差newbit的个数</span>
</span></span><span style="display:flex;"><span>			<span style="color:#57606a">//按照取桶地址的方法，新B比老B多1位，也就是新的地址下标比老的下标多看hash值左边一位</span>
</span></span><span style="display:flex;"><span>			<span style="color:#1f2328">y</span> <span style="color:#1f2328">=</span> <span style="color:#1f2328">(</span><span style="color:#0550ae">*</span><span style="color:#1f2328">bmap</span><span style="color:#1f2328">)(</span><span style="color:#6639ba">add</span><span style="color:#1f2328">(</span><span style="color:#1f2328">h</span><span style="color:#1f2328">.</span><span style="color:#1f2328">buckets</span><span style="color:#1f2328">,</span> <span style="color:#1f2328">(</span><span style="color:#1f2328">oldbucket</span><span style="color:#0550ae">+</span><span style="color:#1f2328">newbit</span><span style="color:#1f2328">)</span><span style="color:#0550ae">*</span><span style="color:#6639ba">uintptr</span><span style="color:#1f2328">(</span><span style="color:#1f2328">t</span><span style="color:#1f2328">.</span><span style="color:#1f2328">bucketsize</span><span style="color:#1f2328">)))</span>
</span></span><span style="display:flex;"><span>			<span style="color:#1f2328">yi</span> <span style="color:#1f2328">=</span> <span style="color:#0550ae">0</span>
</span></span><span style="display:flex;"><span>			<span style="color:#1f2328">yk</span> <span style="color:#1f2328">=</span> <span style="color:#6639ba">add</span><span style="color:#1f2328">(</span><span style="color:#1f2328">unsafe</span><span style="color:#1f2328">.</span><span style="color:#6639ba">Pointer</span><span style="color:#1f2328">(</span><span style="color:#1f2328">y</span><span style="color:#1f2328">),</span> <span style="color:#1f2328">dataOffset</span><span style="color:#1f2328">)</span>
</span></span><span style="display:flex;"><span>			<span style="color:#1f2328">yv</span> <span style="color:#1f2328">=</span> <span style="color:#6639ba">add</span><span style="color:#1f2328">(</span><span style="color:#1f2328">yk</span><span style="color:#1f2328">,</span> <span style="color:#1f2328">bucketCnt</span><span style="color:#0550ae">*</span><span style="color:#6639ba">uintptr</span><span style="color:#1f2328">(</span><span style="color:#1f2328">t</span><span style="color:#1f2328">.</span><span style="color:#1f2328">keysize</span><span style="color:#1f2328">))</span>
</span></span><span style="display:flex;"><span>		<span style="color:#1f2328">}</span>
</span></span><span style="display:flex;"><span>		<span style="color:#57606a">//开始遍历b，进行搬迁</span>
</span></span><span style="display:flex;"><span>		<span style="color:#cf222e">for</span> <span style="color:#1f2328">;</span> <span style="color:#1f2328">b</span> <span style="color:#0550ae">!=</span> <span style="color:#cf222e">nil</span><span style="color:#1f2328">;</span> <span style="color:#1f2328">b</span> <span style="color:#1f2328">=</span> <span style="color:#1f2328">b</span><span style="color:#1f2328">.</span><span style="color:#6639ba">overflow</span><span style="color:#1f2328">(</span><span style="color:#1f2328">t</span><span style="color:#1f2328">)</span> <span style="color:#1f2328">{</span>
</span></span><span style="display:flex;"><span>			<span style="color:#1f2328">k</span> <span style="color:#0550ae">:=</span> <span style="color:#6639ba">add</span><span style="color:#1f2328">(</span><span style="color:#1f2328">unsafe</span><span style="color:#1f2328">.</span><span style="color:#6639ba">Pointer</span><span style="color:#1f2328">(</span><span style="color:#1f2328">b</span><span style="color:#1f2328">),</span> <span style="color:#1f2328">dataOffset</span><span style="color:#1f2328">)</span>
</span></span><span style="display:flex;"><span>			<span style="color:#1f2328">v</span> <span style="color:#0550ae">:=</span> <span style="color:#6639ba">add</span><span style="color:#1f2328">(</span><span style="color:#1f2328">k</span><span style="color:#1f2328">,</span> <span style="color:#1f2328">bucketCnt</span><span style="color:#0550ae">*</span><span style="color:#6639ba">uintptr</span><span style="color:#1f2328">(</span><span style="color:#1f2328">t</span><span style="color:#1f2328">.</span><span style="color:#1f2328">keysize</span><span style="color:#1f2328">))</span>
</span></span><span style="display:flex;"><span>			<span style="color:#cf222e">for</span> <span style="color:#1f2328">i</span> <span style="color:#0550ae">:=</span> <span style="color:#0550ae">0</span><span style="color:#1f2328">;</span> <span style="color:#1f2328">i</span> <span style="color:#1f2328">&lt;</span> <span style="color:#1f2328">bucketCnt</span><span style="color:#1f2328">;</span> <span style="color:#1f2328">i</span><span style="color:#1f2328">,</span> <span style="color:#1f2328">k</span><span style="color:#1f2328">,</span> <span style="color:#1f2328">v</span> <span style="color:#1f2328">=</span> <span style="color:#1f2328">i</span><span style="color:#0550ae">+</span><span style="color:#0550ae">1</span><span style="color:#1f2328">,</span> <span style="color:#6639ba">add</span><span style="color:#1f2328">(</span><span style="color:#1f2328">k</span><span style="color:#1f2328">,</span> <span style="color:#6639ba">uintptr</span><span style="color:#1f2328">(</span><span style="color:#1f2328">t</span><span style="color:#1f2328">.</span><span style="color:#1f2328">keysize</span><span style="color:#1f2328">)),</span> <span style="color:#6639ba">add</span><span style="color:#1f2328">(</span><span style="color:#1f2328">v</span><span style="color:#1f2328">,</span> <span style="color:#6639ba">uintptr</span><span style="color:#1f2328">(</span><span style="color:#1f2328">t</span><span style="color:#1f2328">.</span><span style="color:#1f2328">valuesize</span><span style="color:#1f2328">))</span> <span style="color:#1f2328">{</span>
</span></span><span style="display:flex;"><span>				<span style="color:#1f2328">top</span> <span style="color:#0550ae">:=</span> <span style="color:#1f2328">b</span><span style="color:#1f2328">.</span><span style="color:#1f2328">tophash</span><span style="color:#1f2328">[</span><span style="color:#1f2328">i</span><span style="color:#1f2328">]</span>
</span></span><span style="display:flex;"><span>				<span style="color:#cf222e">if</span> <span style="color:#1f2328">top</span> <span style="color:#0550ae">==</span> <span style="color:#1f2328">empty</span> <span style="color:#1f2328">{</span>
</span></span><span style="display:flex;"><span>					<span style="color:#57606a">//标定搬迁空状态</span>
</span></span><span style="display:flex;"><span>					<span style="color:#1f2328">b</span><span style="color:#1f2328">.</span><span style="color:#1f2328">tophash</span><span style="color:#1f2328">[</span><span style="color:#1f2328">i</span><span style="color:#1f2328">]</span> <span style="color:#1f2328">=</span> <span style="color:#1f2328">evacuatedEmpty</span>
</span></span><span style="display:flex;"><span>					<span style="color:#cf222e">continue</span>
</span></span><span style="display:flex;"><span>				<span style="color:#1f2328">}</span>
</span></span><span style="display:flex;"><span>				<span style="color:#57606a">//理论上不会出现小于minTopHash的值</span>
</span></span><span style="display:flex;"><span>				<span style="color:#cf222e">if</span> <span style="color:#1f2328">top</span> <span style="color:#1f2328">&lt;</span> <span style="color:#1f2328">minTopHash</span> <span style="color:#1f2328">{</span>
</span></span><span style="display:flex;"><span>					<span style="color:#6639ba">throw</span><span style="color:#1f2328">(</span><span style="color:#0a3069">&#34;bad map state&#34;</span><span style="color:#1f2328">)</span>
</span></span><span style="display:flex;"><span>				<span style="color:#1f2328">}</span>
</span></span><span style="display:flex;"><span>				<span style="color:#1f2328">k2</span> <span style="color:#0550ae">:=</span> <span style="color:#1f2328">k</span>
</span></span><span style="display:flex;"><span>				<span style="color:#cf222e">if</span> <span style="color:#1f2328">t</span><span style="color:#1f2328">.</span><span style="color:#1f2328">indirectkey</span> <span style="color:#1f2328">{</span>
</span></span><span style="display:flex;"><span>					<span style="color:#1f2328">k2</span> <span style="color:#1f2328">=</span> <span style="color:#0550ae">*</span><span style="color:#1f2328">((</span><span style="color:#0550ae">*</span><span style="color:#1f2328">unsafe</span><span style="color:#1f2328">.</span><span style="color:#1f2328">Pointer</span><span style="color:#1f2328">)(</span><span style="color:#1f2328">k2</span><span style="color:#1f2328">))</span>
</span></span><span style="display:flex;"><span>				<span style="color:#1f2328">}</span>
</span></span><span style="display:flex;"><span>				<span style="color:#1f2328">useX</span> <span style="color:#0550ae">:=</span> <span style="color:#cf222e">true</span>
</span></span><span style="display:flex;"><span>				<span style="color:#cf222e">if</span> <span style="color:#1f2328">!</span><span style="color:#1f2328">h</span><span style="color:#1f2328">.</span><span style="color:#6639ba">sameSizeGrow</span><span style="color:#1f2328">()</span> <span style="color:#1f2328">{</span>
</span></span><span style="display:flex;"><span>					<span style="color:#57606a">//计算hash值</span>
</span></span><span style="display:flex;"><span>					<span style="color:#1f2328">hash</span> <span style="color:#0550ae">:=</span> <span style="color:#1f2328">alg</span><span style="color:#1f2328">.</span><span style="color:#6639ba">hash</span><span style="color:#1f2328">(</span><span style="color:#1f2328">k2</span><span style="color:#1f2328">,</span> <span style="color:#6639ba">uintptr</span><span style="color:#1f2328">(</span><span style="color:#1f2328">h</span><span style="color:#1f2328">.</span><span style="color:#1f2328">hash0</span><span style="color:#1f2328">))</span>
</span></span><span style="display:flex;"><span>					<span style="color:#57606a">//有迭代器访问的时候，这个和迭代器的遍历规则有关联，所以这里会判断</span>
</span></span><span style="display:flex;"><span>					<span style="color:#cf222e">if</span> <span style="color:#1f2328">h</span><span style="color:#1f2328">.</span><span style="color:#1f2328">flags</span><span style="color:#0550ae">&amp;</span><span style="color:#1f2328">iterator</span> <span style="color:#0550ae">!=</span> <span style="color:#0550ae">0</span> <span style="color:#1f2328">{</span>
</span></span><span style="display:flex;"><span>						<span style="color:#57606a">//自己和自己对比，不一致，说明key是浮点NANs</span>
</span></span><span style="display:flex;"><span>						<span style="color:#cf222e">if</span> <span style="color:#1f2328">!</span><span style="color:#1f2328">t</span><span style="color:#1f2328">.</span><span style="color:#1f2328">reflexivekey</span> <span style="color:#0550ae">&amp;&amp;</span> <span style="color:#1f2328">!</span><span style="color:#1f2328">alg</span><span style="color:#1f2328">.</span><span style="color:#6639ba">equal</span><span style="color:#1f2328">(</span><span style="color:#1f2328">k2</span><span style="color:#1f2328">,</span> <span style="color:#1f2328">k2</span><span style="color:#1f2328">)</span> <span style="color:#1f2328">{</span>
</span></span><span style="display:flex;"><span>							<span style="color:#57606a">//看旧桶的top值最后一位</span>
</span></span><span style="display:flex;"><span>							<span style="color:#cf222e">if</span> <span style="color:#1f2328">top</span><span style="color:#0550ae">&amp;</span><span style="color:#0550ae">1</span> <span style="color:#0550ae">!=</span> <span style="color:#0550ae">0</span> <span style="color:#1f2328">{</span>
</span></span><span style="display:flex;"><span>								<span style="color:#57606a">//hash值在新B位置0，即将这个key放到新桶数组中的老位置</span>
</span></span><span style="display:flex;"><span>								<span style="color:#1f2328">hash</span> <span style="color:#0550ae">|=</span> <span style="color:#1f2328">newbit</span>
</span></span><span style="display:flex;"><span>							<span style="color:#1f2328">}</span> <span style="color:#cf222e">else</span> <span style="color:#1f2328">{</span>
</span></span><span style="display:flex;"><span>								<span style="color:#57606a">//放到新位置</span>
</span></span><span style="display:flex;"><span>								<span style="color:#1f2328">hash</span> <span style="color:#0550ae">&amp;^=</span> <span style="color:#1f2328">newbit</span>
</span></span><span style="display:flex;"><span>							<span style="color:#1f2328">}</span>
</span></span><span style="display:flex;"><span>							<span style="color:#57606a">//记录新的top值</span>
</span></span><span style="display:flex;"><span>							<span style="color:#1f2328">top</span> <span style="color:#1f2328">=</span> <span style="color:#6639ba">uint8</span><span style="color:#1f2328">(</span><span style="color:#1f2328">hash</span> <span style="color:#0550ae">&gt;&gt;</span> <span style="color:#1f2328">(</span><span style="color:#1f2328">sys</span><span style="color:#1f2328">.</span><span style="color:#1f2328">PtrSize</span><span style="color:#0550ae">*</span><span style="color:#0550ae">8</span> <span style="color:#0550ae">-</span> <span style="color:#0550ae">8</span><span style="color:#1f2328">))</span>
</span></span><span style="display:flex;"><span>							<span style="color:#57606a">//top修正</span>
</span></span><span style="display:flex;"><span>							<span style="color:#cf222e">if</span> <span style="color:#1f2328">top</span> <span style="color:#1f2328">&lt;</span> <span style="color:#1f2328">minTopHash</span> <span style="color:#1f2328">{</span>
</span></span><span style="display:flex;"><span>								<span style="color:#1f2328">top</span> <span style="color:#0550ae">+=</span> <span style="color:#1f2328">minTopHash</span>
</span></span><span style="display:flex;"><span>							<span style="color:#1f2328">}</span>
</span></span><span style="display:flex;"><span>						<span style="color:#1f2328">}</span>
</span></span><span style="display:flex;"><span>					<span style="color:#1f2328">}</span>
</span></span><span style="display:flex;"><span>					<span style="color:#57606a">//判断是是否是0即是否在新桶数组的老位置</span>
</span></span><span style="display:flex;"><span>					<span style="color:#1f2328">useX</span> <span style="color:#1f2328">=</span> <span style="color:#1f2328">hash</span><span style="color:#0550ae">&amp;</span><span style="color:#1f2328">newbit</span> <span style="color:#0550ae">==</span> <span style="color:#0550ae">0</span>
</span></span><span style="display:flex;"><span>				<span style="color:#1f2328">}</span>
</span></span><span style="display:flex;"><span>				<span style="color:#cf222e">if</span> <span style="color:#1f2328">useX</span> <span style="color:#1f2328">{</span>
</span></span><span style="display:flex;"><span>					<span style="color:#57606a">//老桶中的key的tophash标记位迁移到x，即新桶数组的老位置</span>
</span></span><span style="display:flex;"><span>					<span style="color:#1f2328">b</span><span style="color:#1f2328">.</span><span style="color:#1f2328">tophash</span><span style="color:#1f2328">[</span><span style="color:#1f2328">i</span><span style="color:#1f2328">]</span> <span style="color:#1f2328">=</span> <span style="color:#1f2328">evacuatedX</span>
</span></span><span style="display:flex;"><span>					<span style="color:#57606a">//xi等于8了，说明这个桶装满了，需要溢出桶</span>
</span></span><span style="display:flex;"><span>					<span style="color:#cf222e">if</span> <span style="color:#1f2328">xi</span> <span style="color:#0550ae">==</span> <span style="color:#1f2328">bucketCnt</span> <span style="color:#1f2328">{</span>
</span></span><span style="display:flex;"><span>						<span style="color:#1f2328">newx</span> <span style="color:#0550ae">:=</span> <span style="color:#1f2328">h</span><span style="color:#1f2328">.</span><span style="color:#6639ba">newoverflow</span><span style="color:#1f2328">(</span><span style="color:#1f2328">t</span><span style="color:#1f2328">,</span> <span style="color:#1f2328">x</span><span style="color:#1f2328">)</span>
</span></span><span style="display:flex;"><span>						<span style="color:#1f2328">x</span> <span style="color:#1f2328">=</span> <span style="color:#1f2328">newx</span>
</span></span><span style="display:flex;"><span>						<span style="color:#1f2328">xi</span> <span style="color:#1f2328">=</span> <span style="color:#0550ae">0</span>
</span></span><span style="display:flex;"><span>						<span style="color:#1f2328">xk</span> <span style="color:#1f2328">=</span> <span style="color:#6639ba">add</span><span style="color:#1f2328">(</span><span style="color:#1f2328">unsafe</span><span style="color:#1f2328">.</span><span style="color:#6639ba">Pointer</span><span style="color:#1f2328">(</span><span style="color:#1f2328">x</span><span style="color:#1f2328">),</span> <span style="color:#1f2328">dataOffset</span><span style="color:#1f2328">)</span>
</span></span><span style="display:flex;"><span>						<span style="color:#1f2328">xv</span> <span style="color:#1f2328">=</span> <span style="color:#6639ba">add</span><span style="color:#1f2328">(</span><span style="color:#1f2328">xk</span><span style="color:#1f2328">,</span> <span style="color:#1f2328">bucketCnt</span><span style="color:#0550ae">*</span><span style="color:#6639ba">uintptr</span><span style="color:#1f2328">(</span><span style="color:#1f2328">t</span><span style="color:#1f2328">.</span><span style="color:#1f2328">keysize</span><span style="color:#1f2328">))</span>
</span></span><span style="display:flex;"><span>					<span style="color:#1f2328">}</span>
</span></span><span style="display:flex;"><span>					<span style="color:#57606a">//设定新的tophash</span>
</span></span><span style="display:flex;"><span>					<span style="color:#1f2328">x</span><span style="color:#1f2328">.</span><span style="color:#1f2328">tophash</span><span style="color:#1f2328">[</span><span style="color:#1f2328">xi</span><span style="color:#1f2328">]</span> <span style="color:#1f2328">=</span> <span style="color:#1f2328">top</span>
</span></span><span style="display:flex;"><span>					<span style="color:#cf222e">if</span> <span style="color:#1f2328">t</span><span style="color:#1f2328">.</span><span style="color:#1f2328">indirectkey</span> <span style="color:#1f2328">{</span>
</span></span><span style="display:flex;"><span>						<span style="color:#0550ae">*</span><span style="color:#1f2328">(</span><span style="color:#0550ae">*</span><span style="color:#1f2328">unsafe</span><span style="color:#1f2328">.</span><span style="color:#1f2328">Pointer</span><span style="color:#1f2328">)(</span><span style="color:#1f2328">xk</span><span style="color:#1f2328">)</span> <span style="color:#1f2328">=</span> <span style="color:#1f2328">k2</span>
</span></span><span style="display:flex;"><span>					<span style="color:#1f2328">}</span> <span style="color:#cf222e">else</span> <span style="color:#1f2328">{</span>
</span></span><span style="display:flex;"><span>						<span style="color:#6639ba">typedmemmove</span><span style="color:#1f2328">(</span><span style="color:#1f2328">t</span><span style="color:#1f2328">.</span><span style="color:#1f2328">key</span><span style="color:#1f2328">,</span> <span style="color:#1f2328">xk</span><span style="color:#1f2328">,</span> <span style="color:#1f2328">k</span><span style="color:#1f2328">)</span>
</span></span><span style="display:flex;"><span>					<span style="color:#1f2328">}</span>
</span></span><span style="display:flex;"><span>					<span style="color:#cf222e">if</span> <span style="color:#1f2328">t</span><span style="color:#1f2328">.</span><span style="color:#1f2328">indirectvalue</span> <span style="color:#1f2328">{</span>
</span></span><span style="display:flex;"><span>						<span style="color:#0550ae">*</span><span style="color:#1f2328">(</span><span style="color:#0550ae">*</span><span style="color:#1f2328">unsafe</span><span style="color:#1f2328">.</span><span style="color:#1f2328">Pointer</span><span style="color:#1f2328">)(</span><span style="color:#1f2328">xv</span><span style="color:#1f2328">)</span> <span style="color:#1f2328">=</span> <span style="color:#0550ae">*</span><span style="color:#1f2328">(</span><span style="color:#0550ae">*</span><span style="color:#1f2328">unsafe</span><span style="color:#1f2328">.</span><span style="color:#1f2328">Pointer</span><span style="color:#1f2328">)(</span><span style="color:#1f2328">v</span><span style="color:#1f2328">)</span>
</span></span><span style="display:flex;"><span>					<span style="color:#1f2328">}</span> <span style="color:#cf222e">else</span> <span style="color:#1f2328">{</span>
</span></span><span style="display:flex;"><span>						<span style="color:#6639ba">typedmemmove</span><span style="color:#1f2328">(</span><span style="color:#1f2328">t</span><span style="color:#1f2328">.</span><span style="color:#1f2328">elem</span><span style="color:#1f2328">,</span> <span style="color:#1f2328">xv</span><span style="color:#1f2328">,</span> <span style="color:#1f2328">v</span><span style="color:#1f2328">)</span>
</span></span><span style="display:flex;"><span>					<span style="color:#1f2328">}</span>
</span></span><span style="display:flex;"><span>					<span style="color:#57606a">//下一个</span>
</span></span><span style="display:flex;"><span>					<span style="color:#1f2328">xi</span><span style="color:#0550ae">++</span>
</span></span><span style="display:flex;"><span>					<span style="color:#1f2328">xk</span> <span style="color:#1f2328">=</span> <span style="color:#6639ba">add</span><span style="color:#1f2328">(</span><span style="color:#1f2328">xk</span><span style="color:#1f2328">,</span> <span style="color:#6639ba">uintptr</span><span style="color:#1f2328">(</span><span style="color:#1f2328">t</span><span style="color:#1f2328">.</span><span style="color:#1f2328">keysize</span><span style="color:#1f2328">))</span>
</span></span><span style="display:flex;"><span>					<span style="color:#1f2328">xv</span> <span style="color:#1f2328">=</span> <span style="color:#6639ba">add</span><span style="color:#1f2328">(</span><span style="color:#1f2328">xv</span><span style="color:#1f2328">,</span> <span style="color:#6639ba">uintptr</span><span style="color:#1f2328">(</span><span style="color:#1f2328">t</span><span style="color:#1f2328">.</span><span style="color:#1f2328">valuesize</span><span style="color:#1f2328">))</span>
</span></span><span style="display:flex;"><span>				<span style="color:#1f2328">}</span> <span style="color:#cf222e">else</span> <span style="color:#1f2328">{</span>
</span></span><span style="display:flex;"><span>					<span style="color:#57606a">//同上，只是把key放在新桶数组中的新位置</span>
</span></span><span style="display:flex;"><span>					<span style="color:#1f2328">b</span><span style="color:#1f2328">.</span><span style="color:#1f2328">tophash</span><span style="color:#1f2328">[</span><span style="color:#1f2328">i</span><span style="color:#1f2328">]</span> <span style="color:#1f2328">=</span> <span style="color:#1f2328">evacuatedY</span>
</span></span><span style="display:flex;"><span>					<span style="color:#cf222e">if</span> <span style="color:#1f2328">yi</span> <span style="color:#0550ae">==</span> <span style="color:#1f2328">bucketCnt</span> <span style="color:#1f2328">{</span>
</span></span><span style="display:flex;"><span>						<span style="color:#1f2328">newy</span> <span style="color:#0550ae">:=</span> <span style="color:#1f2328">h</span><span style="color:#1f2328">.</span><span style="color:#6639ba">newoverflow</span><span style="color:#1f2328">(</span><span style="color:#1f2328">t</span><span style="color:#1f2328">,</span> <span style="color:#1f2328">y</span><span style="color:#1f2328">)</span>
</span></span><span style="display:flex;"><span>						<span style="color:#1f2328">y</span> <span style="color:#1f2328">=</span> <span style="color:#1f2328">newy</span>
</span></span><span style="display:flex;"><span>						<span style="color:#1f2328">yi</span> <span style="color:#1f2328">=</span> <span style="color:#0550ae">0</span>
</span></span><span style="display:flex;"><span>						<span style="color:#1f2328">yk</span> <span style="color:#1f2328">=</span> <span style="color:#6639ba">add</span><span style="color:#1f2328">(</span><span style="color:#1f2328">unsafe</span><span style="color:#1f2328">.</span><span style="color:#6639ba">Pointer</span><span style="color:#1f2328">(</span><span style="color:#1f2328">y</span><span style="color:#1f2328">),</span> <span style="color:#1f2328">dataOffset</span><span style="color:#1f2328">)</span>
</span></span><span style="display:flex;"><span>						<span style="color:#1f2328">yv</span> <span style="color:#1f2328">=</span> <span style="color:#6639ba">add</span><span style="color:#1f2328">(</span><span style="color:#1f2328">yk</span><span style="color:#1f2328">,</span> <span style="color:#1f2328">bucketCnt</span><span style="color:#0550ae">*</span><span style="color:#6639ba">uintptr</span><span style="color:#1f2328">(</span><span style="color:#1f2328">t</span><span style="color:#1f2328">.</span><span style="color:#1f2328">keysize</span><span style="color:#1f2328">))</span>
</span></span><span style="display:flex;"><span>					<span style="color:#1f2328">}</span>
</span></span><span style="display:flex;"><span>					<span style="color:#1f2328">y</span><span style="color:#1f2328">.</span><span style="color:#1f2328">tophash</span><span style="color:#1f2328">[</span><span style="color:#1f2328">yi</span><span style="color:#1f2328">]</span> <span style="color:#1f2328">=</span> <span style="color:#1f2328">top</span>
</span></span><span style="display:flex;"><span>					<span style="color:#cf222e">if</span> <span style="color:#1f2328">t</span><span style="color:#1f2328">.</span><span style="color:#1f2328">indirectkey</span> <span style="color:#1f2328">{</span>
</span></span><span style="display:flex;"><span>						<span style="color:#0550ae">*</span><span style="color:#1f2328">(</span><span style="color:#0550ae">*</span><span style="color:#1f2328">unsafe</span><span style="color:#1f2328">.</span><span style="color:#1f2328">Pointer</span><span style="color:#1f2328">)(</span><span style="color:#1f2328">yk</span><span style="color:#1f2328">)</span> <span style="color:#1f2328">=</span> <span style="color:#1f2328">k2</span>
</span></span><span style="display:flex;"><span>					<span style="color:#1f2328">}</span> <span style="color:#cf222e">else</span> <span style="color:#1f2328">{</span>
</span></span><span style="display:flex;"><span>						<span style="color:#6639ba">typedmemmove</span><span style="color:#1f2328">(</span><span style="color:#1f2328">t</span><span style="color:#1f2328">.</span><span style="color:#1f2328">key</span><span style="color:#1f2328">,</span> <span style="color:#1f2328">yk</span><span style="color:#1f2328">,</span> <span style="color:#1f2328">k</span><span style="color:#1f2328">)</span>
</span></span><span style="display:flex;"><span>					<span style="color:#1f2328">}</span>
</span></span><span style="display:flex;"><span>					<span style="color:#cf222e">if</span> <span style="color:#1f2328">t</span><span style="color:#1f2328">.</span><span style="color:#1f2328">indirectvalue</span> <span style="color:#1f2328">{</span>
</span></span><span style="display:flex;"><span>						<span style="color:#0550ae">*</span><span style="color:#1f2328">(</span><span style="color:#0550ae">*</span><span style="color:#1f2328">unsafe</span><span style="color:#1f2328">.</span><span style="color:#1f2328">Pointer</span><span style="color:#1f2328">)(</span><span style="color:#1f2328">yv</span><span style="color:#1f2328">)</span> <span style="color:#1f2328">=</span> <span style="color:#0550ae">*</span><span style="color:#1f2328">(</span><span style="color:#0550ae">*</span><span style="color:#1f2328">unsafe</span><span style="color:#1f2328">.</span><span style="color:#1f2328">Pointer</span><span style="color:#1f2328">)(</span><span style="color:#1f2328">v</span><span style="color:#1f2328">)</span>
</span></span><span style="display:flex;"><span>					<span style="color:#1f2328">}</span> <span style="color:#cf222e">else</span> <span style="color:#1f2328">{</span>
</span></span><span style="display:flex;"><span>						<span style="color:#6639ba">typedmemmove</span><span style="color:#1f2328">(</span><span style="color:#1f2328">t</span><span style="color:#1f2328">.</span><span style="color:#1f2328">elem</span><span style="color:#1f2328">,</span> <span style="color:#1f2328">yv</span><span style="color:#1f2328">,</span> <span style="color:#1f2328">v</span><span style="color:#1f2328">)</span>
</span></span><span style="display:flex;"><span>					<span style="color:#1f2328">}</span>
</span></span><span style="display:flex;"><span>					<span style="color:#1f2328">yi</span><span style="color:#0550ae">++</span>
</span></span><span style="display:flex;"><span>					<span style="color:#1f2328">yk</span> <span style="color:#1f2328">=</span> <span style="color:#6639ba">add</span><span style="color:#1f2328">(</span><span style="color:#1f2328">yk</span><span style="color:#1f2328">,</span> <span style="color:#6639ba">uintptr</span><span style="color:#1f2328">(</span><span style="color:#1f2328">t</span><span style="color:#1f2328">.</span><span style="color:#1f2328">keysize</span><span style="color:#1f2328">))</span>
</span></span><span style="display:flex;"><span>					<span style="color:#1f2328">yv</span> <span style="color:#1f2328">=</span> <span style="color:#6639ba">add</span><span style="color:#1f2328">(</span><span style="color:#1f2328">yv</span><span style="color:#1f2328">,</span> <span style="color:#6639ba">uintptr</span><span style="color:#1f2328">(</span><span style="color:#1f2328">t</span><span style="color:#1f2328">.</span><span style="color:#1f2328">valuesize</span><span style="color:#1f2328">))</span>
</span></span><span style="display:flex;"><span>				<span style="color:#1f2328">}</span>
</span></span><span style="display:flex;"><span>			<span style="color:#1f2328">}</span>
</span></span><span style="display:flex;"><span>		<span style="color:#1f2328">}</span>
</span></span><span style="display:flex;"><span>		<span style="color:#57606a">//判断是否老桶数组还有迭代器在访问</span>
</span></span><span style="display:flex;"><span>		<span style="color:#cf222e">if</span> <span style="color:#1f2328">h</span><span style="color:#1f2328">.</span><span style="color:#1f2328">flags</span><span style="color:#0550ae">&amp;</span><span style="color:#1f2328">oldIterator</span> <span style="color:#0550ae">==</span> <span style="color:#0550ae">0</span> <span style="color:#1f2328">{</span>
</span></span><span style="display:flex;"><span>			<span style="color:#57606a">//没有，则处理一下，帮助gc</span>
</span></span><span style="display:flex;"><span>			<span style="color:#1f2328">b</span> <span style="color:#1f2328">=</span> <span style="color:#1f2328">(</span><span style="color:#0550ae">*</span><span style="color:#1f2328">bmap</span><span style="color:#1f2328">)(</span><span style="color:#6639ba">add</span><span style="color:#1f2328">(</span><span style="color:#1f2328">h</span><span style="color:#1f2328">.</span><span style="color:#1f2328">oldbuckets</span><span style="color:#1f2328">,</span> <span style="color:#1f2328">oldbucket</span><span style="color:#0550ae">*</span><span style="color:#6639ba">uintptr</span><span style="color:#1f2328">(</span><span style="color:#1f2328">t</span><span style="color:#1f2328">.</span><span style="color:#1f2328">bucketsize</span><span style="color:#1f2328">)))</span>
</span></span><span style="display:flex;"><span>			<span style="color:#cf222e">if</span> <span style="color:#1f2328">t</span><span style="color:#1f2328">.</span><span style="color:#1f2328">bucket</span><span style="color:#1f2328">.</span><span style="color:#1f2328">kind</span><span style="color:#0550ae">&amp;</span><span style="color:#1f2328">kindNoPointers</span> <span style="color:#0550ae">==</span> <span style="color:#0550ae">0</span> <span style="color:#1f2328">{</span>
</span></span><span style="display:flex;"><span>				<span style="color:#6639ba">memclrHasPointers</span><span style="color:#1f2328">(</span><span style="color:#6639ba">add</span><span style="color:#1f2328">(</span><span style="color:#1f2328">unsafe</span><span style="color:#1f2328">.</span><span style="color:#6639ba">Pointer</span><span style="color:#1f2328">(</span><span style="color:#1f2328">b</span><span style="color:#1f2328">),</span> <span style="color:#1f2328">dataOffset</span><span style="color:#1f2328">),</span> <span style="color:#6639ba">uintptr</span><span style="color:#1f2328">(</span><span style="color:#1f2328">t</span><span style="color:#1f2328">.</span><span style="color:#1f2328">bucketsize</span><span style="color:#1f2328">)</span><span style="color:#0550ae">-</span><span style="color:#1f2328">dataOffset</span><span style="color:#1f2328">)</span>
</span></span><span style="display:flex;"><span>			<span style="color:#1f2328">}</span> <span style="color:#cf222e">else</span> <span style="color:#1f2328">{</span>
</span></span><span style="display:flex;"><span>				<span style="color:#6639ba">memclrNoHeapPointers</span><span style="color:#1f2328">(</span><span style="color:#6639ba">add</span><span style="color:#1f2328">(</span><span style="color:#1f2328">unsafe</span><span style="color:#1f2328">.</span><span style="color:#6639ba">Pointer</span><span style="color:#1f2328">(</span><span style="color:#1f2328">b</span><span style="color:#1f2328">),</span> <span style="color:#1f2328">dataOffset</span><span style="color:#1f2328">),</span> <span style="color:#6639ba">uintptr</span><span style="color:#1f2328">(</span><span style="color:#1f2328">t</span><span style="color:#1f2328">.</span><span style="color:#1f2328">bucketsize</span><span style="color:#1f2328">)</span><span style="color:#0550ae">-</span><span style="color:#1f2328">dataOffset</span><span style="color:#1f2328">)</span>
</span></span><span style="display:flex;"><span>			<span style="color:#1f2328">}</span>
</span></span><span style="display:flex;"><span>		<span style="color:#1f2328">}</span>
</span></span><span style="display:flex;"><span>	<span style="color:#1f2328">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#57606a">//刚好，上面处理的桶是最小未处理桶</span>
</span></span><span style="display:flex;"><span>	<span style="color:#cf222e">if</span> <span style="color:#1f2328">oldbucket</span> <span style="color:#0550ae">==</span> <span style="color:#1f2328">h</span><span style="color:#1f2328">.</span><span style="color:#1f2328">nevacuate</span> <span style="color:#1f2328">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#57606a">//最小未处理桶往后走一位</span>
</span></span><span style="display:flex;"><span>		<span style="color:#1f2328">h</span><span style="color:#1f2328">.</span><span style="color:#1f2328">nevacuate</span> <span style="color:#1f2328">=</span> <span style="color:#1f2328">oldbucket</span> <span style="color:#0550ae">+</span> <span style="color:#0550ae">1</span>
</span></span><span style="display:flex;"><span>		<span style="color:#57606a">//尝试往后判断1024次，看看当前的最小未处理桶是否已经处理了，以及是否有连续的已经处理的桶</span>
</span></span><span style="display:flex;"><span>		<span style="color:#57606a">//有的话，就更新这个最小未处理桶下标，让这个数值精确</span>
</span></span><span style="display:flex;"><span>		<span style="color:#1f2328">stop</span> <span style="color:#0550ae">:=</span> <span style="color:#1f2328">h</span><span style="color:#1f2328">.</span><span style="color:#1f2328">nevacuate</span> <span style="color:#0550ae">+</span> <span style="color:#0550ae">1024</span>
</span></span><span style="display:flex;"><span>		<span style="color:#cf222e">if</span> <span style="color:#1f2328">stop</span> <span style="color:#1f2328">&gt;</span> <span style="color:#1f2328">newbit</span> <span style="color:#1f2328">{</span>
</span></span><span style="display:flex;"><span>			<span style="color:#1f2328">stop</span> <span style="color:#1f2328">=</span> <span style="color:#1f2328">newbit</span>
</span></span><span style="display:flex;"><span>		<span style="color:#1f2328">}</span>
</span></span><span style="display:flex;"><span>		<span style="color:#cf222e">for</span> <span style="color:#1f2328">h</span><span style="color:#1f2328">.</span><span style="color:#1f2328">nevacuate</span> <span style="color:#0550ae">!=</span> <span style="color:#1f2328">stop</span> <span style="color:#0550ae">&amp;&amp;</span> <span style="color:#6639ba">bucketEvacuated</span><span style="color:#1f2328">(</span><span style="color:#1f2328">t</span><span style="color:#1f2328">,</span> <span style="color:#1f2328">h</span><span style="color:#1f2328">,</span> <span style="color:#1f2328">h</span><span style="color:#1f2328">.</span><span style="color:#1f2328">nevacuate</span><span style="color:#1f2328">)</span> <span style="color:#1f2328">{</span>
</span></span><span style="display:flex;"><span>			<span style="color:#1f2328">h</span><span style="color:#1f2328">.</span><span style="color:#1f2328">nevacuate</span><span style="color:#0550ae">++</span>
</span></span><span style="display:flex;"><span>		<span style="color:#1f2328">}</span>
</span></span><span style="display:flex;"><span>		<span style="color:#57606a">//已经处理完了</span>
</span></span><span style="display:flex;"><span>		<span style="color:#cf222e">if</span> <span style="color:#1f2328">h</span><span style="color:#1f2328">.</span><span style="color:#1f2328">nevacuate</span> <span style="color:#0550ae">==</span> <span style="color:#1f2328">newbit</span> <span style="color:#1f2328">{</span>
</span></span><span style="display:flex;"><span>			<span style="color:#57606a">//oldbuckets指向空</span>
</span></span><span style="display:flex;"><span>			<span style="color:#1f2328">h</span><span style="color:#1f2328">.</span><span style="color:#1f2328">oldbuckets</span> <span style="color:#1f2328">=</span> <span style="color:#cf222e">nil</span>
</span></span><span style="display:flex;"><span>			<span style="color:#57606a">//指向空，让gc处理</span>
</span></span><span style="display:flex;"><span>			<span style="color:#cf222e">if</span> <span style="color:#1f2328">h</span><span style="color:#1f2328">.</span><span style="color:#1f2328">extra</span> <span style="color:#0550ae">!=</span> <span style="color:#cf222e">nil</span> <span style="color:#1f2328">{</span>
</span></span><span style="display:flex;"><span>				<span style="color:#1f2328">h</span><span style="color:#1f2328">.</span><span style="color:#1f2328">extra</span><span style="color:#1f2328">.</span><span style="color:#1f2328">overflow</span><span style="color:#1f2328">[</span><span style="color:#0550ae">1</span><span style="color:#1f2328">]</span> <span style="color:#1f2328">=</span> <span style="color:#cf222e">nil</span>
</span></span><span style="display:flex;"><span>			<span style="color:#1f2328">}</span>
</span></span><span style="display:flex;"><span>			<span style="color:#57606a">//标志位清空</span>
</span></span><span style="display:flex;"><span>			<span style="color:#1f2328">h</span><span style="color:#1f2328">.</span><span style="color:#1f2328">flags</span> <span style="color:#0550ae">&amp;^=</span> <span style="color:#1f2328">sameSizeGrow</span>
</span></span><span style="display:flex;"><span>		<span style="color:#1f2328">}</span>
</span></span><span style="display:flex;"><span>	<span style="color:#1f2328">}</span>
</span></span><span style="display:flex;"><span><span style="color:#1f2328">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h4 id="map遍历">map遍历</h4>
<div class="highlight"><div style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">  1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">  2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">  3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">  4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">  5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">  6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">  7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">  8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">  9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 16
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 17
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 18
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 19
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 20
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 21
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 22
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 23
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 24
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 25
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 26
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 27
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 28
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 29
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 30
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 31
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 32
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 33
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 34
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 35
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 36
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 37
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 38
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 39
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 40
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 41
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 42
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 43
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 44
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 45
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 46
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 47
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 48
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 49
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 50
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 51
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 52
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 53
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 54
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 55
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 56
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 57
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 58
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 59
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 60
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 61
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 62
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 63
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 64
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 65
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 66
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 67
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 68
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 69
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 70
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 71
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 72
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 73
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 74
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 75
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 76
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 77
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 78
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 79
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 80
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 81
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 82
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 83
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 84
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 85
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 86
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 87
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 88
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 89
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 90
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 91
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 92
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 93
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 94
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 95
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 96
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 97
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 98
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 99
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">100
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">101
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">102
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">103
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">104
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">105
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">106
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">107
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">108
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">109
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">110
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">111
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">112
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">113
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">114
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">115
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">116
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">117
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">118
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">119
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">120
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">121
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">122
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">123
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">124
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">125
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">126
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">127
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">128
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">129
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">130
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">131
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">132
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">133
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">134
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">135
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">136
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">137
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">138
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">139
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">140
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">141
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">142
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">143
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">144
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">145
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">146
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">147
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">148
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">149
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">150
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">151
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">152
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">153
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">154
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">155
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">156
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">157
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">158
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">159
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">160
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">161
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">162
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">163
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">164
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">165
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">166
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">167
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">168
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">169
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">170
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">171
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">172
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">173
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">174
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">175
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">176
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">177
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">178
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">179
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">180
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">181
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">182
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">183
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">184
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">185
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">186
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">187
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">188
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">189
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">190
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">191
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">192
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">193
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">194
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">195
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">196
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">197
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">198
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">199
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#57606a">//for range遍历的时候，先调用这个函数初始化一下迭代器</span>
</span></span><span style="display:flex;"><span><span style="color:#cf222e">func</span> <span style="color:#6639ba">mapiterinit</span><span style="color:#1f2328">(</span><span style="color:#1f2328">t</span> <span style="color:#0550ae">*</span><span style="color:#1f2328">maptype</span><span style="color:#1f2328">,</span> <span style="color:#1f2328">h</span> <span style="color:#0550ae">*</span><span style="color:#1f2328">hmap</span><span style="color:#1f2328">,</span> <span style="color:#1f2328">it</span> <span style="color:#0550ae">*</span><span style="color:#1f2328">hiter</span><span style="color:#1f2328">)</span> <span style="color:#1f2328">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#1f2328">it</span><span style="color:#1f2328">.</span><span style="color:#1f2328">key</span> <span style="color:#1f2328">=</span> <span style="color:#cf222e">nil</span>
</span></span><span style="display:flex;"><span>	<span style="color:#1f2328">it</span><span style="color:#1f2328">.</span><span style="color:#1f2328">value</span> <span style="color:#1f2328">=</span> <span style="color:#cf222e">nil</span>
</span></span><span style="display:flex;"><span>	<span style="color:#1f2328">it</span><span style="color:#1f2328">.</span><span style="color:#1f2328">t</span> <span style="color:#1f2328">=</span> <span style="color:#cf222e">nil</span>
</span></span><span style="display:flex;"><span>	<span style="color:#1f2328">it</span><span style="color:#1f2328">.</span><span style="color:#1f2328">h</span> <span style="color:#1f2328">=</span> <span style="color:#cf222e">nil</span>
</span></span><span style="display:flex;"><span>	<span style="color:#1f2328">it</span><span style="color:#1f2328">.</span><span style="color:#1f2328">buckets</span> <span style="color:#1f2328">=</span> <span style="color:#cf222e">nil</span>
</span></span><span style="display:flex;"><span>	<span style="color:#1f2328">it</span><span style="color:#1f2328">.</span><span style="color:#1f2328">bptr</span> <span style="color:#1f2328">=</span> <span style="color:#cf222e">nil</span>
</span></span><span style="display:flex;"><span>	<span style="color:#1f2328">it</span><span style="color:#1f2328">.</span><span style="color:#1f2328">overflow</span><span style="color:#1f2328">[</span><span style="color:#0550ae">0</span><span style="color:#1f2328">]</span> <span style="color:#1f2328">=</span> <span style="color:#cf222e">nil</span>
</span></span><span style="display:flex;"><span>	<span style="color:#1f2328">it</span><span style="color:#1f2328">.</span><span style="color:#1f2328">overflow</span><span style="color:#1f2328">[</span><span style="color:#0550ae">1</span><span style="color:#1f2328">]</span> <span style="color:#1f2328">=</span> <span style="color:#cf222e">nil</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#57606a">//废弃代码?</span>
</span></span><span style="display:flex;"><span>	<span style="color:#0550ae">...</span>
</span></span><span style="display:flex;"><span>	<span style="color:#57606a">//map空，或大小为0返回</span>
</span></span><span style="display:flex;"><span>	<span style="color:#cf222e">if</span> <span style="color:#1f2328">h</span> <span style="color:#0550ae">==</span> <span style="color:#cf222e">nil</span> <span style="color:#0550ae">||</span> <span style="color:#1f2328">h</span><span style="color:#1f2328">.</span><span style="color:#1f2328">count</span> <span style="color:#0550ae">==</span> <span style="color:#0550ae">0</span> <span style="color:#1f2328">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#1f2328">it</span><span style="color:#1f2328">.</span><span style="color:#1f2328">key</span> <span style="color:#1f2328">=</span> <span style="color:#cf222e">nil</span>
</span></span><span style="display:flex;"><span>		<span style="color:#1f2328">it</span><span style="color:#1f2328">.</span><span style="color:#1f2328">value</span> <span style="color:#1f2328">=</span> <span style="color:#cf222e">nil</span>
</span></span><span style="display:flex;"><span>		<span style="color:#cf222e">return</span>
</span></span><span style="display:flex;"><span>	<span style="color:#1f2328">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#57606a">//检测</span>
</span></span><span style="display:flex;"><span>	<span style="color:#cf222e">if</span> <span style="color:#1f2328">unsafe</span><span style="color:#1f2328">.</span><span style="color:#6639ba">Sizeof</span><span style="color:#1f2328">(</span><span style="color:#1f2328">hiter</span><span style="color:#1f2328">{})</span><span style="color:#0550ae">/</span><span style="color:#1f2328">sys</span><span style="color:#1f2328">.</span><span style="color:#1f2328">PtrSize</span> <span style="color:#0550ae">!=</span> <span style="color:#0550ae">12</span> <span style="color:#1f2328">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#6639ba">throw</span><span style="color:#1f2328">(</span><span style="color:#0a3069">&#34;hash_iter size incorrect&#34;</span><span style="color:#1f2328">)</span> 
</span></span><span style="display:flex;"><span>	<span style="color:#1f2328">}</span>
</span></span><span style="display:flex;"><span>	<span style="color:#1f2328">it</span><span style="color:#1f2328">.</span><span style="color:#1f2328">t</span> <span style="color:#1f2328">=</span> <span style="color:#1f2328">t</span>
</span></span><span style="display:flex;"><span>	<span style="color:#1f2328">it</span><span style="color:#1f2328">.</span><span style="color:#1f2328">h</span> <span style="color:#1f2328">=</span> <span style="color:#1f2328">h</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#57606a">//记录当前map的B值</span>
</span></span><span style="display:flex;"><span>	<span style="color:#1f2328">it</span><span style="color:#1f2328">.</span><span style="color:#1f2328">B</span> <span style="color:#1f2328">=</span> <span style="color:#1f2328">h</span><span style="color:#1f2328">.</span><span style="color:#1f2328">B</span>
</span></span><span style="display:flex;"><span>	<span style="color:#57606a">//记录当前桶数组地址</span>
</span></span><span style="display:flex;"><span>	<span style="color:#1f2328">it</span><span style="color:#1f2328">.</span><span style="color:#1f2328">buckets</span> <span style="color:#1f2328">=</span> <span style="color:#1f2328">h</span><span style="color:#1f2328">.</span><span style="color:#1f2328">buckets</span>
</span></span><span style="display:flex;"><span>	<span style="color:#cf222e">if</span> <span style="color:#1f2328">t</span><span style="color:#1f2328">.</span><span style="color:#1f2328">bucket</span><span style="color:#1f2328">.</span><span style="color:#1f2328">kind</span><span style="color:#0550ae">&amp;</span><span style="color:#1f2328">kindNoPointers</span> <span style="color:#0550ae">!=</span> <span style="color:#0550ae">0</span> <span style="color:#1f2328">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#57606a">//map不包含指针，则溢出桶地址在overflow中</span>
</span></span><span style="display:flex;"><span>		<span style="color:#1f2328">h</span><span style="color:#1f2328">.</span><span style="color:#6639ba">createOverflow</span><span style="color:#1f2328">()</span>
</span></span><span style="display:flex;"><span>		<span style="color:#1f2328">it</span><span style="color:#1f2328">.</span><span style="color:#1f2328">overflow</span> <span style="color:#1f2328">=</span> <span style="color:#1f2328">h</span><span style="color:#1f2328">.</span><span style="color:#1f2328">extra</span><span style="color:#1f2328">.</span><span style="color:#1f2328">overflow</span>
</span></span><span style="display:flex;"><span>	<span style="color:#1f2328">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#57606a">//随机一个开始桶下标,以及桶内开始的下标</span>
</span></span><span style="display:flex;"><span>	<span style="color:#57606a">//所以map的遍历结果是变化的</span>
</span></span><span style="display:flex;"><span>	<span style="color:#1f2328">r</span> <span style="color:#0550ae">:=</span> <span style="color:#6639ba">uintptr</span><span style="color:#1f2328">(</span><span style="color:#6639ba">fastrand</span><span style="color:#1f2328">())</span>
</span></span><span style="display:flex;"><span>	<span style="color:#cf222e">if</span> <span style="color:#1f2328">h</span><span style="color:#1f2328">.</span><span style="color:#1f2328">B</span> <span style="color:#1f2328">&gt;</span> <span style="color:#0550ae">31</span><span style="color:#0550ae">-</span><span style="color:#1f2328">bucketCntBits</span> <span style="color:#1f2328">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#1f2328">r</span> <span style="color:#0550ae">+=</span> <span style="color:#6639ba">uintptr</span><span style="color:#1f2328">(</span><span style="color:#6639ba">fastrand</span><span style="color:#1f2328">())</span> <span style="color:#0550ae">&lt;&lt;</span> <span style="color:#0550ae">31</span>
</span></span><span style="display:flex;"><span>	<span style="color:#1f2328">}</span>
</span></span><span style="display:flex;"><span>	<span style="color:#1f2328">it</span><span style="color:#1f2328">.</span><span style="color:#1f2328">startBucket</span> <span style="color:#1f2328">=</span> <span style="color:#1f2328">r</span> <span style="color:#0550ae">&amp;</span> <span style="color:#1f2328">(</span><span style="color:#6639ba">uintptr</span><span style="color:#1f2328">(</span><span style="color:#0550ae">1</span><span style="color:#1f2328">)</span><span style="color:#0550ae">&lt;&lt;</span><span style="color:#1f2328">h</span><span style="color:#1f2328">.</span><span style="color:#1f2328">B</span> <span style="color:#0550ae">-</span> <span style="color:#0550ae">1</span><span style="color:#1f2328">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#1f2328">it</span><span style="color:#1f2328">.</span><span style="color:#1f2328">offset</span> <span style="color:#1f2328">=</span> <span style="color:#6639ba">uint8</span><span style="color:#1f2328">(</span><span style="color:#1f2328">r</span> <span style="color:#0550ae">&gt;&gt;</span> <span style="color:#1f2328">h</span><span style="color:#1f2328">.</span><span style="color:#1f2328">B</span> <span style="color:#0550ae">&amp;</span> <span style="color:#1f2328">(</span><span style="color:#1f2328">bucketCnt</span> <span style="color:#0550ae">-</span> <span style="color:#0550ae">1</span><span style="color:#1f2328">))</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#1f2328">it</span><span style="color:#1f2328">.</span><span style="color:#1f2328">bucket</span> <span style="color:#1f2328">=</span> <span style="color:#1f2328">it</span><span style="color:#1f2328">.</span><span style="color:#1f2328">startBucket</span>
</span></span><span style="display:flex;"><span>	<span style="color:#57606a">//判断是否已经走了一圈的标记</span>
</span></span><span style="display:flex;"><span>	<span style="color:#1f2328">it</span><span style="color:#1f2328">.</span><span style="color:#1f2328">wrapped</span> <span style="color:#1f2328">=</span> <span style="color:#cf222e">false</span>
</span></span><span style="display:flex;"><span>	<span style="color:#1f2328">it</span><span style="color:#1f2328">.</span><span style="color:#1f2328">bptr</span> <span style="color:#1f2328">=</span> <span style="color:#cf222e">nil</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#57606a">//不太懂，留坑，好像是允许多个迭代器同时遍历map</span>
</span></span><span style="display:flex;"><span>	<span style="color:#cf222e">if</span> <span style="color:#1f2328">old</span> <span style="color:#0550ae">:=</span> <span style="color:#1f2328">h</span><span style="color:#1f2328">.</span><span style="color:#1f2328">flags</span><span style="color:#1f2328">;</span> <span style="color:#1f2328">old</span><span style="color:#0550ae">&amp;</span><span style="color:#1f2328">(</span><span style="color:#1f2328">iterator</span><span style="color:#1f2328">|</span><span style="color:#1f2328">oldIterator</span><span style="color:#1f2328">)</span> <span style="color:#0550ae">!=</span> <span style="color:#1f2328">iterator</span><span style="color:#1f2328">|</span><span style="color:#1f2328">oldIterator</span> <span style="color:#1f2328">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#1f2328">atomic</span><span style="color:#1f2328">.</span><span style="color:#6639ba">Or8</span><span style="color:#1f2328">(</span><span style="color:#0550ae">&amp;</span><span style="color:#1f2328">h</span><span style="color:#1f2328">.</span><span style="color:#1f2328">flags</span><span style="color:#1f2328">,</span> <span style="color:#1f2328">iterator</span><span style="color:#1f2328">|</span><span style="color:#1f2328">oldIterator</span><span style="color:#1f2328">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#1f2328">}</span>
</span></span><span style="display:flex;"><span>	<span style="color:#57606a">//遍历第一个元素</span>
</span></span><span style="display:flex;"><span>	<span style="color:#6639ba">mapiternext</span><span style="color:#1f2328">(</span><span style="color:#1f2328">it</span><span style="color:#1f2328">)</span>
</span></span><span style="display:flex;"><span><span style="color:#1f2328">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#cf222e">func</span> <span style="color:#6639ba">mapiternext</span><span style="color:#1f2328">(</span><span style="color:#1f2328">it</span> <span style="color:#0550ae">*</span><span style="color:#1f2328">hiter</span><span style="color:#1f2328">)</span> <span style="color:#1f2328">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#1f2328">h</span> <span style="color:#0550ae">:=</span> <span style="color:#1f2328">it</span><span style="color:#1f2328">.</span><span style="color:#1f2328">h</span>
</span></span><span style="display:flex;"><span>	<span style="color:#57606a">//废弃代码？</span>
</span></span><span style="display:flex;"><span>	<span style="color:#0550ae">...</span>
</span></span><span style="display:flex;"><span>	<span style="color:#57606a">//不允许同时读写</span>
</span></span><span style="display:flex;"><span>	<span style="color:#cf222e">if</span> <span style="color:#1f2328">h</span><span style="color:#1f2328">.</span><span style="color:#1f2328">flags</span><span style="color:#0550ae">&amp;</span><span style="color:#1f2328">hashWriting</span> <span style="color:#0550ae">!=</span> <span style="color:#0550ae">0</span> <span style="color:#1f2328">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#6639ba">throw</span><span style="color:#1f2328">(</span><span style="color:#0a3069">&#34;concurrent map iteration and map write&#34;</span><span style="color:#1f2328">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#1f2328">}</span>
</span></span><span style="display:flex;"><span>	<span style="color:#1f2328">t</span> <span style="color:#0550ae">:=</span> <span style="color:#1f2328">it</span><span style="color:#1f2328">.</span><span style="color:#1f2328">t</span>
</span></span><span style="display:flex;"><span>	<span style="color:#57606a">//记录当前遍历桶下标</span>
</span></span><span style="display:flex;"><span>	<span style="color:#1f2328">bucket</span> <span style="color:#0550ae">:=</span> <span style="color:#1f2328">it</span><span style="color:#1f2328">.</span><span style="color:#1f2328">bucket</span>
</span></span><span style="display:flex;"><span>	<span style="color:#57606a">//记录当前遍历桶地址</span>
</span></span><span style="display:flex;"><span>	<span style="color:#1f2328">b</span> <span style="color:#0550ae">:=</span> <span style="color:#1f2328">it</span><span style="color:#1f2328">.</span><span style="color:#1f2328">bptr</span>
</span></span><span style="display:flex;"><span>	<span style="color:#57606a">//记录桶内下标</span>
</span></span><span style="display:flex;"><span>	<span style="color:#1f2328">i</span> <span style="color:#0550ae">:=</span> <span style="color:#1f2328">it</span><span style="color:#1f2328">.</span><span style="color:#1f2328">i</span>
</span></span><span style="display:flex;"><span>	<span style="color:#57606a">//记录是否要检测新桶</span>
</span></span><span style="display:flex;"><span>	<span style="color:#1f2328">checkBucket</span> <span style="color:#0550ae">:=</span> <span style="color:#1f2328">it</span><span style="color:#1f2328">.</span><span style="color:#1f2328">checkBucket</span>
</span></span><span style="display:flex;"><span>	<span style="color:#1f2328">alg</span> <span style="color:#0550ae">:=</span> <span style="color:#1f2328">t</span><span style="color:#1f2328">.</span><span style="color:#1f2328">key</span><span style="color:#1f2328">.</span><span style="color:#1f2328">alg</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#1f2328">next</span><span style="color:#1f2328">:</span>
</span></span><span style="display:flex;"><span>	<span style="color:#cf222e">if</span> <span style="color:#1f2328">b</span> <span style="color:#0550ae">==</span> <span style="color:#cf222e">nil</span> <span style="color:#1f2328">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#57606a">//刚开始，或者结束了</span>
</span></span><span style="display:flex;"><span>		<span style="color:#57606a">//走了一圈了，bucket又等于开始的下标，则表示已经遍历结束了</span>
</span></span><span style="display:flex;"><span>		<span style="color:#cf222e">if</span> <span style="color:#1f2328">bucket</span> <span style="color:#0550ae">==</span> <span style="color:#1f2328">it</span><span style="color:#1f2328">.</span><span style="color:#1f2328">startBucket</span> <span style="color:#0550ae">&amp;&amp;</span> <span style="color:#1f2328">it</span><span style="color:#1f2328">.</span><span style="color:#1f2328">wrapped</span> <span style="color:#1f2328">{</span>
</span></span><span style="display:flex;"><span>			<span style="color:#1f2328">it</span><span style="color:#1f2328">.</span><span style="color:#1f2328">key</span> <span style="color:#1f2328">=</span> <span style="color:#cf222e">nil</span>
</span></span><span style="display:flex;"><span>			<span style="color:#1f2328">it</span><span style="color:#1f2328">.</span><span style="color:#1f2328">value</span> <span style="color:#1f2328">=</span> <span style="color:#cf222e">nil</span>
</span></span><span style="display:flex;"><span>			<span style="color:#cf222e">return</span>
</span></span><span style="display:flex;"><span>		<span style="color:#1f2328">}</span>
</span></span><span style="display:flex;"><span>		<span style="color:#cf222e">if</span> <span style="color:#1f2328">h</span><span style="color:#1f2328">.</span><span style="color:#6639ba">growing</span><span style="color:#1f2328">()</span> <span style="color:#0550ae">&amp;&amp;</span> <span style="color:#1f2328">it</span><span style="color:#1f2328">.</span><span style="color:#1f2328">B</span> <span style="color:#0550ae">==</span> <span style="color:#1f2328">h</span><span style="color:#1f2328">.</span><span style="color:#1f2328">B</span> <span style="color:#1f2328">{</span>
</span></span><span style="display:flex;"><span>			<span style="color:#57606a">//当前map已经处在扩容阶段，但迭代器记录的B和map现在的B一样</span>
</span></span><span style="display:flex;"><span>			<span style="color:#57606a">//说明，迭代器是扩容阶段初始化的</span>
</span></span><span style="display:flex;"><span>			<span style="color:#1f2328">oldbucket</span> <span style="color:#0550ae">:=</span> <span style="color:#1f2328">bucket</span> <span style="color:#0550ae">&amp;</span> <span style="color:#1f2328">it</span><span style="color:#1f2328">.</span><span style="color:#1f2328">h</span><span style="color:#1f2328">.</span><span style="color:#6639ba">oldbucketmask</span><span style="color:#1f2328">()</span>
</span></span><span style="display:flex;"><span>			<span style="color:#57606a">//b为老桶数组的相关地址</span>
</span></span><span style="display:flex;"><span>			<span style="color:#1f2328">b</span> <span style="color:#1f2328">=</span> <span style="color:#1f2328">(</span><span style="color:#0550ae">*</span><span style="color:#1f2328">bmap</span><span style="color:#1f2328">)(</span><span style="color:#6639ba">add</span><span style="color:#1f2328">(</span><span style="color:#1f2328">h</span><span style="color:#1f2328">.</span><span style="color:#1f2328">oldbuckets</span><span style="color:#1f2328">,</span> <span style="color:#1f2328">oldbucket</span><span style="color:#0550ae">*</span><span style="color:#6639ba">uintptr</span><span style="color:#1f2328">(</span><span style="color:#1f2328">t</span><span style="color:#1f2328">.</span><span style="color:#1f2328">bucketsize</span><span style="color:#1f2328">)))</span>
</span></span><span style="display:flex;"><span>			<span style="color:#57606a">//看是否已经搬迁了</span>
</span></span><span style="display:flex;"><span>			<span style="color:#cf222e">if</span> <span style="color:#1f2328">!</span><span style="color:#6639ba">evacuated</span><span style="color:#1f2328">(</span><span style="color:#1f2328">b</span><span style="color:#1f2328">)</span> <span style="color:#1f2328">{</span>
</span></span><span style="display:flex;"><span>				<span style="color:#57606a">//还没有搬迁，则我们要遍历的数据还在老桶数组对应下标的桶内</span>
</span></span><span style="display:flex;"><span>				<span style="color:#57606a">//但老桶的数据不一定全是新桶数组的一样下标，需要判断这个值以后是不是会在我们当前遍历桶下标</span>
</span></span><span style="display:flex;"><span>				<span style="color:#57606a">//因此，记录需要检测的下标</span>
</span></span><span style="display:flex;"><span>				<span style="color:#1f2328">checkBucket</span> <span style="color:#1f2328">=</span> <span style="color:#1f2328">bucket</span>
</span></span><span style="display:flex;"><span>			<span style="color:#1f2328">}</span> <span style="color:#cf222e">else</span> <span style="color:#1f2328">{</span>
</span></span><span style="display:flex;"><span>				<span style="color:#57606a">//已经搬迁了，则遍历新桶数组对应的bucket下标桶数据</span>
</span></span><span style="display:flex;"><span>				<span style="color:#1f2328">b</span> <span style="color:#1f2328">=</span> <span style="color:#1f2328">(</span><span style="color:#0550ae">*</span><span style="color:#1f2328">bmap</span><span style="color:#1f2328">)(</span><span style="color:#6639ba">add</span><span style="color:#1f2328">(</span><span style="color:#1f2328">it</span><span style="color:#1f2328">.</span><span style="color:#1f2328">buckets</span><span style="color:#1f2328">,</span> <span style="color:#1f2328">bucket</span><span style="color:#0550ae">*</span><span style="color:#6639ba">uintptr</span><span style="color:#1f2328">(</span><span style="color:#1f2328">t</span><span style="color:#1f2328">.</span><span style="color:#1f2328">bucketsize</span><span style="color:#1f2328">)))</span>
</span></span><span style="display:flex;"><span>				<span style="color:#1f2328">checkBucket</span> <span style="color:#1f2328">=</span> <span style="color:#1f2328">noCheck</span>
</span></span><span style="display:flex;"><span>			<span style="color:#1f2328">}</span>
</span></span><span style="display:flex;"><span>		<span style="color:#1f2328">}</span> <span style="color:#cf222e">else</span> <span style="color:#1f2328">{</span>
</span></span><span style="display:flex;"><span>			<span style="color:#57606a">//情况1.迭代器是扩容前初始化的，处理直接遍历老桶数组，因为迭代器标准位的存在，老桶数组不会被清空</span>
</span></span><span style="display:flex;"><span>			<span style="color:#57606a">//情况2.map没有扩容，正常遍历桶数组</span>
</span></span><span style="display:flex;"><span>			<span style="color:#1f2328">b</span> <span style="color:#1f2328">=</span> <span style="color:#1f2328">(</span><span style="color:#0550ae">*</span><span style="color:#1f2328">bmap</span><span style="color:#1f2328">)(</span><span style="color:#6639ba">add</span><span style="color:#1f2328">(</span><span style="color:#1f2328">it</span><span style="color:#1f2328">.</span><span style="color:#1f2328">buckets</span><span style="color:#1f2328">,</span> <span style="color:#1f2328">bucket</span><span style="color:#0550ae">*</span><span style="color:#6639ba">uintptr</span><span style="color:#1f2328">(</span><span style="color:#1f2328">t</span><span style="color:#1f2328">.</span><span style="color:#1f2328">bucketsize</span><span style="color:#1f2328">)))</span>
</span></span><span style="display:flex;"><span>			<span style="color:#57606a">//上面情况都不会存在需要检测的桶</span>
</span></span><span style="display:flex;"><span>			<span style="color:#1f2328">checkBucket</span> <span style="color:#1f2328">=</span> <span style="color:#1f2328">noCheck</span>
</span></span><span style="display:flex;"><span>		<span style="color:#1f2328">}</span>
</span></span><span style="display:flex;"><span>		<span style="color:#57606a">//bucket下一个，后续遍历准备</span>
</span></span><span style="display:flex;"><span>		<span style="color:#1f2328">bucket</span><span style="color:#0550ae">++</span>
</span></span><span style="display:flex;"><span>		<span style="color:#57606a">//到头了，从0开始，并且循环标记为true</span>
</span></span><span style="display:flex;"><span>		<span style="color:#cf222e">if</span> <span style="color:#1f2328">bucket</span> <span style="color:#0550ae">==</span> <span style="color:#6639ba">uintptr</span><span style="color:#1f2328">(</span><span style="color:#0550ae">1</span><span style="color:#1f2328">)</span><span style="color:#0550ae">&lt;&lt;</span><span style="color:#1f2328">it</span><span style="color:#1f2328">.</span><span style="color:#1f2328">B</span> <span style="color:#1f2328">{</span>
</span></span><span style="display:flex;"><span>			<span style="color:#1f2328">bucket</span> <span style="color:#1f2328">=</span> <span style="color:#0550ae">0</span>
</span></span><span style="display:flex;"><span>			<span style="color:#1f2328">it</span><span style="color:#1f2328">.</span><span style="color:#1f2328">wrapped</span> <span style="color:#1f2328">=</span> <span style="color:#cf222e">true</span>
</span></span><span style="display:flex;"><span>		<span style="color:#1f2328">}</span>
</span></span><span style="display:flex;"><span>		<span style="color:#57606a">//桶内遍历个数置0</span>
</span></span><span style="display:flex;"><span>		<span style="color:#1f2328">i</span> <span style="color:#1f2328">=</span> <span style="color:#0550ae">0</span>
</span></span><span style="display:flex;"><span>	<span style="color:#1f2328">}</span>
</span></span><span style="display:flex;"><span>	<span style="color:#cf222e">for</span> <span style="color:#1f2328">;</span> <span style="color:#1f2328">i</span> <span style="color:#1f2328">&lt;</span> <span style="color:#1f2328">bucketCnt</span><span style="color:#1f2328">;</span> <span style="color:#1f2328">i</span><span style="color:#0550ae">++</span> <span style="color:#1f2328">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#57606a">//offi 桶内随机开始下标的快速定位</span>
</span></span><span style="display:flex;"><span>		<span style="color:#1f2328">offi</span> <span style="color:#0550ae">:=</span> <span style="color:#1f2328">(</span><span style="color:#1f2328">i</span> <span style="color:#0550ae">+</span> <span style="color:#1f2328">it</span><span style="color:#1f2328">.</span><span style="color:#1f2328">offset</span><span style="color:#1f2328">)</span> <span style="color:#0550ae">&amp;</span> <span style="color:#1f2328">(</span><span style="color:#1f2328">bucketCnt</span> <span style="color:#0550ae">-</span> <span style="color:#0550ae">1</span><span style="color:#1f2328">)</span>
</span></span><span style="display:flex;"><span>		<span style="color:#1f2328">k</span> <span style="color:#0550ae">:=</span> <span style="color:#6639ba">add</span><span style="color:#1f2328">(</span><span style="color:#1f2328">unsafe</span><span style="color:#1f2328">.</span><span style="color:#6639ba">Pointer</span><span style="color:#1f2328">(</span><span style="color:#1f2328">b</span><span style="color:#1f2328">),</span> <span style="color:#1f2328">dataOffset</span><span style="color:#0550ae">+</span><span style="color:#6639ba">uintptr</span><span style="color:#1f2328">(</span><span style="color:#1f2328">offi</span><span style="color:#1f2328">)</span><span style="color:#0550ae">*</span><span style="color:#6639ba">uintptr</span><span style="color:#1f2328">(</span><span style="color:#1f2328">t</span><span style="color:#1f2328">.</span><span style="color:#1f2328">keysize</span><span style="color:#1f2328">))</span>
</span></span><span style="display:flex;"><span>		<span style="color:#1f2328">v</span> <span style="color:#0550ae">:=</span> <span style="color:#6639ba">add</span><span style="color:#1f2328">(</span><span style="color:#1f2328">unsafe</span><span style="color:#1f2328">.</span><span style="color:#6639ba">Pointer</span><span style="color:#1f2328">(</span><span style="color:#1f2328">b</span><span style="color:#1f2328">),</span> <span style="color:#1f2328">dataOffset</span><span style="color:#0550ae">+</span><span style="color:#1f2328">bucketCnt</span><span style="color:#0550ae">*</span><span style="color:#6639ba">uintptr</span><span style="color:#1f2328">(</span><span style="color:#1f2328">t</span><span style="color:#1f2328">.</span><span style="color:#1f2328">keysize</span><span style="color:#1f2328">)</span><span style="color:#0550ae">+</span><span style="color:#6639ba">uintptr</span><span style="color:#1f2328">(</span><span style="color:#1f2328">offi</span><span style="color:#1f2328">)</span><span style="color:#0550ae">*</span><span style="color:#6639ba">uintptr</span><span style="color:#1f2328">(</span><span style="color:#1f2328">t</span><span style="color:#1f2328">.</span><span style="color:#1f2328">valuesize</span><span style="color:#1f2328">))</span>
</span></span><span style="display:flex;"><span>		<span style="color:#57606a">//tophash为空，则跳过</span>
</span></span><span style="display:flex;"><span>		<span style="color:#cf222e">if</span> <span style="color:#1f2328">b</span><span style="color:#1f2328">.</span><span style="color:#1f2328">tophash</span><span style="color:#1f2328">[</span><span style="color:#1f2328">offi</span><span style="color:#1f2328">]</span> <span style="color:#0550ae">!=</span> <span style="color:#1f2328">empty</span> <span style="color:#0550ae">&amp;&amp;</span> <span style="color:#1f2328">b</span><span style="color:#1f2328">.</span><span style="color:#1f2328">tophash</span><span style="color:#1f2328">[</span><span style="color:#1f2328">offi</span><span style="color:#1f2328">]</span> <span style="color:#0550ae">!=</span> <span style="color:#1f2328">evacuatedEmpty</span> <span style="color:#1f2328">{</span>
</span></span><span style="display:flex;"><span>			<span style="color:#cf222e">if</span> <span style="color:#1f2328">checkBucket</span> <span style="color:#0550ae">!=</span> <span style="color:#1f2328">noCheck</span> <span style="color:#0550ae">&amp;&amp;</span> <span style="color:#1f2328">!</span><span style="color:#1f2328">h</span><span style="color:#1f2328">.</span><span style="color:#6639ba">sameSizeGrow</span><span style="color:#1f2328">()</span> <span style="color:#1f2328">{</span>
</span></span><span style="display:flex;"><span>				<span style="color:#57606a">//是扩大一倍增长的，并且需要检测桶</span>
</span></span><span style="display:flex;"><span>				<span style="color:#1f2328">k2</span> <span style="color:#0550ae">:=</span> <span style="color:#1f2328">k</span>
</span></span><span style="display:flex;"><span>				<span style="color:#cf222e">if</span> <span style="color:#1f2328">t</span><span style="color:#1f2328">.</span><span style="color:#1f2328">indirectkey</span> <span style="color:#1f2328">{</span>
</span></span><span style="display:flex;"><span>					<span style="color:#1f2328">k2</span> <span style="color:#1f2328">=</span> <span style="color:#0550ae">*</span><span style="color:#1f2328">((</span><span style="color:#0550ae">*</span><span style="color:#1f2328">unsafe</span><span style="color:#1f2328">.</span><span style="color:#1f2328">Pointer</span><span style="color:#1f2328">)(</span><span style="color:#1f2328">k2</span><span style="color:#1f2328">))</span>
</span></span><span style="display:flex;"><span>				<span style="color:#1f2328">}</span>
</span></span><span style="display:flex;"><span>				<span style="color:#cf222e">if</span> <span style="color:#1f2328">t</span><span style="color:#1f2328">.</span><span style="color:#1f2328">reflexivekey</span> <span style="color:#0550ae">||</span> <span style="color:#1f2328">alg</span><span style="color:#1f2328">.</span><span style="color:#6639ba">equal</span><span style="color:#1f2328">(</span><span style="color:#1f2328">k2</span><span style="color:#1f2328">,</span> <span style="color:#1f2328">k2</span><span style="color:#1f2328">)</span> <span style="color:#1f2328">{</span>
</span></span><span style="display:flex;"><span>					<span style="color:#57606a">//是正常key，但hash取得的桶下标不是目前需要的，则跳过</span>
</span></span><span style="display:flex;"><span>					<span style="color:#57606a">//说明这个key以后会去新的下标桶</span>
</span></span><span style="display:flex;"><span>					<span style="color:#1f2328">hash</span> <span style="color:#0550ae">:=</span> <span style="color:#1f2328">alg</span><span style="color:#1f2328">.</span><span style="color:#6639ba">hash</span><span style="color:#1f2328">(</span><span style="color:#1f2328">k2</span><span style="color:#1f2328">,</span> <span style="color:#6639ba">uintptr</span><span style="color:#1f2328">(</span><span style="color:#1f2328">h</span><span style="color:#1f2328">.</span><span style="color:#1f2328">hash0</span><span style="color:#1f2328">))</span>
</span></span><span style="display:flex;"><span>					<span style="color:#cf222e">if</span> <span style="color:#1f2328">hash</span><span style="color:#0550ae">&amp;</span><span style="color:#1f2328">(</span><span style="color:#6639ba">uintptr</span><span style="color:#1f2328">(</span><span style="color:#0550ae">1</span><span style="color:#1f2328">)</span><span style="color:#0550ae">&lt;&lt;</span><span style="color:#1f2328">it</span><span style="color:#1f2328">.</span><span style="color:#1f2328">B</span><span style="color:#0550ae">-</span><span style="color:#0550ae">1</span><span style="color:#1f2328">)</span> <span style="color:#0550ae">!=</span> <span style="color:#1f2328">checkBucket</span> <span style="color:#1f2328">{</span>
</span></span><span style="display:flex;"><span>						<span style="color:#cf222e">continue</span>
</span></span><span style="display:flex;"><span>					<span style="color:#1f2328">}</span>
</span></span><span style="display:flex;"><span>				<span style="color:#1f2328">}</span> <span style="color:#cf222e">else</span> <span style="color:#1f2328">{</span>
</span></span><span style="display:flex;"><span>					<span style="color:#57606a">//特殊值nan的处理，我们是看tophash的最后一位，是否是1，来决定搬迁去向的</span>
</span></span><span style="display:flex;"><span>					<span style="color:#57606a">//因此，这个这次也这么判断，看这个key是否会在checkBucket下标的桶</span>
</span></span><span style="display:flex;"><span>					<span style="color:#cf222e">if</span> <span style="color:#1f2328">checkBucket</span><span style="color:#0550ae">&gt;&gt;</span><span style="color:#1f2328">(</span><span style="color:#1f2328">it</span><span style="color:#1f2328">.</span><span style="color:#1f2328">B</span><span style="color:#0550ae">-</span><span style="color:#0550ae">1</span><span style="color:#1f2328">)</span> <span style="color:#0550ae">!=</span> <span style="color:#6639ba">uintptr</span><span style="color:#1f2328">(</span><span style="color:#1f2328">b</span><span style="color:#1f2328">.</span><span style="color:#1f2328">tophash</span><span style="color:#1f2328">[</span><span style="color:#1f2328">offi</span><span style="color:#1f2328">]</span><span style="color:#0550ae">&amp;</span><span style="color:#0550ae">1</span><span style="color:#1f2328">)</span> <span style="color:#1f2328">{</span>
</span></span><span style="display:flex;"><span>						<span style="color:#cf222e">continue</span>
</span></span><span style="display:flex;"><span>					<span style="color:#1f2328">}</span>
</span></span><span style="display:flex;"><span>				<span style="color:#1f2328">}</span>
</span></span><span style="display:flex;"><span>			<span style="color:#1f2328">}</span>
</span></span><span style="display:flex;"><span>			<span style="color:#57606a">//如果tophash不是特殊标记</span>
</span></span><span style="display:flex;"><span>			<span style="color:#cf222e">if</span> <span style="color:#1f2328">b</span><span style="color:#1f2328">.</span><span style="color:#1f2328">tophash</span><span style="color:#1f2328">[</span><span style="color:#1f2328">offi</span><span style="color:#1f2328">]</span> <span style="color:#0550ae">!=</span> <span style="color:#1f2328">evacuatedX</span> <span style="color:#0550ae">&amp;&amp;</span> <span style="color:#1f2328">b</span><span style="color:#1f2328">.</span><span style="color:#1f2328">tophash</span><span style="color:#1f2328">[</span><span style="color:#1f2328">offi</span><span style="color:#1f2328">]</span> <span style="color:#0550ae">!=</span> <span style="color:#1f2328">evacuatedY</span> <span style="color:#1f2328">{</span>
</span></span><span style="display:flex;"><span>				<span style="color:#57606a">//黄金数据，直接返回</span>
</span></span><span style="display:flex;"><span>				<span style="color:#cf222e">if</span> <span style="color:#1f2328">t</span><span style="color:#1f2328">.</span><span style="color:#1f2328">indirectkey</span> <span style="color:#1f2328">{</span>
</span></span><span style="display:flex;"><span>					<span style="color:#1f2328">k</span> <span style="color:#1f2328">=</span> <span style="color:#0550ae">*</span><span style="color:#1f2328">((</span><span style="color:#0550ae">*</span><span style="color:#1f2328">unsafe</span><span style="color:#1f2328">.</span><span style="color:#1f2328">Pointer</span><span style="color:#1f2328">)(</span><span style="color:#1f2328">k</span><span style="color:#1f2328">))</span>
</span></span><span style="display:flex;"><span>				<span style="color:#1f2328">}</span>
</span></span><span style="display:flex;"><span>				<span style="color:#1f2328">it</span><span style="color:#1f2328">.</span><span style="color:#1f2328">key</span> <span style="color:#1f2328">=</span> <span style="color:#1f2328">k</span>
</span></span><span style="display:flex;"><span>				<span style="color:#cf222e">if</span> <span style="color:#1f2328">t</span><span style="color:#1f2328">.</span><span style="color:#1f2328">indirectvalue</span> <span style="color:#1f2328">{</span>
</span></span><span style="display:flex;"><span>					<span style="color:#1f2328">v</span> <span style="color:#1f2328">=</span> <span style="color:#0550ae">*</span><span style="color:#1f2328">((</span><span style="color:#0550ae">*</span><span style="color:#1f2328">unsafe</span><span style="color:#1f2328">.</span><span style="color:#1f2328">Pointer</span><span style="color:#1f2328">)(</span><span style="color:#1f2328">v</span><span style="color:#1f2328">))</span>
</span></span><span style="display:flex;"><span>				<span style="color:#1f2328">}</span>
</span></span><span style="display:flex;"><span>				<span style="color:#1f2328">it</span><span style="color:#1f2328">.</span><span style="color:#1f2328">value</span> <span style="color:#1f2328">=</span> <span style="color:#1f2328">v</span>
</span></span><span style="display:flex;"><span>			<span style="color:#1f2328">}</span> <span style="color:#cf222e">else</span> <span style="color:#1f2328">{</span>
</span></span><span style="display:flex;"><span>				<span style="color:#57606a">//有特殊标记，则说明这个被搬迁了</span>
</span></span><span style="display:flex;"><span>				<span style="color:#57606a">//因为map只有读互斥，所以我们需要去找一下这个key</span>
</span></span><span style="display:flex;"><span>				<span style="color:#57606a">//看是不是还存在</span>
</span></span><span style="display:flex;"><span>				<span style="color:#1f2328">k2</span> <span style="color:#0550ae">:=</span> <span style="color:#1f2328">k</span>
</span></span><span style="display:flex;"><span>				<span style="color:#cf222e">if</span> <span style="color:#1f2328">t</span><span style="color:#1f2328">.</span><span style="color:#1f2328">indirectkey</span> <span style="color:#1f2328">{</span>
</span></span><span style="display:flex;"><span>					<span style="color:#1f2328">k2</span> <span style="color:#1f2328">=</span> <span style="color:#0550ae">*</span><span style="color:#1f2328">((</span><span style="color:#0550ae">*</span><span style="color:#1f2328">unsafe</span><span style="color:#1f2328">.</span><span style="color:#1f2328">Pointer</span><span style="color:#1f2328">)(</span><span style="color:#1f2328">k2</span><span style="color:#1f2328">))</span>
</span></span><span style="display:flex;"><span>				<span style="color:#1f2328">}</span>
</span></span><span style="display:flex;"><span>				<span style="color:#cf222e">if</span> <span style="color:#1f2328">t</span><span style="color:#1f2328">.</span><span style="color:#1f2328">reflexivekey</span> <span style="color:#0550ae">||</span> <span style="color:#1f2328">alg</span><span style="color:#1f2328">.</span><span style="color:#6639ba">equal</span><span style="color:#1f2328">(</span><span style="color:#1f2328">k2</span><span style="color:#1f2328">,</span> <span style="color:#1f2328">k2</span><span style="color:#1f2328">)</span> <span style="color:#1f2328">{</span>
</span></span><span style="display:flex;"><span>					<span style="color:#1f2328">rk</span><span style="color:#1f2328">,</span> <span style="color:#1f2328">rv</span> <span style="color:#0550ae">:=</span> <span style="color:#6639ba">mapaccessK</span><span style="color:#1f2328">(</span><span style="color:#1f2328">t</span><span style="color:#1f2328">,</span> <span style="color:#1f2328">h</span><span style="color:#1f2328">,</span> <span style="color:#1f2328">k2</span><span style="color:#1f2328">)</span>
</span></span><span style="display:flex;"><span>					<span style="color:#cf222e">if</span> <span style="color:#1f2328">rk</span> <span style="color:#0550ae">==</span> <span style="color:#cf222e">nil</span> <span style="color:#1f2328">{</span>
</span></span><span style="display:flex;"><span>						<span style="color:#cf222e">continue</span> <span style="color:#57606a">// key has been deleted</span>
</span></span><span style="display:flex;"><span>					<span style="color:#1f2328">}</span>
</span></span><span style="display:flex;"><span>					<span style="color:#1f2328">it</span><span style="color:#1f2328">.</span><span style="color:#1f2328">key</span> <span style="color:#1f2328">=</span> <span style="color:#1f2328">rk</span>
</span></span><span style="display:flex;"><span>					<span style="color:#1f2328">it</span><span style="color:#1f2328">.</span><span style="color:#1f2328">value</span> <span style="color:#1f2328">=</span> <span style="color:#1f2328">rv</span>
</span></span><span style="display:flex;"><span>				<span style="color:#1f2328">}</span> <span style="color:#cf222e">else</span> <span style="color:#1f2328">{</span>
</span></span><span style="display:flex;"><span>					<span style="color:#57606a">//特殊的NANs的键值，不可能找到的，因此直接返回</span>
</span></span><span style="display:flex;"><span>					<span style="color:#1f2328">it</span><span style="color:#1f2328">.</span><span style="color:#1f2328">key</span> <span style="color:#1f2328">=</span> <span style="color:#1f2328">k2</span>
</span></span><span style="display:flex;"><span>					<span style="color:#cf222e">if</span> <span style="color:#1f2328">t</span><span style="color:#1f2328">.</span><span style="color:#1f2328">indirectvalue</span> <span style="color:#1f2328">{</span>
</span></span><span style="display:flex;"><span>						<span style="color:#1f2328">v</span> <span style="color:#1f2328">=</span> <span style="color:#0550ae">*</span><span style="color:#1f2328">((</span><span style="color:#0550ae">*</span><span style="color:#1f2328">unsafe</span><span style="color:#1f2328">.</span><span style="color:#1f2328">Pointer</span><span style="color:#1f2328">)(</span><span style="color:#1f2328">v</span><span style="color:#1f2328">))</span>
</span></span><span style="display:flex;"><span>					<span style="color:#1f2328">}</span>
</span></span><span style="display:flex;"><span>					<span style="color:#1f2328">it</span><span style="color:#1f2328">.</span><span style="color:#1f2328">value</span> <span style="color:#1f2328">=</span> <span style="color:#1f2328">v</span>
</span></span><span style="display:flex;"><span>				<span style="color:#1f2328">}</span>
</span></span><span style="display:flex;"><span>			<span style="color:#1f2328">}</span>
</span></span><span style="display:flex;"><span>			<span style="color:#57606a">//找到一个数据了，相关字段写入迭代器，方便下一次迭代</span>
</span></span><span style="display:flex;"><span>			<span style="color:#1f2328">it</span><span style="color:#1f2328">.</span><span style="color:#1f2328">bucket</span> <span style="color:#1f2328">=</span> <span style="color:#1f2328">bucket</span>
</span></span><span style="display:flex;"><span>			<span style="color:#cf222e">if</span> <span style="color:#1f2328">it</span><span style="color:#1f2328">.</span><span style="color:#1f2328">bptr</span> <span style="color:#0550ae">!=</span> <span style="color:#1f2328">b</span> <span style="color:#1f2328">{</span> 
</span></span><span style="display:flex;"><span>				<span style="color:#1f2328">it</span><span style="color:#1f2328">.</span><span style="color:#1f2328">bptr</span> <span style="color:#1f2328">=</span> <span style="color:#1f2328">b</span>
</span></span><span style="display:flex;"><span>			<span style="color:#1f2328">}</span>
</span></span><span style="display:flex;"><span>			<span style="color:#1f2328">it</span><span style="color:#1f2328">.</span><span style="color:#1f2328">i</span> <span style="color:#1f2328">=</span> <span style="color:#1f2328">i</span> <span style="color:#0550ae">+</span> <span style="color:#0550ae">1</span>
</span></span><span style="display:flex;"><span>			<span style="color:#1f2328">it</span><span style="color:#1f2328">.</span><span style="color:#1f2328">checkBucket</span> <span style="color:#1f2328">=</span> <span style="color:#1f2328">checkBucket</span>
</span></span><span style="display:flex;"><span>			<span style="color:#cf222e">return</span>
</span></span><span style="display:flex;"><span>		<span style="color:#1f2328">}</span>
</span></span><span style="display:flex;"><span>	<span style="color:#1f2328">}</span>
</span></span><span style="display:flex;"><span>	<span style="color:#57606a">//这个桶没有数据，看看溢出桶</span>
</span></span><span style="display:flex;"><span>	<span style="color:#1f2328">b</span> <span style="color:#1f2328">=</span> <span style="color:#1f2328">b</span><span style="color:#1f2328">.</span><span style="color:#6639ba">overflow</span><span style="color:#1f2328">(</span><span style="color:#1f2328">t</span><span style="color:#1f2328">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#1f2328">i</span> <span style="color:#1f2328">=</span> <span style="color:#0550ae">0</span>
</span></span><span style="display:flex;"><span>	<span style="color:#cf222e">goto</span> <span style="color:#1f2328">next</span>
</span></span><span style="display:flex;"><span><span style="color:#1f2328">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h3 id="参考">参考</h3>
<ol>
<li><a href="https://juejin.im/post/5ce4dd5ae51d4558936a9fde?utm_source=gold_browser_extension">深度解密Go语言之map</a></li>
<li><a href="https://github.com/cch123/golang-notes/blob/master/map.md">map解析</a></li>
</ol>

        </div>

        


        


        <div class="post-meta meta-tags">
            
            没有标签
            
        </div>
    </article>
    
    

    
    
    <div class="post bg-white">
      <script src="https://utteranc.es/client.js"
            repo= "weiweng/blog"
            issue-term="pathname"
            theme="github-light"
            crossorigin="anonymous"
            async>
      </script>
    </div>
    
    
    

</div>

                    <footer id="footer">
    <div>
        &copy; 2025 <a href="https://weiweng.github.io/blog/">weiweng的博客 By </a>
        
    </div>
    <br />
    <div>
        <div class="github-badge">
            <a href="https://gohugo.io/" target="_black" rel="nofollow"><span class="badge-subject">Powered by</span><span class="badge-value bg-blue">Hugo</span></a>
        </div>
        <div class="github-badge">
            <a href="https://www.flysnow.org/" target="_black"><span class="badge-subject">Design by</span><span class="badge-value bg-brightgreen">飞雪无情</span></a>
        </div>
        <div class="github-badge">
            <a href="https://github.com/flysnow-org/maupassant-hugo" target="_black"><span class="badge-subject">Theme</span><span class="badge-value bg-yellowgreen">Maupassant</span></a>
        </div>
    </div>
</footer>


    
    
    <script type="text/javascript">
        window.MathJax = {
            tex2jax: {
                inlineMath: [['$', '$']],
                processEscapes: true
                }
            };
    </script>
    <script src='//cdn.bootcdn.net/ajax/libs/mathjax/2.7.5/MathJax.js?config=TeX-MML-AM_CHTML' async></script>

<a id="rocket" href="#top"></a>
<script type="text/javascript" src='/blog/js/totop.js?v=0.0.0' async=""></script>


<style type="text/css">
div.highlight {
    position: relative;
    margin: 1em 0px;
}

.copy-code {
    display: none;
    position: absolute;
    top: 4px;
    right: 4px;
    color: rgba(255, 255, 255, 0.8);
    background: rgba(78, 78, 78, 0.8);
    border-radius: var(--radius);
    padding: 0 5px;
    font: inherit;
    user-select: none;
    cursor: pointer;
    border: 0;
    --radius: 8px;
}

div.highlight:hover .copy-code,pre:hover .copy-code {
    display: block;
}

</style>
<script>
    document.querySelectorAll('pre > code').forEach((codeblock) => {
        const container = codeblock.parentNode.parentNode;

        const copybutton = document.createElement('button');
        copybutton.classList.add('copy-code');
        copybutton.innerHTML = 'copy';

        function copyingDone() {
            copybutton.innerHTML = 'copied!';
            setTimeout(() => {
                copybutton.innerHTML = 'copy';
            }, 2000);
        }

        copybutton.addEventListener('click', (cb) => {
            if ('clipboard' in navigator) {
                navigator.clipboard.writeText(codeblock.textContent);
                copyingDone();
                return;
            }

            const range = document.createRange();
            range.selectNodeContents(codeblock);
            const selection = window.getSelection();
            selection.removeAllRanges();
            selection.addRange(range);
            try {
                document.execCommand('copy');
                copyingDone();
            } catch (e) { };
            selection.removeRange(range);
        });

        if (container.classList.contains("highlight")) {
            container.appendChild(copybutton);
        } else if (container.parentNode.firstChild == container) {
            
        } else if (codeblock.parentNode.parentNode.parentNode.parentNode.parentNode.nodeName == "TABLE") {
            
            codeblock.parentNode.parentNode.parentNode.parentNode.parentNode.appendChild(copybutton);
        } else {
            
            codeblock.parentNode.appendChild(copybutton);
        }
    });
</script>






                </div>

                <div id="secondary">
    <section class="widget">
        <form id="search" action='https://weiweng.github.io/blog/search' method="get" accept-charset="utf-8" target="_blank" _lpchecked="1">
      
      <input type="text" name="q" maxlength="20" placeholder="Search">
      <input type="hidden" name="sitesearch" value="https://weiweng.github.io/blog/">
      <button type="submit" class="submit icon-search"></button>
</form>
    </section>

    <section class="widget">
        <h3 class="widget-title">最近文章</h3>
<ul class="widget-list">
    
    <li>
        <a href="https://weiweng.github.io/blog/post/2025-02-26-embedding/" title="大模型专题|embedding" target="_blank">大模型专题|embedding</a>
    </li>
    
    <li>
        <a href="https://weiweng.github.io/blog/post/2025-02-23-langchain/" title="大模型专题|LangChain rag实践" target="_blank">大模型专题|LangChain rag实践</a>
    </li>
    
    <li>
        <a href="https://weiweng.github.io/blog/post/2024-05-06-%E5%B9%B6%E6%9F%A5%E9%9B%86/" title="算法专题|并查集" target="_blank">算法专题|并查集</a>
    </li>
    
    <li>
        <a href="https://weiweng.github.io/blog/post/2024-03-15-golanggrroupcache/" title="Golang|groupcache" target="_blank">Golang|groupcache</a>
    </li>
    
    <li>
        <a href="https://weiweng.github.io/blog/post/2024-03-09-golangreflect/" title="Golang|学习教程(八)-反射" target="_blank">Golang|学习教程(八)-反射</a>
    </li>
    
    <li>
        <a href="https://weiweng.github.io/blog/post/2024-01-22-%E5%89%8D%E7%BC%80%E5%92%8C/" title="算法专题|前缀和" target="_blank">算法专题|前缀和</a>
    </li>
    
    <li>
        <a href="https://weiweng.github.io/blog/post/2024-01-20-pythonrequests/" title="python|requests" target="_blank">python|requests</a>
    </li>
    
    <li>
        <a href="https://weiweng.github.io/blog/post/2023-12-13-python%E5%AD%A6%E4%B9%A0%E8%B7%AF%E5%BE%84/" title="python|学习路径" target="_blank">python|学习路径</a>
    </li>
    
    <li>
        <a href="https://weiweng.github.io/blog/post/2023-09-08-%E5%9B%BE/" title="算法专题|图" target="_blank">算法专题|图</a>
    </li>
    
    <li>
        <a href="https://weiweng.github.io/blog/post/2023-06-26-%E8%B4%AA%E5%BF%83/" title="算法专题|贪心" target="_blank">算法专题|贪心</a>
    </li>
    
</ul>
    </section>

    

    <section class="widget">
        <h3 class="widget-title"><a href='/blog/categories/'>分类</a></h3>
<ul class="widget-list">
    
    <li><a href="https://weiweng.github.io/blog/categories/Golang/">Golang (28)</a></li>
    
    <li><a href="https://weiweng.github.io/blog/categories/k8s/">K8s (3)</a></li>
    
    <li><a href="https://weiweng.github.io/blog/categories/linux/">Linux (2)</a></li>
    
    <li><a href="https://weiweng.github.io/blog/categories/MQ/">MQ (3)</a></li>
    
    <li><a href="https://weiweng.github.io/blog/categories/mysql/">Mysql (21)</a></li>
    
    <li><a href="https://weiweng.github.io/blog/categories/Python/">Python (4)</a></li>
    
    <li><a href="https://weiweng.github.io/blog/categories/Redis/">Redis (9)</a></li>
    
    <li><a href="https://weiweng.github.io/blog/categories/%E5%A4%A7%E6%A8%A1%E5%9E%8B%E4%B8%93%E9%A2%98/">大模型专题 (2)</a></li>
    
    <li><a href="https://weiweng.github.io/blog/categories/%E5%BE%AE%E6%9C%8D%E5%8A%A1/">微服务 (3)</a></li>
    
    <li><a href="https://weiweng.github.io/blog/categories/%E6%93%8D%E4%BD%9C%E7%B3%BB%E7%BB%9F/">操作系统 (1)</a></li>
    
    <li><a href="https://weiweng.github.io/blog/categories/%E7%AE%97%E6%B3%95%E6%95%B0%E6%8D%AE%E7%BB%93%E6%9E%84/">算法&amp;数据结构 (36)</a></li>
    
    <li><a href="https://weiweng.github.io/blog/categories/%E7%AE%97%E6%B3%95%E4%B8%93%E9%A2%98/">算法专题 (10)</a></li>
    
    <li><a href="https://weiweng.github.io/blog/categories/%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%BD%91%E7%BB%9C/">计算机网络 (1)</a></li>
    
</ul>
    </section>

    <section class="widget">
        <h3 class="widget-title"><a href='/blog/tags/'>标签</a></h3>
<div class="tagcloud">
    
    <a href="https://weiweng.github.io/blog/tags/awk/">Awk</a>
    
    <a href="https://weiweng.github.io/blog/tags/curl/">Curl</a>
    
    <a href="https://weiweng.github.io/blog/tags/find/">Find</a>
    
    <a href="https://weiweng.github.io/blog/tags/git/">Git</a>
    
    <a href="https://weiweng.github.io/blog/tags/grep/">Grep</a>
    
    <a href="https://weiweng.github.io/blog/tags/item2/">Item2</a>
    
    <a href="https://weiweng.github.io/blog/tags/nginx/">Nginx</a>
    
    <a href="https://weiweng.github.io/blog/tags/sed/">Sed</a>
    
    <a href="https://weiweng.github.io/blog/tags/shell/">Shell</a>
    
    <a href="https://weiweng.github.io/blog/tags/tmux/">Tmux</a>
    
    <a href="https://weiweng.github.io/blog/tags/uml/">Uml</a>
    
    <a href="https://weiweng.github.io/blog/tags/vim/">Vim</a>
    
    <a href="https://weiweng.github.io/blog/tags/%E5%AD%A6%E4%B9%A0/">学习</a>
    
    <a href="https://weiweng.github.io/blog/tags/%E5%BC%80%E6%BA%90%E5%8D%8F%E8%AE%AE/">开源协议</a>
    
    <a href="https://weiweng.github.io/blog/tags/%E5%BF%83%E5%BE%97/">心得</a>
    
    <a href="https://weiweng.github.io/blog/tags/%E6%90%9C%E7%B4%A2%E5%BC%95%E6%93%8E%E6%8A%80%E5%B7%A7/">搜索引擎技巧</a>
    
</div>
    </section>

    
<section class="widget">
    <h3 class="widget-title">友情链接</h3>
    <ul class="widget-list">
        
        <li>
            <a target="_blank" href="https://www.flysnow.org/" title="飞雪无情的博客">飞雪无情的博客</a>
        </li>
        
        <li>
            <a target="_blank" href="https://draveness.me/" title="面向信仰编程">面向信仰编程</a>
        </li>
        
        <li>
            <a target="_blank" href="https://xargin.com/" title="No Headback">No Headback</a>
        </li>
        
        <li>
            <a target="_blank" href="https://eddycjy.com/" title="煎鱼的博客">煎鱼的博客</a>
        </li>
        
        <li>
            <a target="_blank" href="https://polarisxu.studygolang.com/" title="polarisxu的博客">polarisxu的博客</a>
        </li>
        
        <li>
            <a target="_blank" href="https://qcrao.com/" title="qcrao 的博客">qcrao 的博客</a>
        </li>
        
    </ul>
</section>


    <section class="widget">
        <h3 class="widget-title">其它</h3>
        <ul class="widget-list">
            <li><a href="https://weiweng.github.io/blog/index.xml">文章 RSS</a></li>
        </ul>
    </section>
</div>
            </div>
        </div>
    </div>
</body>

</html>